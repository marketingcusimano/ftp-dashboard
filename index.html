<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Executive Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      /* Brand Palette */
      --primary: #D2691E;       
      --primary-light: #fdf3eb; 
      --primary-dark: #8B4513;
      
      /* Neutral Palette */
      --bg-body: #f8f9fa;       
      --bg-card: #ffffff;
      --text-main: #1f2937;     
      --text-muted: #6b7280;    
      --border: #edf2f7;
      
      /* Effects */
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 16px;
    }

    * { box-sizing: border-box; outline: none; }
    
    body { 
      margin: 0; background: var(--bg-body); color: var(--text-main); 
      font-family: 'Inter', sans-serif; padding-bottom: 60px; 
      -webkit-font-smoothing: antialiased;
    }

    .animate-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

    .container { max-width: 1440px; margin: 0 auto; padding: 0 24px; }

    /* --- HEADER --- */
    header {
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      padding: 16px 0; margin-bottom: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .brand { display: flex; align-items: center; gap: 14px; }
    .logo { 
      width: 48px; height: 48px; 
      background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
      border-radius: 12px; color: #fff; 
      display: grid; place-items: center; font-weight: 800; font-size: 20px;
      box-shadow: 0 8px 20px rgba(210, 105, 30, 0.25);
    }
    .h-title { font-size: 20px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
    .h-sub { font-size: 13px; color: var(--text-muted); font-weight: 500; }

    /* --- CONTROLS --- */
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    select {
      background: var(--bg-card); border: 1px solid #e5e7eb;
      padding: 10px 14px; border-radius: 10px; font-size: 13px; font-weight: 500;
      color: var(--text-main); cursor: pointer; min-width: 180px;
      transition: all 0.2s; box-shadow: var(--shadow-card);
    }
    select:hover, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.1); }
    
    .btn {
      background: var(--bg-card); border: 1px solid #e5e7eb;
      padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
      cursor: pointer; display: inline-flex; gap: 8px; align-items: center;
      transition: all 0.2s; color: var(--text-main); box-shadow: var(--shadow-card);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-hover); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-primary:hover { background: var(--primary-dark); }

    /* --- CARDS --- */
    .card {
      background: var(--bg-card); border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-card); border: 1px solid rgba(0,0,0,0.01);
      transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .card-accent::before {
      content: ""; position: absolute; left: 0; top: 20px; bottom: 20px;
      width: 4px; background: var(--primary); border-radius: 0 4px 4px 0;
    }

    /* --- GRIDS --- */
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
    .grid-split { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
    .grid-split-rev { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1024px) { .grid-split, .grid-split-rev { grid-template-columns: 1fr; } }

    /* --- TYPOGRAPHY --- */
    .kpi-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-icon { 
      width: 36px; height: 36px; border-radius: 10px; 
      background: var(--primary-light); color: var(--primary); 
      display: grid; place-items: center; font-size: 18px;
    }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 30px; font-weight: 700; color: var(--text-main); letter-spacing: -1px; }
    .kpi-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

    .chart-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .chart-title { font-size: 16px; font-weight: 700; margin: 0; }
    .chart-ico { color: var(--primary); font-size: 18px; }

    /* --- TABLE --- */
    table.dataTable { width: 100% !important; border-collapse: separate; border-spacing: 0; }
    table.dataTable thead th { 
      background: #f9fafb; padding: 16px; font-size: 11px; 
      text-transform: uppercase; color: var(--text-muted); font-weight: 600; 
      border-bottom: 1px solid var(--border) !important; 
    }
    table.dataTable tbody td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 13px; vertical-align: middle; }
    table.dataTable tbody tr:hover { background-color: #fdf8f5 !important; transition: background 0.2s; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #edf2f7; color: #4a5568; border: 1px solid #e2e8f0; }
    .money { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--primary-dark); }

    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:600; color:var(--text-muted)">Analisi dati in corso...</p>
  </div>

  <header>
    <div class="container header-inner">
      <div class="brand">
        <div class="logo">CC</div>
        <div>
          <h1 class="h-title">Cotto Cusimano</h1>
          <div class="h-sub">Executive Dashboard</div>
        </div>
      </div>
      <div class="controls">
        <select id="selAgente"><option value="">Tutti gli Agenti</option></select>
        <select id="selProvincia"><option value="">Tutte le Province</option></select>
        <button class="btn" id="btnReset"><i class="ri-refresh-line"></i> Reset</button>
        <button class="btn btn-primary" id="btnExcel"><i class="ri-download-cloud-2-line"></i> Export Excel</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="grid-kpi animate-in" style="animation-delay: 0.1s">
      <div class="card card-accent">
        <div class="kpi-head">
          <span class="kpi-label">Fatturato Totale</span>
          <div class="kpi-icon"><i class="ri-wallet-3-line"></i></div>
        </div>
        <div class="kpi-val" id="kpiFatturato">€ 0</div>
        <div class="kpi-sub">Volume d'affari generato</div>
      </div>
      
      <div class="card card-accent">
        <div class="kpi-head">
          <span class="kpi-label">Base Clienti</span>
          <div class="kpi-icon"><i class="ri-store-2-line"></i></div>
        </div>
        <div class="kpi-val" id="kpiClienti">0</div>
        <div class="kpi-sub">Clienti attivi nel periodo</div>
      </div>

      <div class="card card-accent">
        <div class="kpi-head">
          <span class="kpi-label">Obiettivo Target</span>
          <div class="kpi-icon"><i class="ri-focus-2-line"></i></div>
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between">
            <div>
              <div class="kpi-val" id="kpiTargetVal">0%</div>
              <div class="kpi-sub">Percentuale Raggiunta</div>
            </div>
            <div id="miniRadial" style="margin-right:-10px"></div>
        </div>
      </div>
      
      <div class="card" style="background: linear-gradient(145deg, #2d3748, #1a202c); color: white; border:none">
        <div class="kpi-head">
          <span class="kpi-label" style="color:rgba(255,255,255,0.6)">Top Performer</span>
          <div class="kpi-icon" style="background:rgba(255,255,255,0.1); color:#fbbf24"><i class="ri-medal-fill"></i></div>
        </div>
        <div id="kpiTopAgent" style="font-size:22px; font-weight:700; margin-bottom:5px">--</div>
        <div id="kpiTopAgentVal" class="mono" style="color:#fbbf24; font-size:16px">€ 0</div>
      </div>
    </div>

    <div class="grid-split animate-in" style="animation-delay: 0.2s">
      <div class="card">
        <div class="chart-header">
          <i class="ri-bar-chart-box-fill chart-ico"></i>
          <h3 class="chart-title">Performance per Agente</h3>
        </div>
        <div id="chartBar"></div>
      </div>
      <div class="card">
        <div class="chart-header">
          <i class="ri-pie-chart-2-fill chart-ico"></i>
          <h3 class="chart-title">Distribuzione Geo</h3>
        </div>
        <div id="chartDonut" style="display:flex; justify-content:center"></div>
      </div>
    </div>

    <div class="grid-split-rev animate-in" style="animation-delay: 0.3s">
      <div class="card">
        <div class="chart-header">
          <i class="ri-dashboard-3-fill chart-ico"></i>
          <h3 class="chart-title">Peso Province (Polar)</h3>
        </div>
        <div id="chartPolar" style="display:flex; justify-content:center"></div>
      </div>
      <div class="card">
        <div class="chart-header">
          <i class="ri-vip-crown-2-fill chart-ico" style="color:#fbbf24"></i>
          <h3 class="chart-title">Top 5 Clienti Strategici</h3>
        </div>
        <div id="chartClients"></div>
      </div>
    </div>

    <div class="card animate-in" style="animation-delay: 0.4s">
      <div class="chart-header">
        <i class="ri-table-2 chart-ico"></i>
        <h3 class="chart-title">Registro Transazioni</h3>
      </div>
      <table id="tbl" class="display hover" style="width:100%"></table>
    </div>

    <div style="text-align:center; margin-top:40px; font-size:12px; color:var(--text-muted); opacity:0.7">
      CC Analytics System • Dati aggiornati al: <span id="lastUpdate">--</span>
    </div>

  </div>

  <script>
    // --- UTILS ---
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const asNum = v => (typeof v === 'number') ? v : Number((v||"0").toString().replace(/\./g, '').replace(',', '.') || 0);

    // --- PROVINCE MAPPING (Sigla -> Nome Esteso) ---
    const PROV_MAP = {
      'AG': 'Agrigento', 'AL': 'Alessandria', 'AN': 'Ancona', 'AO': 'Aosta', 'AR': 'Arezzo', 'AP': 'Ascoli Piceno', 'AT': 'Asti', 'AV': 'Avellino', 
      'BA': 'Bari', 'BT': 'Barletta-Andria-Trani', 'BL': 'Belluno', 'BN': 'Benevento', 'BG': 'Bergamo', 'BI': 'Biella', 'BO': 'Bologna', 'BZ': 'Bolzano', 
      'BS': 'Brescia', 'BR': 'Brindisi', 'CA': 'Cagliari', 'CL': 'Caltanissetta', 'CB': 'Campobasso', 'CI': 'Carbonia-Iglesias', 'CE': 'Caserta', 'CT': 'Catania', 
      'CZ': 'Catanzaro', 'CH': 'Chieti', 'CO': 'Como', 'CS': 'Cosenza', 'CR': 'Cremona', 'KR': 'Crotone', 'CN': 'Cuneo', 'EN': 'Enna', 'FM': 'Fermo', 
      'FE': 'Ferrara', 'FI': 'Firenze', 'FG': 'Foggia', 'FC': 'Forlì-Cesena', 'FR': 'Frosinone', 'GE': 'Genova', 'GO': 'Gorizia', 'GR': 'Grosseto', 
      'IM': 'Imperia', 'IS': 'Isernia', 'SP': 'La Spezia', 'AQ': 'L\'Aquila', 'LT': 'Latina', 'LE': 'Lecce', 'LC': 'Lecco', 'LI': 'Livorno', 'LO': 'Lodi', 
      'LU': 'Lucca', 'MC': 'Macerata', 'MN': 'Mantova', 'MS': 'Massa-Carrara', 'MT': 'Matera', 'VS': 'Medio Campidano', 'ME': 'Messina', 'MI': 'Milano', 
      'MO': 'Modena', 'MB': 'Monza e della Brianza', 'NA': 'Napoli', 'NO': 'Novara', 'NU': 'Nuoro', 'OG': 'Ogliastra', 'OT': 'Olbia-Tempio', 'OR': 'Oristano', 
      'PD': 'Padova', 'PA': 'Palermo', 'PR': 'Parma', 'PV': 'Pavia', 'PG': 'Perugia', 'PU': 'Pesaro e Urbino', 'PE': 'Pescara', 'PC': 'Piacenza', 'PI': 'Pisa', 
      'PT': 'Pistoia', 'PN': 'Pordenone', 'PZ': 'Potenza', 'PO': 'Prato', 'RG': 'Ragusa', 'RA': 'Ravenna', 'RC': 'Reggio Calabria', 'RE': 'Reggio Emilia', 
      'RI': 'Rieti', 'RN': 'Rimini', 'RM': 'Roma', 'RO': 'Rovigo', 'SA': 'Salerno', 'SS': 'Sassari', 'SV': 'Savona', 'SI': 'Siena', 'SR': 'Siracusa', 
      'SO': 'Sondrio', 'TA': 'Taranto', 'TE': 'Teramo', 'TR': 'Terni', 'TO': 'Torino', 'TP': 'Trapani', 'TN': 'Trento', 'TV': 'Treviso', 'TS': 'Trieste', 
      'UD': 'Udine', 'VA': 'Varese', 'VE': 'Venezia', 'VB': 'Verbano-Cusio-Ossola', 'VC': 'Vercelli', 'VR': 'Verona', 'VV': 'Vibo Valentia', 'VI': 'Vicenza', 
      'VT': 'Viterbo'
    };

    // --- STATE ---
    let state = { all: [], rows: [] };
    let charts = { bar: null, donut: null, radial: null, clients: null, polar: null };
    let dataTable = null;

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            if(!res.ok) throw new Error("Network err: " + res.status);
            const data = await res.json();

            // Pre-processing: Conversione sigle province in nomi estesi
            state.all = (data.rows || []).map(r => {
                if(r.Provincia) {
                    const cleanProv = r.Provincia.trim().toUpperCase();
                    r.Provincia = PROV_MAP[cleanProv] || r.Provincia; // Usa mappa o originale se non trovata
                }
                return r;
            });

            state.rows = [...state.all];
            
            if(data.updatedAt) document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString();
            
            document.getElementById('loading').style.opacity = 0;
            setTimeout(()=>document.getElementById('loading').remove(), 300);

            populateFilters();
            initCharts();
            updateDashboard();

        } catch (err) {
            document.getElementById('loading').innerHTML = `<h3 style="color:#ef4444">Errore Dati</h3><p>${err.message}</p>`;
        }

        document.getElementById('selAgente').addEventListener('change', applyFilters);
        document.getElementById('selProvincia').addEventListener('change', applyFilters);
        document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('selAgente').value = "";
            document.getElementById('selProvincia').value = "";
            applyFilters();
        });
        document.getElementById('btnExcel').addEventListener('click', exportExcel);
    });

    function populateFilters() {
        const agenti = [...new Set(state.all.map(r => (r.Agente_Nome || r.Agente_Codice || '').trim()))].filter(Boolean).sort();
        const province = [...new Set(state.all.map(r => (r.Provincia || '').trim()))].filter(Boolean).sort();
        
        const sA = document.getElementById('selAgente');
        const sP = document.getElementById('selProvincia');
        
        agenti.forEach(a => sA.add(new Option(a, a)));
        province.forEach(p => sP.add(new Option(p, p)));
    }

    function applyFilters() {
        const ag = document.getElementById('selAgente').value;
        const pr = document.getElementById('selProvincia').value;

        state.rows = state.all.filter(r => {
            const rAg = (r.Agente_Nome || r.Agente_Codice || '').trim();
            const rPr = (r.Provincia || '').trim();
            return (!ag || rAg === ag) && (!pr || rPr === pr);
        });
        updateDashboard();
    }

    function updateDashboard() {
        const data = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const objs = state.all.find(r => r.Tipo_Dato === 'OBIETTIVI');

        // 1. KPI
        const totFatt = data.reduce((a,b) => a + asNum(b.Fatturato), 0);
        const totCli = new Set(data.map(r => r.Ragione_Sociale_Cliente)).size;
        
        document.getElementById('kpiFatturato').textContent = fmtEUR.format(totFatt);
        document.getElementById('kpiClienti').textContent = totCli;
        
        const pct = objs ? objs.Percentuale_Obiettivo : 0;
        charts.radial.updateSeries([pct]);
        document.getElementById('kpiTargetVal').textContent = Number(pct).toFixed(1) + "%";

        const agMap = {};
        data.forEach(r => { const k = (r.Agente_Nome||'N/D'); agMap[k] = (agMap[k]||0) + asNum(r.Fatturato); });
        const top = Object.entries(agMap).sort((a,b)=>b[1]-a[1])[0];
        
        if(top) {
            document.getElementById('kpiTopAgent').textContent = top[0];
            document.getElementById('kpiTopAgentVal').textContent = fmtEUR.format(top[1]);
        } else {
            document.getElementById('kpiTopAgent').textContent = "—";
            document.getElementById('kpiTopAgentVal').textContent = "";
        }

        // 2. GRAFICI
        const agSorted = Object.entries(agMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        charts.bar.updateOptions({ xaxis: { categories: agSorted.map(x=>x[0]) } });
        charts.bar.updateSeries([{ data: agSorted.map(x=>x[1]) }]);

        const prMap = {};
        data.forEach(r => { const k = (r.Provincia||'?').trim(); prMap[k] = (prMap[k]||0) + asNum(r.Fatturato); });
        const prSorted = Object.entries(prMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        charts.donut.updateOptions({ labels: prSorted.map(x=>x[0]) });
        charts.donut.updateSeries(prSorted.map(x=>x[1]));

        const clMap = {};
        data.forEach(r => { const k = r.Ragione_Sociale_Cliente||'N/D'; clMap[k] = (clMap[k]||0) + asNum(r.Fatturato); });
        const clSorted = Object.entries(clMap).sort((a,b)=>b[1]-a[1]).slice(0,5); 
        charts.clients.updateOptions({ xaxis: { categories: clSorted.map(x=>x[0]) } });
        charts.clients.updateSeries([{ data: clSorted.map(x=>x[1]) }]);

        const prSortedPolar = Object.entries(prMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
        charts.polar.updateOptions({ labels: prSortedPolar.map(x=>x[0]) });
        charts.polar.updateSeries(prSortedPolar.map(x=>x[1]));

        // 3. TABELLA
        updateTable(data);
    }

    function initCharts() {
        const font = 'Inter, sans-serif';
        const colors = ['#D2691E', '#A0522D', '#CD853F', '#DEB887', '#F4A460'];

        // Bar Agenti
        charts.bar = new ApexCharts(document.querySelector("#chartBar"), {
            series: [{ name:'Fatturato', data:[] }],
            chart: { type:'bar', height:320, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'60%', distributed:true } },
            colors: colors, legend: { show:false },
            dataLabels: { enabled:false },
            xaxis: { labels: { formatter: v => "€ " + (v/1000).toFixed(0) + "k" } },
            tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.bar.render();

        // Donut
        charts.donut = new ApexCharts(document.querySelector("#chartDonut"), {
            series: [], labels: [],
            chart: { type:'donut', height:320, fontFamily:font },
            colors: ['#D2691E', '#374151', '#6b7280', '#9ca3af', '#d1d5db'],
            plotOptions: { pie: { donut: { size:'75%', labels:{show:true, total:{show:true, label:'Totale', color:'#6b7280', formatter: w => {
                const t = w.globals.seriesTotals.reduce((a,b)=>a+b,0);
                return "€ " + (t/1000).toFixed(0) + "k";
            }}}}}},
            legend: { position:'bottom' }, dataLabels: { enabled:false }
        });
        charts.donut.render();

        // Clients
        charts.clients = new ApexCharts(document.querySelector("#chartClients"), {
            series: [{ name:'Acquisti', data:[] }],
            chart: { type:'bar', height:300, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:4, barHeight:'40%' } },
            colors: ['#1f2937'], 
            dataLabels: { enabled:true, formatter: v => "€ " + (v/1000).toFixed(1) + "k", offsetX:10, style: { colors: ['#374151'] } },
            xaxis: { show:false }, grid: { show:false }, tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.clients.render();

        // Polar
        charts.polar = new ApexCharts(document.querySelector("#chartPolar"), {
            series: [], labels: [],
            chart: { type: 'polarArea', height: 320, fontFamily: font, toolbar:{show:false} },
            stroke: { colors: ['#fff'] }, fill: { opacity: 0.85 },
            colors: ['#8B4513', '#A0522D', '#D2691E', '#CD853F', '#F4A460', '#d1d5db', '#e5e7eb'],
            legend: { position: 'bottom' }, yaxis: { show: false },
            tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.polar.render();

        // Mini Radial KPI
        charts.radial = new ApexCharts(document.querySelector("#miniRadial"), {
            series: [0],
            chart: { type:'radialBar', height:100, width:100, sparkline:{enabled:true} },
            plotOptions: { radialBar: { hollow:{size:'60%'}, track:{background:'#f0f0f0'}, dataLabels:{show:false} } },
            colors: ['#D2691E'], stroke: { lineCap:'round' }
        });
        charts.radial.render();
    }

    function updateTable(data) {
        const body = data.map(r => [
            `<div style="font-weight:600">${r.Agente_Nome||'—'}</div>`,
            `<span class="badge">${r.Provincia||'?'}</span>`,
            r.Ragione_Sociale_Cliente,
            `<div class="money">${fmtEUR.format(asNum(r.Fatturato))}</div>`
        ]);
        
        if (dataTable) dataTable.destroy();
        dataTable = new DataTable('#tbl', {
            data: body,
            columns: [{title:"Agente"},{title:"Prov"},{title:"Cliente"},{title:"Fatturato", className:"dt-right"}],
            order: [[3,'desc']], pageLength: 10, lengthChange: false,
            language: { search:"Cerca:", paginate:{next:">", previous:"<"}, info:"_START_ - _END_ di _TOTAL_" }
        });
    }

    function exportExcel() {
        const data = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE').map(r => ({
            Agente: r.Agente_Nome, Prov: r.Provincia, Cliente: r.Ragione_Sociale_Cliente, Fatturato: asNum(r.Fatturato)
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dati");
        XLSX.writeFile(wb, "CottoCusimano_Export.xlsx");
    }
  </script>
</body>
</html>
