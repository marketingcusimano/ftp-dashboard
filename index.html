<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Analytics Hub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #D2691E; /* Terra Cotto */
      --primary-dark: #A0522D;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 40px; }

    /* Layout */
    .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
    
    /* Header */
    header {
      background: rgba(255,255,255,0.85); backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      padding: 16px 0; margin-bottom: 32px;
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { 
      width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
      border-radius: 12px; color: #fff; display: grid; place-items: center; font-weight: 700; font-size: 18px;
      box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
    }
    .h-title { font-size: 20px; font-weight: 700; margin: 0; }
    .h-sub { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    /* Controls */
    .controls { display: flex; gap: 12px; align-items: center; }
    .select-wrap { position: relative; min-width: 180px; }
    select {
      width: 100%; appearance: none; background: var(--bg-card); border: 1px solid var(--border);
      padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; color: var(--text-main);
      transition: all 0.2s; cursor: pointer;
    }
    select:hover { border-color: var(--text-muted); }
    .select-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted); }
    
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; color: var(--text-main);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(210, 105, 30, 0.2); }

    /* Grid Layouts */
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
    .grid-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1024px) { .grid-charts { grid-template-columns: 1fr; } }

    /* Cards */
    .card {
      background: var(--bg-card); border-radius: 20px; padding: 24px;
      box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.03);
      position: relative; overflow: hidden;
    }
    
    /* KPI Styling */
    .kpi-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .kpi-label { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-icon { width: 32px; height: 32px; border-radius: 8px; background: #fff5eb; color: var(--primary); display: grid; place-items: center; font-size: 18px; }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
    .kpi-trend { font-size: 13px; display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 20px; font-weight: 600; }
    .trend-up { background: #ecfdf5; color: var(--success); }
    .trend-down { background: #fef2f2; color: var(--danger); }
    
    /* Table Customization */
    table.dataTable { border-collapse: separate; border-spacing: 0; width: 100% !important; }
    table.dataTable thead th { 
      background: #f9fafb; padding: 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border) !important; 
    }
    table.dataTable tbody td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; vertical-align: middle; }
    table.dataTable tbody tr:hover { background-color: #f9fafb; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-blue { background: #eff6ff; color: #2563eb; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Loading Overlay */
    #loading { position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:16px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div style="font-weight:600; color:var(--text-muted)">Caricamento dati Cotto Cusimano...</div>
  </div>

  <header>
    <div class="container header-inner">
      <div class="brand">
        <div class="logo">CC</div>
        <div>
          <h1 class="h-title">Dashboard Vendite</h1>
          <div class="h-sub">Cotto Cusimano Analytics</div>
        </div>
      </div>

      <div class="controls">
        <div class="select-wrap">
          <i class="ri-user-search-line select-icon"></i>
          <select id="selAgente"><option value="">Tutti gli Agenti</option></select>
        </div>
        <div class="select-wrap">
          <i class="ri-map-pin-line select-icon"></i>
          <select id="selProvincia"><option value="">Tutte le Province</option></select>
        </div>
        <button class="btn" id="btnReset"><i class="ri-restart-line"></i> Reset</button>
        <div style="width:1px; height:24px; background:var(--border); margin:0 8px;"></div>
        <button class="btn btn-primary" id="btnExcel"><i class="ri-file-excel-2-line"></i> Export</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="grid-kpi">
      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Fatturato Totale</span>
          <div class="kpi-icon"><i class="ri-money-euro-circle-line"></i></div>
        </div>
        <div class="kpi-val" id="kpiFatturato">€ 0,00</div>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
            <span id="kpiTrendWrap" class="kpi-trend trend-up">--</span>
            <div id="spark1" style="max-width:100px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Clienti Attivi</span>
          <div class="kpi-icon"><i class="ri-building-4-line"></i></div>
        </div>
        <div class="kpi-val" id="kpiClienti">0</div>
        <div class="h-sub" style="margin-top:8px">Base clienti in gestione</div>
      </div>

      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Obiettivo Raggiunto</span>
          <div class="kpi-icon"><i class="ri-target-line"></i></div>
        </div>
        <div style="display:flex; align-items:center; gap:16px;">
            <div id="chartRadial" style="flex:1;"></div>
            <div style="text-align:right">
                <div class="h-sub">Target Anno</div>
                <div class="mono" style="font-weight:700" id="kpiTargetVal">0%</div>
            </div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #2c3e50, #000); color: white;">
        <div class="kpi-head">
          <span class="kpi-label" style="color:rgba(255,255,255,0.6)">Top Performer</span>
          <div class="kpi-icon" style="background:rgba(255,255,255,0.1); color:#fff"><i class="ri-trophy-line"></i></div>
        </div>
        <div class="kpi-val" id="kpiTopAgent" style="font-size:22px; color:white">—</div>
        <div class="h-sub" style="color:rgba(255,255,255,0.6)" id="kpiTopAgentVal">€ 0,00</div>
      </div>
    </div>

    <div class="grid-charts">
      <div class="card">
        <div class="chart-header">
          <div class="chart-title">Performance Agenti</div>
        </div>
        <div id="chartBar"></div>
      </div>
      <div class="card">
        <div class="chart-header">
          <div class="chart-title">Distribuzione Geografica</div>
        </div>
        <div id="chartDonut" style="display:flex; justify-content:center;"></div>
      </div>
    </div>

    <div class="card">
      <div class="chart-header">
        <div class="chart-title">Dettaglio Transazioni</div>
      </div>
      <table id="tbl" class="display hover" style="width:100%">
        </table>
    </div>
    
    <div style="text-align:center; margin-top:32px; color:var(--text-muted); font-size:12px;">
        Ultimo aggiornamento dati: <span id="lastUpdate">--</span>
    </div>

  </div>

  <script>
    // --- CONFIGURAZIONE FORMATTAZIONE ---
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const asNum = v => (typeof v === 'string') ? Number(v.replace(/\./g, '').replace(',', '.') || 0) : Number(v || 0);
    
    // --- STATO GLOBALE ---
    let state = { all: [], rows: [] };
    let charts = { bar: null, donut: null, radial: null, spark: null };
    let dataTable = null;

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
        
        // *** PARTE IMPORTANTE: CARICAMENTO REALE DATI ***
        try {
            // Se il tuo file o endpoint è diverso, cambia '/data' qui sotto
            const response = await fetch('/data', { cache: "no-store" }); 
            
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
            
            const data = await response.json();
            
            // Processo dati
            state.all = data.rows || [];
            state.rows = [...state.all];
            
            if(data.updatedAt) {
               document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString();
            }

            // Nascondo schermata caricamento
            document.getElementById('loading').style.display = 'none';

            // Avvio Dashboard
            populateFilters();
            initCharts();
            updateDashboard();

        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerHTML = `
                <div style="color:#ef4444; font-size:48px"><i class="ri-error-warning-line"></i></div>
                <h3>Errore Caricamento</h3>
                <p>${err.message}</p>
                <p style="font-size:12px; color:#666">Controlla la console per i dettagli.</p>
            `;
        }

        // Event Listeners UI
        document.getElementById('selAgente').addEventListener('change', applyFilters);
        document.getElementById('selProvincia').addEventListener('change', applyFilters);
        document.getElementById('btnReset').addEventListener('click', resetFilters);
        document.getElementById('btnExcel').addEventListener('click', exportExcel);
    });

    function populateFilters() {
        const agenti = [...new Set(state.all.map(r => r.Agente_Nome || r.Agente_Codice))].filter(Boolean).sort();
        const province = [...new Set(state.all.map(r => r.Provincia))].filter(Boolean).sort();
        
        const sA = document.getElementById('selAgente');
        const sP = document.getElementById('selProvincia');
        
        agenti.forEach(a => sA.add(new Option(a, a)));
        province.forEach(p => sP.add(new Option(p, p)));
    }

    function applyFilters() {
        const ag = document.getElementById('selAgente').value;
        const pr = document.getElementById('selProvincia').value;

        state.rows = state.all.filter(r => {
            const matchA = !ag || (r.Agente_Nome === ag || r.Agente_Codice === ag);
            const matchP = !pr || (r.Provincia === pr);
            return matchA && matchP;
        });
        updateDashboard();
    }

    function resetFilters() {
        document.getElementById('selAgente').value = "";
        document.getElementById('selProvincia').value = "";
        state.rows = [...state.all];
        updateDashboard();
    }

    function updateDashboard() {
        const rows = state.rows;
        
        // 1. Calcolo KPI Dinamici
        const vendite = rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const totFatturato = vendite.reduce((sum, r) => sum + asNum(r.Fatturato), 0);
        const totClienti = new Set(vendite.map(r => r.Ragione_Sociale_Cliente)).size;

        document.getElementById('kpiFatturato').textContent = fmtEUR.format(totFatturato);
        document.getElementById('kpiClienti').textContent = totClienti;

        // Trend e Obiettivi (cerchiamo i dati nel JSON 'OBIETTIVI' o 'TOTALE')
        const objRow = state.all.find(r => r.Tipo_Dato === 'OBIETTIVI');
        const prevYear = asNum(objRow?.Anno_Precedente || 0);
        const currYear = asNum(objRow?.Anno_Corrente || 0);
        
        // Calcolo Delta (Se filtrato, facciamo un delta calcolato sul set attuale, altrimenti usiamo i totali generali)
        let delta = 0;
        if(state.rows.length === state.all.length && prevYear > 0) {
             // Totale generale
            delta = ((currYear - prevYear) / prevYear) * 100;
        } else {
            // Qui potresti implementare una logica di confronto più complessa per filtri
            // Per ora lasciamo il delta generale per coerenza o 0
            delta = 0; 
        }
        
        const elTrend = document.getElementById('kpiTrendWrap');
        if(delta !== 0) {
            const isPos = delta >= 0;
            elTrend.className = isPos ? 'kpi-trend trend-up' : 'kpi-trend trend-down';
            elTrend.innerHTML = `<i class="${isPos ? 'ri-arrow-right-up-line' : 'ri-arrow-right-down-line'}"></i> ${isPos ? '+' : ''}${delta.toFixed(1)}%`;
        } else {
            elTrend.className = 'kpi-trend';
            elTrend.innerHTML = '<span style="color:#999">--</span>';
        }

        // Top Performer
        const byAgent = {};
        vendite.forEach(r => {
            const name = r.Agente_Nome || r.Agente_Codice || 'N/D';
            byAgent[name] = (byAgent[name] || 0) + asNum(r.Fatturato);
        });
        const topAgent = Object.entries(byAgent).sort((a,b) => b[1] - a[1])[0];
        if(topAgent) {
            document.getElementById('kpiTopAgent').textContent = topAgent[0];
            document.getElementById('kpiTopAgentVal').textContent = fmtEUR.format(topAgent[1]);
        } else {
            document.getElementById('kpiTopAgent').textContent = "—";
            document.getElementById('kpiTopAgentVal').textContent = "";
        }

        // Target Radial Update
        const targetPct = objRow ? objRow.Percentuale_Obiettivo : 0;
        charts.radial.updateSeries([targetPct]);
        document.getElementById('kpiTargetVal').textContent = Number(targetPct).toFixed(1) + "%";

        // 2. Aggiorna Grafici
        const sortedAgents = Object.entries(byAgent).sort((a,b) => b[1] - a[1]).slice(0, 10); 
        charts.bar.updateOptions({
            xaxis: { categories: sortedAgents.map(x => x[0]) }
        });
        charts.bar.updateSeries([{ data: sortedAgents.map(x => x[1]) }]);

        const byProv = {};
        vendite.forEach(r => { const p = r.Provincia || '?'; byProv[p] = (byProv[p] || 0) + asNum(r.Fatturato); });
        const sortedProv = Object.entries(byProv).sort((a,b) => b[1] - a[1]).slice(0, 6); 
        
        charts.donut.updateOptions({ labels: sortedProv.map(x => x[0]) });
        charts.donut.updateSeries(sortedProv.map(x => x[1]));

        // 3. Aggiorna Tabella
        updateTable(vendite);
    }

    function initCharts() {
        // --- BAR CHART (Agenti) ---
        const optBar = {
            series: [{ name: 'Fatturato', data: [] }],
            chart: { type: 'bar', height: 350, fontFamily: 'Inter, sans-serif', toolbar: { show: false } },
            plotOptions: { bar: { borderRadius: 4, horizontal: true, barHeight: '60%', distributed: true } },
            colors: ['#D2691E', '#CD853F', '#DEB887', '#F4A460', '#A0522D'], 
            dataLabels: { enabled: false },
            xaxis: { 
                labels: { formatter: (val) => "€ " + (val/1000).toFixed(0) + "k" } 
            },
            tooltip: { y: { formatter: (val) => fmtEUR.format(val) } },
            legend: { show: false }
        };
        charts.bar = new ApexCharts(document.querySelector("#chartBar"), optBar);
        charts.bar.render();

        // --- DONUT CHART (Province) ---
        const optDonut = {
            series: [],
            labels: [],
            chart: { type: 'donut', height: 320, fontFamily: 'Inter, sans-serif' },
            colors: ['#D2691E', '#2c3e50', '#e67e22', '#95a5a6', '#34495e'],
            plotOptions: { pie: { donut: { size: '75%', labels: { show: true, total: { show: true, label: 'Totale', formatter: (w) => {
                const t = w.globals.seriesTotals.reduce((a,b)=>a+b,0);
                return "€ " + (t/1000).toFixed(0) + "k";
            }}}}}},
            legend: { position: 'bottom' },
            dataLabels: { enabled: false }
        };
        charts.donut = new ApexCharts(document.querySelector("#chartDonut"), optDonut);
        charts.donut.render();

        // --- RADIAL (KPI Target) ---
        const optRadial = {
            series: [0],
            chart: { type: 'radialBar', height: 140, width: 100, sparkline: { enabled: true } },
            plotOptions: { radialBar: { hollow: { size: '60%' }, track: { background: '#f3f4f6' }, dataLabels: { show: false } } },
            colors: ['#10b981'],
            stroke: { lineCap: 'round' }
        };
        charts.radial = new ApexCharts(document.querySelector("#chartRadial"), optRadial);
        charts.radial.render();
        
        // --- SPARKLINE (Trend Decorativo) ---
        const optSpark = {
            series: [{ data: [10, 25, 18, 35, 28, 45, 40, 55] }],
            chart: { type: 'area', height: 40, width: 100, sparkline: { enabled: true } },
            stroke: { curve: 'smooth', width: 2 },
            fill: { opacity: 0.2 },
            colors: ['#D2691E']
        };
        charts.spark = new ApexCharts(document.querySelector("#spark1"), optSpark);
        charts.spark.render();
    }

    function updateTable(data) {
        const tableData = data.map(r => [
            `<div style="font-weight:600">${r.Agente_Nome || '—'}</div><div style="font-size:11px;color:#9ca3af">${r.Agente_Codice||''}</div>`,
            `<span class="badge badge-blue">${r.Provincia || '?'}</span>`,
            r.Ragione_Sociale_Cliente,
            `<div class="mono" style="text-align:right; font-weight:600; color:var(--primary)">${fmtEUR.format(asNum(r.Fatturato))}</div>`
        ]);

        if (dataTable) {
            dataTable.destroy();
        }

        dataTable = new DataTable('#tbl', {
            data: tableData,
            columns: [
                { title: "Agente" },
                { title: "Provincia" },
                { title: "Cliente" },
                { title: "Fatturato", className: "dt-right" }
            ],
            order: [[3, 'desc']],
            pageLength: 8,
            lengthChange: false,
            language: { search: "Cerca:", paginate: { next: ">", previous: "<" }, info: "Record _START_ - _END_ di _TOTAL_" }
        });
    }

    function exportExcel() {
        const dataExport = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE').map(r => ({
            Agente: r.Agente_Nome,
            Codice: r.Agente_Codice,
            Provincia: r.Provincia,
            Cliente: r.Ragione_Sociale_Cliente,
            Fatturato: asNum(r.Fatturato)
        }));
        const ws = XLSX.utils.json_to_sheet(dataExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Export_Vendite");
        XLSX.writeFile(wb, "CottoCusimano_Report.xlsx");
    }
  </script>
</body>
</html>
