<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard B2B • Agenti</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Font + stile leggero -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Font principali -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: light dark; }
    :root {
      color-scheme: dark;
      --bg: #030712;
      --bg-card: rgba(10, 17, 34, 0.78);
      --bg-card-strong: rgba(12, 20, 41, 0.92);
      --border: rgba(148, 163, 184, 0.1);
      --border-strong: rgba(99, 102, 241, 0.45);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #60a5fa;
      --accent-strong: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --success: #34d399;
      --danger: #f87171;
      --shadow: 0 18px 60px rgba(15, 23, 42, 0.45);
      --radius-lg: 20px;
      --radius-sm: 12px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1320; color: #e5e7eb; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .muted { color: #94a3b8; font-size: 12px; }
    .grid { display: grid; gap: 16px; }
    .g3 { grid-template-columns: repeat(3, 1fr); }
    .g2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 900px){ .g3, .g2 { grid-template-columns: 1fr; } }
    .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 16px; padding: 16px; }
    .kpi { font-size: 28px; font-weight: 700; margin-top: 6px; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: 'Inter', 'Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(56, 189, 248, 0.18), transparent 45%),
                  radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.15), transparent 50%),
                  linear-gradient(160deg, #020617, #0b1224 55%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .background-glow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }

    .background-glow::before,
    .background-glow::after {
      content: '';
      position: absolute;
      width: 520px;
      height: 520px;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.45;
    }

    .background-glow::before {
      background: rgba(37, 99, 235, 0.45);
      top: -160px;
      right: -120px;
    }

    .background-glow::after {
      background: rgba(16, 185, 129, 0.35);
      bottom: -220px;
      left: -120px;
    }

    .wrap {
      position: relative;
      z-index: 1;
      max-width: 1240px;
      margin: 0 auto;
      padding: 32px 24px 64px;
    }

    header.hero {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 28px;
    }

    .hero-title {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 3vw, 34px);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .muted { color: var(--text-muted); font-size: 13px; line-height: 1.5; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.14);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hero-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button.btn,
    .select {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.55);
      color: var(--text);
      cursor: pointer;
      transition: all 0.25s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(12px);
    }

    button.btn:hover,
    .select:hover,
    .select:focus-visible {
      background: rgba(59, 130, 246, 0.16);
      border-color: rgba(96, 165, 250, 0.6);
    }

    button.btn.primary {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(56, 189, 248, 0.85));
      border-color: rgba(37, 99, 235, 0.45);
      color: white;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.35);
    }

    button.btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.45);
    }

    .select {
      appearance: none;
      background-image: url('data:image/svg+xml,%3Csvg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M4 6l4 4 4-4" stroke="%2394a3b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .grid { display: grid; gap: 18px; }
    .grid.g3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid.g2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    @media (max-width: 1024px) {
      .grid.g3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 880px) {
      header.hero { align-items: flex-start; }
      .grid.g3, .grid.g2 { grid-template-columns: 1fr; }
      .hero-actions { width: 100%; justify-content: flex-start; }
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(16px);
    }

    .card.elevated {
      background: var(--bg-card-strong);
      border: 1px solid rgba(96, 165, 250, 0.18);
    }

    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(56, 189, 248, 0));
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .card:hover::after { opacity: 1; }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .kpi { font-size: clamp(26px, 2.6vw, 34px); font-weight: 700; margin: 6px 0 0; }
    .kpi-sub { font-size: 13px; color: var(--text-muted); margin-top: 6px; }

    .trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(52, 211, 153, 0.12);
      color: var(--success);
    }

    .trend.negative { background: rgba(248, 113, 113, 0.12); color: var(--danger); }

    .insights {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }

    .insights li {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.12);
      font-size: 13px;
      line-height: 1.5;
    }

    .insights li::before {
      content: '';
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(56, 189, 248, 0.8));
      flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.14);
    }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #1e293b; text-align: left; }
    th { color: #cbd5e1; font-weight: 600; }
    .right { text-align: right; }
    th, td { padding: 12px 10px; text-align: left; }
    thead th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
    tbody tr { transition: background 0.18s ease; }
    tbody tr:nth-child(even) { background: rgba(148, 163, 184, 0.04); }
    tbody tr:hover { background: rgba(37, 99, 235, 0.14); }
    td { border-bottom: 1px solid rgba(148, 163, 184, 0.12); }
    td.right { text-align: right; font-variant-numeric: tabular-nums; }

    canvas { width: 100%; height: 340px; }
    .spacer { height: 8px; }

    footer {
      margin-top: 40px;
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
    }

    .spacer { height: 10px; }
  </style>
</head>
<body>
  <div class="background-glow"></div>
  <div class="wrap">
    <h1>Dashboard B2B • Agenti</h1>
    <div class="muted">Origine dati: <code>/data</code>. Aggiornamento: <span id="kpiUpdated">—</span></div>
    <header class="hero">
      <div class="hero-title">
        <span class="badge">Dashboard commerciale</span>
        <h1>Dashboard B2B • Agenti</h1>
        <p class="muted">Monitoraggio integrato della performance commerciale degli agenti. Dati aggiornati e aggregati in tempo reale dall'origine <code>/data</code>.</p>
      </div>
      <div class="hero-actions">
        <label class="muted" style="display:flex; flex-direction:column; gap:6px;">
          <span style="font-size:12px; text-transform:uppercase; letter-spacing:0.08em;">Filtro provincia</span>
          <select id="filterProvincia" class="select">
            <option value="ALL">Tutte le province</option>
          </select>
        </label>
        <button id="btnRefresh" class="btn" type="button">Aggiorna dati</button>
        <button id="btnExport" class="btn primary" type="button">Scarica CSV</button>
      </div>
    </header>

    <!-- KPI -->
    <div class="grid g3" style="margin-top:16px;">
      <div class="card">
        <div class="muted">Fatturato Totale</div>
    <div class="grid g3" style="margin-bottom: 20px;">
      <div class="card elevated">
        <div class="card-header">
          <span class="card-title">Fatturato totale</span>
          <span class="trend" id="badgeUpdated">Aggiornamento</span>
        </div>
        <div class="kpi" id="kpiFatturato">—</div>
        <div class="kpi-sub">Valore consolidato per anno in corso</div>
      </div>
      <div class="card">
        <div class="muted">Clienti Totali</div>
      <div class="card elevated">
        <div class="card-header">
          <span class="card-title">Clienti attivi</span>
        </div>
        <div class="kpi" id="kpiClienti">—</div>
        <div class="kpi-sub">Totale anagrafiche servite dagli agenti</div>
      </div>
      <div class="card">
        <div class="muted">Note</div>
        <div id="kpiMeta" class="kpi" style="font-size:16px; font-weight:600">Caricamento…</div>
      <div class="card elevated">
        <div class="card-header">
          <span class="card-title">Ticket medio</span>
        </div>
        <div class="kpi" id="kpiTicketMedio">—</div>
        <div class="kpi-sub">Fatturato medio per cliente</div>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- Charts -->
    <div class="grid g2">
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">Clienti serviti per provincia</div>
        <div class="card-header">
          <span class="card-title">Clienti serviti per provincia</span>
          <span class="muted" id="badgeProvince">—</span>
        </div>
        <canvas id="chartClientiProvincia"></canvas>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">Ripartizione fatturato</div>
        <div class="card-header">
          <span class="card-title">Ripartizione fatturato</span>
          <span class="muted" id="badgeCategorie">—</span>
        </div>
        <canvas id="chartRipartizione"></canvas>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- Obiettivi -->
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">% Obiettivo per provincia</div>
      <canvas id="chartObiettivi"></canvas>
    <div class="grid g2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">% Obiettivo per provincia</span>
          <span class="muted">Target minimo 100%</span>
        </div>
        <canvas id="chartObiettivi"></canvas>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Insights operativi</span>
          <span class="muted" id="datasetInfo">—</span>
        </div>
        <ul class="insights">
          <li id="insightTopProvincia">Identificazione provincia più attiva…</li>
          <li id="insightTopProdotto">Prodotto con quota maggiore…</li>
          <li id="insightClienti">Segmentazione clienti…</li>
        </ul>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- Tabella -->
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Top 25 clienti per fatturato</div>
      <div class="card-header">
        <span class="card-title">Top clienti per fatturato</span>
        <span class="muted" id="tableMeta">—</span>
      </div>
      <table>
        <thead>
          <tr><th>Provincia</th><th>Ragione Sociale</th><th class="right">Fatturato</th></tr>
        </thead>
        <tbody id="tblVendite"><tr><td colspan="3" class="muted">Caricamento…</td></tr></tbody>
      </table>
    </div>

    <footer>Ultimo aggiornamento: <span id="kpiUpdated">—</span></footer>
  </div>

  <script>
    // --- formatter ---
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const fmtINT = new Intl.NumberFormat('it-IT');
    const fmtPerc = new Intl.NumberFormat('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 1 });

    // util: filtra per tipo
    const groupRows = (rows, tipo) => rows.filter(r => r.Tipo_Dato === tipo);
    const fallbackRows = [
      { Tipo_Dato: 'TOTALE', Descrizione: 'Fatturato_Totale', Valore: 1520000 },
      { Tipo_Dato: 'TOTALE', Descrizione: 'Clienti_Totale', Valore: 128 },
      { Tipo_Dato: 'CLIENTI_PROVINCIA', Provincia: 'MI', Clienti_Serviti: 38, Fatturato: 520000 },
      { Tipo_Dato: 'CLIENTI_PROVINCIA', Provincia: 'RM', Clienti_Serviti: 32, Fatturato: 410000 },
      { Tipo_Dato: 'CLIENTI_PROVINCIA', Provincia: 'TO', Clienti_Serviti: 21, Fatturato: 210000 },
      { Tipo_Dato: 'RIPARTIZIONE', Categoria_Prodotto: 'Hardware', Importo: 620000, Percentuale: 41 },
      { Tipo_Dato: 'RIPARTIZIONE', Categoria_Prodotto: 'Software', Importo: 540000, Percentuale: 35 },
      { Tipo_Dato: 'RIPARTIZIONE', Categoria_Prodotto: 'Servizi', Importo: 360000, Percentuale: 24 },
      { Tipo_Dato: 'OBIETTIVI', Provincia: 'MI', Percentuale_Obiettivo: 92 },
      { Tipo_Dato: 'OBIETTIVI', Provincia: 'RM', Percentuale_Obiettivo: 105 },
      { Tipo_Dato: 'OBIETTIVI', Provincia: 'TO', Percentuale_Obiettivo: 88 },
      { Tipo_Dato: 'VENDITE_CLIENTE', Provincia: 'MI', Ragione_Sociale_Cliente: 'Techno S.p.A.', Fatturato: 180000 },
      { Tipo_Dato: 'VENDITE_CLIENTE', Provincia: 'MI', Ragione_Sociale_Cliente: 'Delta Solutions', Fatturato: 152000 },
      { Tipo_Dato: 'VENDITE_CLIENTE', Provincia: 'RM', Ragione_Sociale_Cliente: 'Omega Consulting', Fatturato: 146000 },
      { Tipo_Dato: 'VENDITE_CLIENTE', Provincia: 'RM', Ragione_Sociale_Cliente: 'Lazio Digital', Fatturato: 134000 },
      { Tipo_Dato: 'VENDITE_CLIENTE', Provincia: 'TO', Ragione_Sociale_Cliente: 'Piemonte Retail', Fatturato: 99000 },
    ];

    const state = {
      rows: [],
      charts: {},
      provinceFilter: 'ALL',
    };

    const elements = {
      filterProvincia: document.getElementById('filterProvincia'),
      btnRefresh: document.getElementById('btnRefresh'),
      btnExport: document.getElementById('btnExport'),
      kpiFatturato: document.getElementById('kpiFatturato'),
      kpiClienti: document.getElementById('kpiClienti'),
      kpiTicketMedio: document.getElementById('kpiTicketMedio'),
      kpiUpdated: document.getElementById('kpiUpdated'),
      badgeUpdated: document.getElementById('badgeUpdated'),
      badgeProvince: document.getElementById('badgeProvince'),
      badgeCategorie: document.getElementById('badgeCategorie'),
      datasetInfo: document.getElementById('datasetInfo'),
      tableMeta: document.getElementById('tableMeta'),
      tblVendite: document.getElementById('tblVendite'),
      insightTopProvincia: document.getElementById('insightTopProvincia'),
      insightTopProdotto: document.getElementById('insightTopProdotto'),
      insightClienti: document.getElementById('insightClienti'),
    };

    function setLoading(isLoading) {
      if (!elements.btnRefresh) return;
      elements.btnRefresh.disabled = isLoading;
      elements.btnRefresh.textContent = isLoading ? 'Aggiornamento…' : 'Aggiorna dati';
      elements.btnRefresh.style.opacity = isLoading ? '0.7' : '1';
    }

    async function loadData() {
      const res = await fetch('/data', { cache: 'no-store' });
      if (!res.ok) throw new Error('Fetch /data failed');
      const data = await res.json();
      const rows = data.rows || [];
      const info = `${data.rowCount} righe • delim: ${JSON.stringify(data.delimiter)}`;
      document.getElementById('kpiMeta').textContent = info;
      document.getElementById('kpiUpdated').textContent = new Date(data.updatedAt).toLocaleString('it-IT');

      // === KPI FINALI ===
      const totali = groupRows(rows, 'TOTALE');
      setLoading(true);
      try {
        const res = await fetch('/data', { cache: 'no-store' });
        if (!res.ok) throw new Error('Impossibile recuperare /data');

        const data = await res.json();
        state.rows = Array.isArray(data.rows) ? data.rows : [];
        renderDashboard(data);
      } catch (err) {
        console.error(err);
        if (!state.rows.length && fallbackRows.length) {
          state.rows = fallbackRows;
          renderDashboard({
            rowCount: fallbackRows.length,
            delimiter: ';',
            updatedAt: null,
            note: `Dataset dimostrativo (offline). Errore sorgente: ${err.message}`,
            source: 'demo'
          });
          return;
        }
        if (elements.datasetInfo) {
          elements.datasetInfo.textContent = 'Errore caricamento dati: ' + err.message;
        }
      } finally {
        setLoading(false);
      }
    }

    function renderDashboard(meta = {}) {
      const rows = state.rows;

      const infoParts = [];
      if (typeof meta.rowCount === 'number') {
        infoParts.push(`${fmtINT.format(meta.rowCount)} righe elaborate`);
      } else {
        infoParts.push('Dataset non disponibile');
      }
      if (meta.delimiter) {
        infoParts.push(`delimitatore ${JSON.stringify(meta.delimiter)}`);
      }
      if (meta.note) {
        infoParts.push(meta.note);
      }
      if (meta.source === 'ftp') {
        infoParts.push('Origine: FTP aziendale');
      } else if (meta.source === 'demo') {
        infoParts.push('Origine: dataset demo offline');
      }
      elements.datasetInfo.textContent = infoParts.join(' • ');

      if (meta.updatedAt) {
        const lastUpdate = new Date(meta.updatedAt);
        const formatted = lastUpdate.toLocaleString('it-IT');
        elements.kpiUpdated.textContent = formatted;
        elements.badgeUpdated.textContent = `Agg. ${formatted}`;
      } else {
        elements.kpiUpdated.textContent = 'N/D';
        elements.badgeUpdated.textContent = 'Agg. n/d';
      }

      const totali = rows.filter(r => r.Tipo_Dato === 'TOTALE');
      const fatt = totali.find(r => r.Descrizione === 'Fatturato_Totale');
      const cli  = totali.find(r => r.Descrizione === 'Clienti_Totale');
      document.getElementById('kpiFatturato').textContent = fatt ? fmtEUR.format(fatt.Valore || 0) : '—';
      document.getElementById('kpiClienti').textContent   = cli  ? fmtINT.format(cli.Valore || 0)   : '—';

      // === TABELLA: VENDITE PER CLIENTE ===
      const vendite = groupRows(rows, 'VENDITE_CLIENTE')
        .sort((a, b) => (b.Fatturato || 0) - (a.Fatturato || 0))
        .slice(0, 25);

      const tbody = document.getElementById('tblVendite');
      tbody.innerHTML = '';
      vendite.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.Provincia ?? ''}</td>
          <td>${r.Ragione_Sociale_Cliente ?? ''}</td>
          <td class="right">${r.Fatturato != null ? fmtEUR.format(r.Fatturato) : ''}</td>`;
        tbody.appendChild(tr);
      });
      const cli = totali.find(r => r.Descrizione === 'Clienti_Totale');
      const fattValue = Number(fatt?.Valore || 0);
      const cliValue = Number(cli?.Valore || 0);

      elements.kpiFatturato.textContent = fatt ? fmtEUR.format(fattValue) : '—';
      elements.kpiClienti.textContent = cli ? fmtINT.format(cliValue) : '—';
      elements.kpiTicketMedio.textContent = fattValue && cliValue ? fmtEUR.format(fattValue / (cliValue || 1)) : '—';

      populateProvinceFilter(rows);
      renderCharts(rows);
      renderInsights(rows);
      renderTable(rows);
    }

    function populateProvinceFilter(rows) {
      if (!elements.filterProvincia) return;
      const vendite = rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
      const uniqueProv = Array.from(new Set(vendite.map(r => r.Provincia).filter(Boolean))).sort();

      const currentValue = elements.filterProvincia.value;
      elements.filterProvincia.innerHTML = '<option value="ALL">Tutte le province</option>' +
        uniqueProv.map(p => `<option value="${p}">${p}</option>`).join('');

      // === CHART: CLIENTI SERVITI PER PROVINCIA ===
      const perProv = groupRows(rows, 'CLIENTI_PROVINCIA');
      if (uniqueProv.includes(currentValue)) {
        elements.filterProvincia.value = currentValue;
      } else {
        elements.filterProvincia.value = 'ALL';
        state.provinceFilter = 'ALL';
      }

      elements.badgeProvince.textContent = uniqueProv.length ? `${uniqueProv.length} province monitorate` : 'Nessuna provincia disponibile';
    }

    function upsertChart(id, configBuilder) {
      const canvas = document.getElementById(id);
      if (!canvas || !window.Chart) return;
      const ctx = canvas.getContext('2d');
      if (state.charts[id]) {
        state.charts[id].destroy();
      }
      const config = configBuilder(ctx);
      state.charts[id] = new Chart(ctx, config);
    }

    function renderCharts(rows) {
      Chart.defaults.color = '#cbd5f5';
      Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
      Chart.defaults.plugins.legend.labels.usePointStyle = true;
      Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.92)';
      Chart.defaults.plugins.tooltip.titleColor = '#f8fafc';
      Chart.defaults.plugins.tooltip.bodyColor = '#f8fafc';
      Chart.defaults.plugins.tooltip.borderColor = 'rgba(148, 163, 184, 0.25)';
      Chart.defaults.plugins.tooltip.borderWidth = 1;

      const perProv = rows.filter(r => r.Tipo_Dato === 'CLIENTI_PROVINCIA');
      const lblProv = perProv.map(r => r.Provincia ?? '—');
      const valProv = perProv.map(r => Number(r.Clienti_Serviti || 0));
      if (window.Chart && document.getElementById('chartClientiProvincia')) {
        new Chart(document.getElementById('chartClientiProvincia'), {
      elements.badgeProvince.textContent = perProv.length ? `${perProv.length} province monitorate` : 'Nessun dato province';

      upsertChart('chartClientiProvincia', ctx => {
        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        gradient.addColorStop(0, 'rgba(96, 165, 250, 0.8)');
        gradient.addColorStop(1, 'rgba(56, 189, 248, 0.25)');
        return {
          type: 'bar',
          data: { labels: lblProv, datasets: [{ label: 'Clienti serviti', data: valProv }] },
          data: {
            labels: lblProv,
            datasets: [{
              label: 'Clienti serviti',
              data: valProv,
              backgroundColor: gradient,
              borderRadius: 12,
              maxBarThickness: 46,
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxRotation: 0 }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(148, 163, 184, 0.12)' },
                ticks: { precision: 0 }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
        };
      });

      // === CHART: RIPARTIZIONE FATTURATO ===
      const rip = groupRows(rows, 'RIPARTIZIONE')
      const rip = rows
        .filter(r => r.Tipo_Dato === 'RIPARTIZIONE')
        .filter(r => String(r.Categoria_Prodotto || '').toLowerCase() !== 'totale');
      const lblRip = rip.map(r => r.Categoria_Prodotto ?? '—');
      const valRip = rip.map(r => Number(r.Importo || 0));
      if (window.Chart && document.getElementById('chartRipartizione')) {
        new Chart(document.getElementById('chartRipartizione'), {
          type: 'doughnut',
          data: { labels: lblRip, datasets: [{ data: valRip }] },
          options: { responsive: true }
      elements.badgeCategorie.textContent = rip.length ? `${rip.length} categorie prodotto` : 'Nessuna categoria disponibile';

      upsertChart('chartRipartizione', () => {
        const palette = lblRip.map((_, idx) => {
          const base = [96, 165, 250, 56, 189, 248, 129, 140, 248];
          const hueShift = (idx * 32) % 360;
          const saturation = 75;
          const lightness = 55;
          return `hsl(${hueShift}, ${saturation}%, ${lightness}%)`;
        });
      }
        return {
          type: 'doughnut',
          data: {
            labels: lblRip,
            datasets: [{
              data: valRip,
              backgroundColor: palette,
              borderWidth: 2,
              borderColor: '#0f172a',
              hoverOffset: 8,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%'
          }
        };
      });

      // === CHART: % OBIETTIVO PER PROVINCIA (esclude "Generale") ===
      const ob = groupRows(rows, 'OBIETTIVI').filter(r => r.Provincia && r.Provincia !== 'Generale');
      const ob = rows
        .filter(r => r.Tipo_Dato === 'OBIETTIVI')
        .filter(r => r.Provincia && r.Provincia !== 'Generale');
      const lblOb = ob.map(r => r.Provincia);
      const valOb = ob.map(r => Number(r.Percentuale_Obiettivo ?? 0)); // 0..100
      if (window.Chart && document.getElementById('chartObiettivi')) {
        new Chart(document.getElementById('chartObiettivi'), {
      const valOb = ob.map(r => Number(r.Percentuale_Obiettivo ?? 0));

      upsertChart('chartObiettivi', ctx => {
        const gradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, 0);
        gradient.addColorStop(0, 'rgba(34, 211, 238, 0.8)');
        gradient.addColorStop(1, 'rgba(79, 70, 229, 0.8)');
        return {
          type: 'bar',
          data: { labels: lblOb, datasets: [{ label: '% Obiettivo', data: valOb }] },
          data: {
            labels: lblOb,
            datasets: [{
              label: '% Obiettivo',
              data: valOb,
              backgroundColor: gradient,
              borderRadius: 10,
              maxBarThickness: 44,
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { display: false }
              },
              y: {
                min: 0,
                max: 120,
                grid: { color: 'rgba(148, 163, 184, 0.12)' },
                ticks: {
                  callback: value => value + '%'
                }
              }
            },
            plugins: {
              legend: { display: false },
              annotation: false
            }
          }
        });
        };
      });
    }

    function renderInsights(rows) {
      const perProv = rows.filter(r => r.Tipo_Dato === 'CLIENTI_PROVINCIA');
      const rip = rows
        .filter(r => r.Tipo_Dato === 'RIPARTIZIONE')
        .filter(r => String(r.Categoria_Prodotto || '').toLowerCase() !== 'totale');
      const vendite = rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');

      if (perProv.length) {
        const topProv = perProv.reduce((acc, cur) => Number(cur.Clienti_Serviti || 0) > Number(acc.Clienti_Serviti || 0) ? cur : acc, perProv[0]);
        elements.insightTopProvincia.textContent = `La provincia di ${topProv.Provincia ?? '—'} concentra ${fmtINT.format(Number(topProv.Clienti_Serviti || 0))} clienti serviti.`;
      } else {
        elements.insightTopProvincia.textContent = 'Nessun dato disponibile per le province.';
      }

      if (rip.length) {
        const topProd = rip.reduce((acc, cur) => Number(cur.Importo || 0) > Number(acc.Importo || 0) ? cur : acc, rip[0]);
        const quota = rip.length ? (Number(topProd.Importo || 0) / rip.reduce((sum, r) => sum + Number(r.Importo || 0), 0)) : 0;
        elements.insightTopProdotto.textContent = `${topProd.Categoria_Prodotto ?? '—'} guida il fatturato con una quota del ${fmtPerc.format(quota * 100)}%.`;
      } else {
        elements.insightTopProdotto.textContent = 'Nessuna ripartizione disponibile per i prodotti.';
      }

      const clientiPerProvincia = vendite.reduce((map, row) => {
        const provincia = row.Provincia || 'Non assegnata';
        if (!map.has(provincia)) map.set(provincia, new Set());
        map.get(provincia).add(row.Ragione_Sociale_Cliente || row.ID_Cliente || 'Cliente');
        return map;
      }, new Map());

      if (clientiPerProvincia.size) {
        const province = Array.from(clientiPerProvincia.entries()).sort((a, b) => b[1].size - a[1].size);
        const top = province.slice(0, 2).map(([prov, clienti]) => `${prov}: ${clienti.size} clienti`);
        elements.insightClienti.textContent = `Distribuzione clienti bilanciata • ${top.join(' • ')}`;
      } else {
        elements.insightClienti.textContent = 'Nessun cliente disponibile per la segmentazione.';
      }
    }

    loadData().catch(err => {
      console.error(err);
      const el = document.getElementById('kpiMeta');
      if (el) el.textContent = 'Errore: ' + err.message;
    function renderTable(rows) {
      const vendite = rows
        .filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE')
        .filter(r => state.provinceFilter === 'ALL' ? true : r.Provincia === state.provinceFilter)
        .sort((a, b) => (Number(b.Fatturato) || 0) - (Number(a.Fatturato) || 0));

      const slice = vendite.slice(0, 25);
      elements.tableMeta.textContent = vendite.length ? `${vendite.length} clienti trovati • top ${slice.length}` : 'Nessun cliente disponibile';

      elements.tblVendite.innerHTML = '';

      if (!slice.length) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" class="muted">Nessun risultato per il filtro selezionato.</td>`;
        elements.tblVendite.appendChild(row);
        return;
      }

      slice.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.Provincia ?? '—'}</td>
          <td>${r.Ragione_Sociale_Cliente ?? '—'}</td>
          <td class="right">${r.Fatturato != null ? fmtEUR.format(Number(r.Fatturato)) : '—'}</td>`;
        elements.tblVendite.appendChild(tr);
      });
    }

    elements.filterProvincia?.addEventListener('change', event => {
      state.provinceFilter = event.target.value;
      renderTable(state.rows);
    });

    elements.btnRefresh?.addEventListener('click', () => loadData());

    elements.btnExport?.addEventListener('click', () => {
      if (!state.rows.length) return;
      const rows = state.rows;
      const header = Object.keys(rows[0]);
      const csv = [header.join(';')].concat(rows.map(row => header.map(key => {
        const value = row[key] ?? '';
        const escaped = String(value).replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(';'))).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `dataset_agenti_${Date.now()}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    loadData();
  </script>
</body>
</html>
