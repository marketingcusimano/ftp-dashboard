<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Executive Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #c2410c; --primary-grad: linear-gradient(135deg, #c2410c 0%, #ea580c 100%);
      --bg-body: #fffaf5; --text-main: #0f172a; --text-muted: #64748b;
    }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 80px; }
    .container { max-width: 1500px; margin: 0 auto; padding: 0 32px; }

    /* Header & Controls */
    header { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 16px 0; margin-bottom: 32px; }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .logo { width: 48px; height: 48px; background: var(--primary-grad); border-radius: 12px; color: #fff; display: grid; place-items: center; font-weight: 800; font-size: 20px; }
    
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    select, .btn { background: #fff; border: 1px solid #cbd5e1; padding: 10px; border-radius: 10px; font-weight: 600; font-size: 13px; min-width: 150px; cursor: pointer; }
    .btn { min-width: auto; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { background: #f8fafc; }

    /* Cards & Layout */
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .card { background: #fff; border-radius: 20px; padding: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; height: 100%; }
    
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; margin-bottom: 4px; color: var(--text-main); }
    .kpi-sub { font-size: 13px; color: var(--text-muted); }
    
    .trend-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; }
    .trend-up { background: #dcfce7; color: #15803d; } 
    .trend-down { background: #fee2e2; color: #b91c1c; }

    .grid-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1100px) { .grid-charts { grid-template-columns: 1fr; } }

    .card-dark { background: #1e293b; color: #fff; }
    .card-dark .kpi-label { color: #94a3b8; }
    .card-dark .kpi-val { color: #fff; }

    /* Loading */
    #loading { position: fixed; inset: 0; background: #fffaf5; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

  <div id="loading">
    <h2 style="color:#c2410c">Caricamento Dati...</h2>
  </div>

  <header>
    <div class="container header-inner">
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="logo">CC</div>
        <div><div style="font-weight:800; font-size:18px;">Cotto Cusimano</div><div style="font-size:12px; opacity:0.6">Dashboard</div></div>
      </div>
      <div class="controls">
        <select id="selAgente"><option value="">Tutti gli Agenti</option></select>
        <select id="selProvincia"><option value="">Tutte le Province</option></select>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnExcel" style="color:#c2410c; border-color:#c2410c">Excel</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="grid-kpi">
      <div class="card">
        <div class="kpi-label">Fatturato Totale</div>
        <div class="kpi-val" id="kpiFatturato">€ 0</div>
        <div class="kpi-sub" id="kpiTrend">--</div>
      </div>
      
      <div class="card">
        <div class="kpi-label">Clienti Attivi</div>
        <div class="kpi-val" id="kpiClienti">0</div>
        <div class="kpi-sub">Aziende in portafoglio</div>
      </div>

      <div class="card">
        <div class="kpi-label">Obiettivo Raggiunto</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end">
            <div>
                <div class="kpi-val" id="kpiTarget">0%</div>
                <div class="kpi-sub">Target Annuale</div>
            </div>
            <div id="miniRadial" style="margin:-15px -10px -10px 0"></div>
        </div>
      </div>

      <div class="card card-dark">
        <div class="kpi-label">Top Performer</div>
        <div class="kpi-val" id="kpiTopAgent" style="font-size:20px">--</div>
        <div id="kpiTopValue" style="color:#fbbf24; font-weight:700; font-family:'JetBrains Mono'; font-size:22px">€ 0</div>
      </div>
    </div>

    <div class="grid-charts">
      <div class="card"><h3>Classifica Agenti</h3><div id="chartBar"></div></div>
      <div class="card"><h3>Distribuzione Province</h3><div id="chartDonut"></div></div>
    </div>

    <div class="card">
      <h3>Dettaglio Vendite</h3>
      <table id="tbl" class="display hover" style="width:100%"></table>
    </div>

    <div style="text-align:center; margin-top:30px; font-size:12px; color:#64748b">
      Dati aggiornati al: <span id="lastUpdate">--</span>
    </div>

  </div>

  <script>
    // --- HELPERS ROBUSTI ---
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const asNum = v => {
        if (typeof v === 'number') return v;
        if (!v) return 0;
        // Converte "1.234,50" -> 1234.50
        let s = v.toString();
        if(s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.'); 
        else if(s.includes(',')) s = s.replace(',', '.');
        return parseFloat(s) || 0;
    };
    const GEO_DATA = {'AG':{n:'Agrigento',r:'Sicilia'},'AL':{n:'Alessandria',r:'Piemonte'},'AN':{n:'Ancona',r:'Marche'},'AO':{n:'Aosta',r:'Valle d\'Aosta'},'AR':{n:'Arezzo',r:'Toscana'},'AP':{n:'Ascoli Piceno',r:'Marche'},'AT':{n:'Asti',r:'Piemonte'},'AV':{n:'Avellino',r:'Campania'},'BA':{n:'Bari',r:'Puglia'},'BT':{n:'Barletta-Andria-Trani',r:'Puglia'},'BL':{n:'Belluno',r:'Veneto'},'BN':{n:'Benevento',r:'Campania'},'BG':{n:'Bergamo',r:'Lombardia'},'BI':{n:'Biella',r:'Piemonte'},'BO':{n:'Bologna',r:'Emilia-Romagna'},'BZ':{n:'Bolzano',r:'Trentino-Alto Adige'},'BS':{n:'Brescia',r:'Lombardia'},'BR':{n:'Brindisi',r:'Puglia'},'CA':{n:'Cagliari',r:'Sardegna'},'CL':{n:'Caltanissetta',r:'Sicilia'},'CB':{n:'Campobasso',r:'Molise'},'CI':{n:'Carbonia-Iglesias',r:'Sardegna'},'CE':{n:'Caserta',r:'Campania'},'CT':{n:'Catania',r:'Sicilia'},'CZ':{n:'Catanzaro',r:'Calabria'},'CH':{n:'Chieti',r:'Abruzzo'},'CO':{n:'Como',r:'Lombardia'},'CS':{n:'Cosenza',r:'Calabria'},'CR':{n:'Cremona',r:'Lombardia'},'KR':{n:'Crotone',r:'Calabria'},'CN':{n:'Cuneo',r:'Piemonte'},'EN':{n:'Enna',r:'Sicilia'},'FM':{n:'Fermo',r:'Marche'},'FE':{n:'Ferrara',r:'Emilia-Romagna'},'FI':{n:'Firenze',r:'Toscana'},'FG':{n:'Foggia',r:'Puglia'},'FC':{n:'Forlì-Cesena',r:'Emilia-Romagna'},'FR':{n:'Frosinone',r:'Lazio'},'GE':{n:'Genova',r:'Liguria'},'GO':{n:'Gorizia',r:'Friuli-Venezia Giulia'},'GR':{n:'Grosseto',r:'Toscana'},'IM':{n:'Imperia',r:'Liguria'},'IS':{n:'Isernia',r:'Molise'},'SP':{n:'La Spezia',r:'Liguria'},'AQ':{n:'L\'Aquila',r:'Abruzzo'},'LT':{n:'Latina',r:'Lazio'},'LE':{n:'Lecce',r:'Puglia'},'LC':{n:'Lecco',r:'Lombardia'},'LI':{n:'Livorno',r:'Toscana'},'LO':{n:'Lodi',r:'Lombardia'},'LU':{n:'Lucca',r:'Toscana'},'MC':{n:'Macerata',r:'Marche'},'MN':{n:'Mantova',r:'Lombardia'},'MS':{n:'Massa-Carrara',r:'Toscana'},'MT':{n:'Matera',r:'Basilicata'},'VS':{n:'Medio Campidano',r:'Sardegna'},'ME':{n:'Messina',r:'Sicilia'},'MI':{n:'Milano',r:'Lombardia'},'MO':{n:'Modena',r:'Emilia-Romagna'},'MB':{n:'Monza e Brianza',r:'Lombardia'},'NA':{n:'Napoli',r:'Campania'},'NO':{n:'Novara',r:'Piemonte'},'NU':{n:'Nuoro',r:'Sardegna'},'OG':{n:'Ogliastra',r:'Sardegna'},'OT':{n:'Olbia-Tempio',r:'Sardegna'},'OR':{n:'Oristano',r:'Sardegna'},'PD':{n:'Padova',r:'Veneto'},'PA':{n:'Palermo',r:'Sicilia'},'PR':{n:'Parma',r:'Emilia-Romagna'},'PV':{n:'Pavia',r:'Lombardia'},'PG':{n:'Perugia',r:'Umbria'},'PU':{n:'Pesaro e Urbino',r:'Marche'},'PE':{n:'Pescara',r:'Abruzzo'},'PC':{n:'Piacenza',r:'Emilia-Romagna'},'PI':{n:'Pisa',r:'Toscana'},'PT':{n:'Pistoia',r:'Toscana'},'PN':{n:'Pordenone',r:'Friuli-Venezia Giulia'},'PZ':{n:'Potenza',r:'Basilicata'},'PO':{n:'Prato',r:'Toscana'},'RG':{n:'Ragusa',r:'Sicilia'},'RA':{n:'Ravenna',r:'Emilia-Romagna'},'RC':{n:'Reggio Calabria',r:'Calabria'},'RE':{n:'Reggio Emilia',r:'Emilia-Romagna'},'RI':{n:'Rieti',r:'Lazio'},'RN':{n:'Rimini',r:'Emilia-Romagna'},'RM':{n:'Roma',r:'Lazio'},'RO':{n:'Rovigo',r:'Veneto'},'SA':{n:'Salerno',r:'Campania'},'SS':{n:'Sassari',r:'Sardegna'},'SV':{n:'Savona',r:'Liguria'},'SI':{n:'Siena',r:'Toscana'},'SR':{n:'Siracusa',r:'Sicilia'},'SO':{n:'Sondrio',r:'Lombardia'},'TA':{n:'Taranto',r:'Puglia'},'TE':{n:'Teramo',r:'Abruzzo'},'TR':{n:'Terni',r:'Umbria'},'TO':{n:'Torino',r:'Piemonte'},'TP':{n:'Trapani',r:'Sicilia'},'TN':{n:'Trento',r:'Trentino-Alto Adige'},'TV':{n:'Treviso',r:'Veneto'},'TS':{n:'Trieste',r:'Friuli-Venezia Giulia'},'UD':{n:'Udine',r:'Friuli-Venezia Giulia'},'VA':{n:'Varese',r:'Lombardia'},'VE':{n:'Venezia',r:'Veneto'},'VB':{n:'Verbano-Cusio-Ossola',r:'Piemonte'},'VC':{n:'Vercelli',r:'Piemonte'},'VR':{n:'Verona',r:'Veneto'},'VV':{n:'Vibo Valentia',r:'Calabria'},'VI':{n:'Vicenza',r:'Veneto'},'VT':{n:'Viterbo',r:'Lazio'}};

    // STATO DATI
    let rawData = { sales: [], targets: [], totals: [] }; // Dati grezzi divisi per tipo
    let currentData = []; // Dati vendite filtrati attuali
    let charts = { bar:null, donut:null, radial:null };
    let dataTable = null;

    // INIT
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch('/data', {cache: "no-store"});
            if(!res.ok) throw new Error("Errore Server");
            const json = await res.json();

            if(json.updatedAt) document.getElementById('lastUpdate').textContent = new Date(json.updatedAt).toLocaleString();

            // 1. SMISTAMENTO DATI (Fondamentale per non sballare i conti)
            const allRows = json.rows || [];
            
            rawData.sales = allRows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE').map(r => {
                // Arricchisci con Regione
                const code = (r.Provincia||'').trim().toUpperCase();
                r.Regione = GEO_DATA[code] ? GEO_DATA[code].r : 'Altro';
                r.ProvinciaExt = GEO_DATA[code] ? GEO_DATA[code].n : code;
                return r;
            });

            rawData.targets = allRows.filter(r => r.Tipo_Dato === 'OBIETTIVI');
            rawData.totals = allRows.filter(r => r.Tipo_Dato === 'TOTALE');

            // Init UI
            populateFilters();
            applyFilters(); // Primo calcolo
            
            document.getElementById('loading').style.display = 'none';

        } catch(e) {
            document.querySelector('#loading h2').textContent = "ERRORE DATI";
            document.querySelector('#loading').innerHTML += `<p>${e.message}</p>`;
        }
    });

    // FILTRI
    function populateFilters() {
        const getOpt = (arr, key) => [...new Set(arr.map(r => r[key]))].filter(Boolean).sort();
        const fill = (id, opts) => {
            const el = document.getElementById(id);
            opts.forEach(o => el.innerHTML += `<option value="${o}">${o}</option>`);
        };
        
        fill('selAgente', getOpt(rawData.sales, 'Agente_Nome'));
        fill('selProvincia', getOpt(rawData.sales, 'Provincia'));
    }

    function applyFilters() {
        const ag = document.getElementById('selAgente').value;
        const pr = document.getElementById('selProvincia').value;

        // Filtra SOLO le righe di vendita
        currentData = rawData.sales.filter(r => {
            const matchAg = !ag || r.Agente_Nome === ag;
            const matchPr = !pr || r.Provincia === pr;
            return matchAg && matchPr;
        });

        // Se ci sono filtri attivi, passiamo true a updateDashboard
        const isFiltered = (ag !== '' || pr !== '');
        updateDashboard(isFiltered);
    }

    // LOGICA DASHBOARD
    function updateDashboard(isFiltered) {
        
        // --- 1. CALCOLO FATTURATO ---
        let fatturato = 0;
        if (!isFiltered) {
            // Se NON FILTRATO: Leggiamo la riga TOTALE dal DB (Più affidabile)
            const row = rawData.totals.find(r => r.Descrizione === 'Fatturato_Totale');
            fatturato = row ? asNum(row.Valore) : 0;
        } else {
            // Se FILTRATO: Sommiamo le righe filtrate
            fatturato = currentData.reduce((sum, r) => sum + asNum(r.Fatturato), 0);
        }
        document.getElementById('kpiFatturato').textContent = fmtEUR.format(fatturato);

        // --- 2. CALCOLO TREND (Solo se non filtrato) ---
        let trendHtml = '<span style="font-size:12px; opacity:0.5">--</span>';
        if (!isFiltered) {
            const rowObj = rawData.targets.find(r => r.Provincia === 'Generale');
            if (rowObj) {
                const prev = asNum(rowObj.Anno_Precedente);
                const curr = asNum(rowObj.Anno_Corrente); // Usiamo Anno Corrente dal target per coerenza
                
                if (prev > 0) {
                    const diff = ((curr - prev) / prev) * 100;
                    const isPos = diff >= 0;
                    const cls = isPos ? 'trend-up' : 'trend-down';
                    const ico = isPos ? 'ri-arrow-right-up-line' : 'ri-arrow-right-down-line';
                    trendHtml = `<div class="trend-badge ${cls}"><i class="${ico}"></i> ${Math.abs(diff).toFixed(1)}%</div> <span style="font-size:12px; opacity:0.7">vs ${fmtEUR.format(prev)}</span>`;
                }
            }
        } else {
            trendHtml = '<span style="font-size:12px; opacity:0.7">Dato Filtrato</span>';
        }
        document.getElementById('kpiTrend').innerHTML = trendHtml;

        // --- 3. CLIENTI ---
        const uniqueClients = new Set(currentData.map(r => r.Ragione_Sociale_Cliente)).size;
        document.getElementById('kpiClienti').textContent = uniqueClients;

        // --- 4. TARGET ---
        let pct = 0;
        if (!isFiltered) {
            const rowObj = rawData.targets.find(r => r.Provincia === 'Generale');
            if(rowObj) pct = rowObj.Percentuale_Obiettivo;
        }
        document.getElementById('kpiTarget').textContent = Number(pct).toFixed(1) + "%";
        renderRadial(pct);

        // --- 5. TOP AGENT (Sui dati filtrati) ---
        const agMap = {};
        currentData.forEach(r => {
            const name = r.Agente_Nome || 'N/D';
            agMap[name] = (agMap[name]||0) + asNum(r.Fatturato);
        });
        const topEntry = Object.entries(agMap).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('kpiTopAgent').textContent = topEntry ? topEntry[0] : '—';
        document.getElementById('kpiTopValue').textContent = topEntry ? fmtEUR.format(topEntry[1]) : '€ 0';

        // --- 6. GRAFICI & TABELLA ---
        renderCharts(agMap);
        renderTable();
    }

    // RENDERERS
    function renderRadial(val) {
        if(charts.radial) charts.radial.destroy();
        charts.radial = new ApexCharts(document.querySelector("#miniRadial"), {
            series: [val],
            chart: { type:'radialBar', height:140, width:140, sparkline:{enabled:true} },
            colors: ['#c2410c'],
            plotOptions: { radialBar: { hollow: { size: '55%' }, track: { background: '#ffedd5' }, dataLabels: { show: false } } }
        });
        charts.radial.render();
    }

    function renderCharts(agMap) {
        const font = "'Plus Jakarta Sans', sans-serif";
        
        // Bar Chart
        const agSorted = Object.entries(agMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        if(charts.bar) charts.bar.destroy();
        charts.bar = new ApexCharts(document.querySelector("#chartBar"), {
            series: [{ name:'Fatturato', data: agSorted.map(x=>x[1]) }],
            chart: { type:'bar', height:320, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'60%', distributed:true } },
            colors: ['#c2410c', '#ea580c', '#f97316', '#fdba74', '#cbd5e1'],
            legend: { show:false }, dataLabels: { enabled:false },
            xaxis: { categories: agSorted.map(x=>x[0]), labels: { formatter: v => "€ " + (v/1000).toFixed(0) + "k" } }
        });
        charts.bar.render();

        // Donut
        const provMap = {};
        currentData.forEach(r => { const p = r.Provincia||'?'; provMap[p]=(provMap[p]||0)+asNum(r.Fatturato); });
        const provSorted = Object.entries(provMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        
        if(charts.donut) charts.donut.destroy();
        charts.donut = new ApexCharts(document.querySelector("#chartDonut"), {
            series: provSorted.map(x=>x[1]), labels: provSorted.map(x=>x[0]),
            chart: { type:'donut', height:320, fontFamily:font },
            colors: ['#78350f', '#9a3412', '#c2410c', '#d97706', '#f59e0b', '#cbd5e1'],
            legend: { position:'bottom' }
        });
        charts.donut.render();
    }

    function renderTable() {
        const body = currentData.map(r => [
            r.Agente_Nome,
            r.Regione,
            r.Provincia,
            r.Ragione_Sociale_Cliente,
            fmtEUR.format(asNum(r.Fatturato))
        ]);

        if(dataTable) { dataTable.destroy(); document.querySelector('#tbl').innerHTML = ''; }
        dataTable = new DataTable('#tbl', {
            data: body,
            columns: [{title:"Agente"},{title:"Regione"},{title:"Provincia"},{title:"Cliente"},{title:"Fatturato", className:"dt-right"}],
            order: [[4, 'desc']], pageLength: 10,
            language: { search: "Cerca:", paginate: { next: ">", previous: "<" }, info: "_START_ - _END_ di _TOTAL_" }
        });
    }
    
    // Eventi Filtri
    document.getElementById('selAgente').addEventListener('change', applyFilters);
    document.getElementById('selProvincia').addEventListener('change', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('selAgente').value = "";
        document.getElementById('selProvincia').value = "";
        applyFilters();
    });

  </script>
</body>
</html>
