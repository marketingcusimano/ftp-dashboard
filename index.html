<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cotto Cusimano â€¢ Dashboard Performance Agenti</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>

  <!-- SheetJS (export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --terra:#D2691E; --terra2:#CD853F;
      --bg:#ffffff; --text:#0b1320; --muted:#6b7280; --stroke:#e7e7e9;
      --chip:#f7efe9; --card:#ffffff; --good:#16a34a; --bad:#dc2626;
      --shadow: 0 6px 18px rgba(0,0,0,.06); --radius:14px;
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, Segoe UI, Roboto, system-ui, -apple-system, sans-serif }
    .wrap{ max-width:1280px; margin:0 auto; padding:20px }
    header{ display:grid; grid-template-columns: 220px 1fr auto; gap:16px; align-items:center }
    @media (max-width: 900px){ header{ grid-template-columns:1fr } }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{ width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg,var(--terra),var(--terra2)); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow:var(--shadow) }
    .title{text-align:center} .title h1{margin:0;font-size:22px}
    .sub{ color:var(--muted); font-size:12px; margin-top:4px }
    .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
    .btn{ border:1px solid var(--stroke); background:#fff; color:var(--text); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer }
    .btn:hover{ border-color:#d9d9dd }
    .bar{ margin-top:16px; display:grid; grid-template-columns: 1.2fr 1fr auto; gap:10px }
    @media (max-width: 900px){ .bar{ grid-template-columns:1fr } }
    select{ width:100%; border:1px solid var(--stroke); border-radius:12px; background:#fff; color:var(--text); padding:10px 12px; font-size:13px }
    .grid{ display:grid; gap:14px } .g3{ grid-template-columns: repeat(3, 1fr) } .g2{ grid-template-columns: repeat(2, 1fr) }
    @media (max-width: 900px){ .g3,.g2{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .muted{ color:var(--muted); font-size:12px }
    .kpi{ display:flex; align-items:center; gap:12px; min-height:64px }
    .kpi-ico{ width:36px; height:36px; border-radius:10px; background:var(--chip); display:flex; align-items:center; justify-content:center; color:var(--terra); font-weight:700 }
    .kpi-val{ font-size:26px; font-weight:700 } .kpi-delta{ font-size:12px; margin-top:4px }
    canvas{ width:100%; height:340px }
    table{ width:100% } table.dataTable thead th{ background:#fafafa } tbody tr:hover{ background:#fff7f1 }
    .sk{ position:relative; overflow:hidden; background:#f3f3f4; border-radius:8px; min-height:16px; display:inline-block }
    .sk::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(0,0,0,.06),transparent); animation:sh 1.2s infinite }
    @keyframes sh{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CC</div>
        <div>
          <div style="font-weight:700">Cotto Cusimano</div>
          <div class="muted">Materiali edilizi in terracotta</div>
        </div>
      </div>
      <div class="title">
        <h1>Dashboard Performance Agenti</h1>
        <div class="sub">Ultimo aggiornamento: <span id="updated" class="sk" style="min-width:120px;height:10px"></span></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnExcel">Esporta Excel</button>
        <button class="btn" id="btnPrint">Stampa / PDF</button>
      </div>
    </header>

    <div class="bar">
      <select id="selAgente"><option value="">Tutti gli agenti</option></select>
      <select id="selProvincia"><option value="">Tutte le province</option></select>
      <button class="btn" id="btnReset">Reset filtri</button>
    </div>

    <div class="grid g3" style="margin-top:16px;">
      <div class="card"><div class="muted">Fatturato Totale</div><div class="kpi"><div class="kpi-ico">â‚¬</div><div><div id="kpiFatturato" class="kpi-val sk" style="min-width:120px"></div><div id="kpiFattDelta" class="kpi-delta sk" style="min-width:60px"></div></div></div></div>
      <div class="card"><div class="muted">Clienti Totali</div><div class="kpi"><div class="kpi-ico">ðŸ‘¥</div><div><div id="kpiClienti" class="kpi-val sk" style="min-width:80px"></div><div class="kpi-delta muted">Fonte: blocco TOTALE</div></div></div></div>
      <div class="card"><div class="muted">Target raggiunto</div><div class="kpi"><div class="kpi-ico">ðŸŽ¯</div><div><div id="kpiTarget" class="kpi-val sk" style="min-width:60px"></div><div class="kpi-delta muted">OBIETTIVI (Generale)</div></div></div></div>
    </div>

    <div class="grid g2" style="margin-top:16px;">
      <div class="card"><div class="muted" style="margin-bottom:6px;">Fatturato per Agente</div><canvas id="chartAgenti"></canvas></div>
      <div class="card"><div class="muted" style="margin-bottom:6px;">Distribuzione per Provincia</div><canvas id="chartProvince"></canvas></div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="muted" style="margin-bottom:6px;">Vendite per Cliente</div>
      <table id="tbl" class="display">
        <thead><tr><th>Agente</th><th>Provincia</th><th>Cliente</th><th>Fatturato (â‚¬)</th></tr></thead>
        <tbody><tr><td colspan="4" class="muted">Caricamentoâ€¦</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    const fmtEUR = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' });
    const fmtINT = new Intl.NumberFormat('it-IT');
    const asNum  = v => (typeof v === 'number') ? v : Number(v||0);
    const byTipo = (rows,t) => rows.filter(r => r.Tipo_Dato === t);
    const $ = s => document.querySelector(s);

    function gradient(ctx){ const g=ctx.createLinearGradient(0,0,0,340); g.addColorStop(0,'#D2691E'); g.addColorStop(1,'#CD853F'); return g; }
    function unskeleton(ids){ ids.forEach(id => { const el=$(id); if(el) el.classList.remove('sk'); }); }

    const state = { all: [], rows: [], agente:'', provincia:'' };
    let CH_A=null, CH_P=null, DT=null;

    init().catch(e=>{ console.error(e); alert('Errore: '+e.message); });

    async function init(){
      const res = await fetch('/data', { cache:'no-store' });
      if(!res.ok) throw new Error('Fetch /data failed');
      const data = await res.json();

      $('#updated').textContent = new Date(data.updatedAt).toLocaleString('it-IT');
      $('#updated').classList.remove('sk');

      state.all = data.rows || [];
      state.rows = state.all.slice();

      const agenti = [...new Set(state.all.map(r => r.Agente_Nome || r.Agente_Codice || 'â€”'))].filter(Boolean).sort();
      const province = [...new Set(state.all.map(r => r.Provincia).filter(Boolean))].sort();

      const selA = $('#selAgente'), selP = $('#selProvincia');
      agenti.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; selA.appendChild(o); });
      province.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; selP.appendChild(o); });

      selA.addEventListener('change', ()=>{ state.agente=selA.value; apply(); });
      selP.addEventListener('change', ()=>{ state.provincia=selP.value; apply(); });
      $('#btnReset').addEventListener('click', ()=>{ state.agente=''; state.provincia=''; selA.value=''; selP.value=''; apply(); });

      $('#btnPrint').addEventListener('click', ()=>window.print());
      $('#btnExcel').addEventListener('click', ()=>{
        const ws = XLSX.utils.json_to_sheet(state.rows);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Dati');
        XLSX.writeFile(wb, 'dashboard-cotto-cusimano.xlsx');
      });

      renderAll();
    }

    function apply(){
      let rows = state.all.slice();
      if (state.agente) rows = rows.filter(r => (r.Agente_Nome===state.agente) || (r.Agente_Codice===state.agente) || (!r.Agente_Nome && !r.Agente_Codice && state.agente==='â€”'));
      if (state.provincia) rows = rows.filter(r => r.Provincia===state.provincia);
      state.rows = rows;
      renderAll();
    }

    function renderAll(){ renderKPIs(state.rows); renderCharts(state.rows); renderTable(state.rows);
      unskeleton(['#kpiFatturato','#kpiFattDelta','#kpiClienti','#kpiTarget']); }

    function renderKPIs(rows){
      const tot = byTipo(rows,'TOTALE');
      const fatt = tot.find(r => r.Descrizione==='Fatturato_Totale');
      const cli  = tot.find(r => r.Descrizione==='Clienti_Totale');
      $('#kpiFatturato').textContent = fatt ? fmtEUR.format(asNum(fatt.Valore||0)) : 'â€”';
      $('#kpiClienti').textContent   = cli  ? fmtINT.format(asNum(cli.Valore||0))   : 'â€”';

      const obGen = byTipo(rows,'OBIETTIVI').find(r => r.Provincia==='Generale');
      const prec = asNum(obGen?.Anno_Precedente||0), corr = asNum(obGen?.Anno_Corrente||0);
      const delta = (prec>0) ? ((corr-prec)/prec)*100 : null;
      $('#kpiFattDelta').innerHTML = (delta==null) ? 'â€”'
        : (delta>=0 ? `<span style="color:var(--good)">â–² ${delta.toFixed(1)}%</span>`
                    : `<span style="color:var(--bad)">â–¼ ${delta.toFixed(1)}%</span>`);
      const target = (typeof obGen?.Percentuale_Obiettivo==='number') ? obGen.Percentuale_Obiettivo : null;
      $('#kpiTarget').textContent = (target!=null) ? `${target.toFixed(2)}%` : 'â€”';
    }

    function renderCharts(rows){
      const byAgent = {};
      rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE').forEach(r=>{
        const a = r.Agente_Nome || r.Agente_Codice || 'â€”';
        byAgent[a] = (byAgent[a]||0) + asNum(r.Fatturato||0);
      });
      const ag = Object.entries(byAgent).sort((a,b)=>b[1]-a[1]);
      const lblA = ag.map(x=>x[0]), valA = ag.map(x=>x[1]);

      const ctxA = document.getElementById('chartAgenti').getContext('2d');
      if (CH_A) CH_A.destroy();
      CH_A = new Chart(ctxA, {
        type:'bar',
        data:{ labels: lblA, datasets:[{ label:'Fatturato', data: valA, backgroundColor: gradient(ctxA) }] },
        options:{
          indexAxis:'y', responsive:true,
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=>fmtEUR.format(c.parsed.x||0) } } },
          scales:{ x:{ ticks:{ callback:v=>fmtEUR.format(v) }, grid:{ color:'#f0f0f0' } }, y:{ grid:{ display:false } } }
        }
      });

      const byProv = {};
      rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE').forEach(r=>{
        const p = r.Provincia || 'â€”';
        byProv[p] = (byProv[p]||0) + asNum(r.Fatturato||0);
      });
      const pv = Object.entries(byProv).sort((a,b)=>b[1]-a[1]);
      const lblP = pv.map(x=>x[0]), valP = pv.map(x=>x[1]);

      const ctxP = document.getElementById('chartProvince').getContext('2d');
      if (CH_P) CH_P.destroy();
      CH_P = new Chart(ctxP, {
        type:'doughnut',
        data:{ labels: lblP, datasets:[{ data: valP }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:c=> `${c.label}: ${fmtEUR.format(c.parsed)}` } } } }
      });
    }

    function renderTable(rows){
      const body = rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE')
        .sort((a,b)=>asNum(b.Fatturato||0)-asNum(a.Fatturato||0))
        .map(r=>[
          r.Agente_Nome || r.Agente_Codice || 'â€”',
          r.Provincia || 'â€”',
          r.Ragione_Sociale_Cliente || '',
          fmtEUR.format(asNum(r.Fatturato||0))
        ]);

      if (DT){ DT.destroy(); document.querySelector('#tbl tbody').innerHTML=''; }
      DT = new DataTable('#tbl', {
        data: body,
        columns: [
          { title:'Agente' }, { title:'Provincia' },
          { title:'Cliente' }, { title:'Fatturato (â‚¬)', className:'dt-right' }
        ],
        order: [[3,'desc']], paging:true, pageLength:10, searchable:true, info:false
      });
    }
  </script>
</body>
</html>
