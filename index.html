<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard B2B - Rete Commerciale â€¢ Cotto Cusimano</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#2563eb",
            success: "#10b981",
            warning: "#f59e0b",
            danger:  "#ef4444",
          }
        }
      }
    }
  </script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts UMD -->
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>

  <style>
    body { background:#ffffff; font-family: Inter, Segoe UI, Roboto, system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <!-- ===== Helpers & Live Data Transform from /data ===== -->
  <script>
    const itNum = (v) => (typeof v === 'number') ? v : Number(String(v||'').replace(/\./g,'').replace(',', '.')) || 0;

    function buildDashboardData(apiJson){
      const rows = Array.isArray(apiJson?.rows) ? apiJson.rows : [];
      const updatedAt = apiJson?.updatedAt || null;

      const agentKey = (r) => (r.Agente_Codice || 'â€”') + '|' + (r.Agente_Nome || 'â€”');
      const agentsSet = new Set(rows.map(agentKey));
      const agentIds = [...agentsSet];
      const byTipo = (t) => rows.filter(r => r.Tipo_Dato === t);

      const OBI = byTipo('OBIETTIVI');
      const OBI_GEN = OBI.filter(r => r.Provincia === 'Generale');
      const OBI_PROV = OBI.filter(r => r.Provincia && r.Provincia !== 'Generale');
      const VEND = byTipo('VENDITE_CLIENTE');
      const CLIP = byTipo('CLIENTI_PROVINCIA');
      const TOT = byTipo('TOTALE');

      let fatturatoTot = 0;
      const totFattRows = TOT.filter(r => r.Descrizione === 'Fatturato_Totale');
      if (totFattRows.length > 0){
        fatturatoTot = totFattRows.reduce((s,r)=> s + itNum(r.Valore), 0);
      } else {
        fatturatoTot = VEND.reduce((s,r)=> s + itNum(r.Fatturato), 0);
      }
      let clientiTot = 0;
      const totCliRows = TOT.filter(r => r.Descrizione === 'Clienti_Totale');
      if (totCliRows.length > 0){
        clientiTot = totCliRows.reduce((s,r)=> s + itNum(r.Valore), 0);
      } else {
        clientiTot = CLIP.reduce((s,r)=> s + itNum(r.Clienti_Serviti), 0);
      }

      const agentiAttivi = agentIds.length;
      const sommaAC = OBI_GEN.reduce((s,r)=> s + itNum(r.Anno_Corrente), 0);
      const sommaOb = OBI_GEN.reduce((s,r)=> s + itNum(r.Obiettivo), 0);
      const percentOb = sommaOb > 0 ? (sommaAC / sommaOb) * 100 : 0;
      const sommaAP = OBI_GEN.reduce((s,r)=> s + itNum(r.Anno_Precedente), 0);
      const yoy = sommaAP > 0 ? ((sommaAC - sommaAP) / sommaAP) * 100 : 0;

      const agenti = agentIds.map(key => {
        const [codice, nome] = key.split('|');
        const vendAg = VEND.filter(r => agentKey(r) === key);
        const clipAg = CLIP.filter(r => agentKey(r) === key);
        const obiGenAg = OBI_GEN.find(r => agentKey(r) === key) || {};
        const perProvFatt = {};
        vendAg.forEach(r => {
          const p = r.Provincia || 'â€”';
          perProvFatt[p] = (perProvFatt[p] || 0) + itNum(r.Fatturato);
        });
        const perProvCli = {};
        clipAg.forEach(r => {
          const p = r.Provincia || 'â€”';
          perProvCli[p] = (perProvCli[p] || 0) + itNum(r.Clienti_Serviti);
        });
        const clientiperprov = Object.keys(perProvFatt).map(p => ({
          provincia: p,
          fatturato: perProvFatt[p],
          clienti: perProvCli[p] || 0
        }));

        return {
          codice,
          ragione_sociale: nome,
          periodo: null,
          obiettivi: { generale: {} },
          clienti_per_provincia: clientiperprov.sort((a,b)=> b.fatturato - a.fatturato),
          totali: {
            fatturato_corrente: itNum(obiGenAg.Anno_Corrente),
            fatturato_precedente: itNum(obiGenAg.Anno_Precedente),
            clienti_serviti: clipAg.reduce((s,r)=> s + itNum(r.Clienti_Serviti), 0),
            obiettivo: itNum(obiGenAg.Obiettivo),
            percentuale_obiettivo: itNum(obiGenAg.Percentuale_Obiettivo)
          }
        };
      });

      const provKeys = new Set(rows.map(r => r.Provincia).filter(Boolean).map(String));
      const province = [...provKeys].map(p => {
        const vendP = VEND.filter(r => r.Provincia === p);
        const clipP = CLIP.filter(r => r.Provincia === p);
        const obiP  = OBI_PROV.filter(r => r.Provincia === p);

        const fatt = vendP.reduce((s,r)=> s + itNum(r.Fatturato), 0);
        const clients = clipP.reduce((s,r)=> s + itNum(r.Clienti_Serviti), 0);
        const agSet = new Set( vendP.concat(clipP).concat(obiP).map(agentKey) );

        const somAC = obiP.reduce((s,r)=> s + itNum(r.Anno_Corrente), 0);
        const somOb = obiP.reduce((s,r)=> s + itNum(r.Obiettivo), 0);
        const perc = somOb > 0 ? (somAC / somOb) * 100 : 0;

        return {
          provincia: p,
          fatturato_totale: fatt,
          clienti_totali: clients,
          numero_agenti: agSet.size,
          obiettivo_totale: somOb,
          percentuale_obiettivo: perc
        };
      }).sort((a,b)=> b.fatturato_totale - a.fatturato_totale);

      return {
        riepilogo_generale: {
          fatturato_totale: fatturatoTot,
          percentuale_obiettivo: percentOb,
          clienti_totali: clientiTot,
          agenti_attivi: agentiAttivi,
          variazione_yoy: yoy,
          aggiornato_il: updatedAt
        },
        agenti,
        province
      };
    }

    async function loadLiveData(){
      try{
        const res = await fetch('/data', { cache:'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const api = await res.json();
        window.dashboardData = buildDashboardData(api);
      }catch(e){
        console.warn('Live /data non disponibile, uso dataset demo.', e);
        window.dashboardData = window.dashboardData || {
          riepilogo_generale: {
            fatturato_totale: 0,
            percentuale_obiettivo: 0,
            clienti_totali: 0,
            agenti_attivi: 0,
            variazione_yoy: 0,
            aggiornato_il: new Date().toISOString()
          },
          agenti: [], province: []
        };
      }
    }
  </script>

  <!-- ======================= APP REACT ======================= -->
  <script type="text/babel" data-presets="react" defer>
    // Utility visuali
    const formatEuro = (v) => new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(v||0);
    const formatPercent = (v) => (typeof v === 'number') ? (v.toFixed(2).replace('.', ',') + '%') : 'â€”';
    const formatNumber = (v) => new Intl.NumberFormat('it-IT').format(v||0);
    const getColorByPerformance = (p) => (p>=90 ? '#10b981' : p>=70 ? '#f59e0b' : '#ef4444');

    function mount(){
      // Safe destructuring AFTER Recharts is loaded
      const {
        ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
        PieChart, Pie, Cell, ScatterChart, Scatter
      } = Recharts;

      const Header = ({ updatedAt }) => (
        <header className="border-b border-gray-100 bg-white">
          <div className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
            <div className="flex items-center gap-3">
              <div className="w-11 h-11 rounded-xl bg-gradient-to-br from-primary to-blue-400 flex items-center justify-center text-white font-bold">CC</div>
              <div>
                <div className="font-semibold">Cotto Cusimano</div>
                <div className="text-xs text-gray-500">Rete commerciale B2B</div>
              </div>
            </div>
            <div className="text-center">
              <h1 className="text-xl md:text-2xl font-bold">Dashboard Performance Agenti</h1>
              <div className="text-xs text-gray-500 mt-1">Ultimo aggiornamento: <span className="font-medium">{updatedAt}</span></div>
            </div>
            <div className="flex md:justify-end gap-2">
              <button className="px-3 py-2 rounded-xl border border-gray-200" onClick={()=>window.print()}>Stampa</button>
            </div>
          </div>
        </header>
      );

      const KPICard = ({ label, value, color='text-primary', icon='â—', delta, hint }) => (
        <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
          <div className="flex justify-between items-start">
            <div className="text-sm text-gray-500">{label}</div>
            <div className={"text-xs px-2 py-0.5 rounded-full border " + color} style={{borderColor:"currentColor"}}>{icon}</div>
          </div>
          <div className="text-2xl font-bold mt-1">{value}</div>
          {typeof delta === 'number' && (
            <div className="mt-1 text-sm">
              {delta >= 0 ? <span className="text-success">â–² {delta.toFixed(1)}%</span> : <span className="text-danger">â–¼ {Math.abs(delta).toFixed(1)}%</span>}
              <span className="text-gray-400 ml-1">vs prec.</span>
            </div>
          )}
          {hint && <div className="mt-1 text-xs text-gray-500">{hint}</div>}
        </div>
      );

      const Gauge = ({ percent=0 }) => {
        const clamped = Math.max(0, Math.min(100, percent));
        const color = getColorByPerformance(clamped);
        const rest = 100 - clamped;
        return (
          <ResponsiveContainer width="100%" height={220}>
            <PieChart>
              <Pie data={[{value:clamped},{value:rest}]} startAngle={180} endAngle={0}
                   innerRadius={70} outerRadius={100} dataKey="value">
                <Cell fill={color} /><Cell fill="#eee" />
              </Pie>
              <text x="50%" y="60%" textAnchor="middle" dominantBaseline="middle" className="fill-gray-700" style={{fontSize:24,fontWeight:700}}>
                {formatPercent(clamped)}
              </text>
              <text x="50%" y="78%" textAnchor="middle" dominantBaseline="middle" className="fill-gray-500" style={{fontSize:12}}>
                Raggiungimento obiettivo
              </text>
            </PieChart>
          </ResponsiveContainer>
        );
      };

      function App(){
        const { useState, useMemo } = React;
        const data = window.dashboardData;
        const [tab, setTab] = useState('panoramica');
        const [provSel, setProvSel] = useState('');
        const [agSel, setAgSel] = useState('');

        const updatedAt = useMemo(()=>{
          const d = data?.riepilogo_generale?.aggiornato_il;
          try { return new Date(d).toLocaleString('it-IT'); } catch { return 'â€”'; }
        }, [data]);

        const agenti = useMemo(()=> (data.agenti||[]).map(a=>({
          codice:a.codice, nome:a.ragione_sociale,
          fatturato:a?.totali?.fatturato_corrente||0,
          clienti:a?.totali?.clienti_serviti||0,
          obiettivo:a?.totali?.obiettivo||0,
          perc:a?.totali?.percentuale_obiettivo||0,
          perProvincia:a?.clienti_per_provincia||[],
          precedente:a?.totali?.fatturato_precedente||0
        })), [data]);

        const province = useMemo(()=> data.province||[], [data]);
        const kpi = data?.riepilogo_generale||{};
        const topAgenti = useMemo(()=> [...agenti].sort((a,b)=>b.fatturato-a.fatturato).slice(0,10), [agenti]);
        const topProv = useMemo(()=> [...province].sort((a,b)=>b.fatturato_totale-a.fatturato_totale).slice(0,10), [province]);

        const filteredAgentiInProv = useMemo(()=>{
          if (!provSel) return agenti;
          return agenti.filter(a => (a.perProvincia||[]).some(pp => pp.provincia === provSel));
        }, [agenti, provSel]);

        const agenteCorrente = useMemo(()=>{
          if (!agSel) return agenti[0];
          return agenti.find(a=> a.codice===agSel || a.nome===agSel) || agenti[0];
        }, [agenti, agSel]);

        return (
          <div>
            <Header updatedAt={updatedAt} />
            <main className="max-w-7xl mx-auto px-4 py-8">
              <div className="flex gap-2 mb-6">
                <button className={"px-4 py-2 rounded-full border " + (tab==='panoramica'?'bg-primary text-white border-primary':'border-gray-200')} onClick={()=>setTab('panoramica')}>Panoramica Generale</button>
                <button className={"px-4 py-2 rounded-full border " + (tab==='regioni'?'bg-primary text-white border-primary':'border-gray-200')} onClick={()=>setTab('regioni')}>Regioni</button>
                <button className={"px-4 py-2 rounded-full border " + (tab==='agenti'?'bg-primary text-white border-primary':'border-gray-200')} onClick={()=>setTab('agenti')}>Agenti</button>
              </div>

              {tab==='panoramica' && (
                <section className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <KPICard label="Fatturato Totale Rete" value={formatEuro(kpi.fatturato_totale||0)} icon="â‚¬" />
                    <KPICard label="% Raggiungimento Obiettivo" value={formatPercent(kpi.percentuale_obiettivo||0)} icon="ðŸŽ¯" color="text-success" />
                    <KPICard label="Clienti Totali" value={formatNumber(kpi.clienti_totali||0)} icon="ðŸ‘¥" color="text-primary" />
                    <KPICard label="Agenti Attivi" value={formatNumber(kpi.agenti_attivi||0)} icon="ðŸ§‘â€ðŸ’¼" color="text-primary" />
                    <KPICard label="Variazione YoY" value={formatPercent(Math.abs(kpi.variazione_yoy||0))} icon="â†•"
                             color={(kpi.variazione_yoy||0)>=0?'text-success':'text-danger'}
                             delta={kpi.variazione_yoy||0} />
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="font-semibold mb-2">Top 10 Agenti per Fatturato</div>
                      <div className="h-72">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={topAgenti}>
                            <CartesianGrid stroke="#eee" />
                            <XAxis type="number" tickFormatter={formatEuro} />
                            <YAxis type="category" dataKey="nome" width={120} />
                            <Tooltip formatter={(v)=>formatEuro(v)} />
                            <Bar dataKey="fatturato">
                              {topAgenti.map((a,i)=> <Cell key={i} fill={`hsl(${20 + i*6}, 70%, 50%)`} />)}
                            </Bar>
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="font-semibold mb-2">Raggiungimento Obiettivo Generale</div>
                      <Gauge percent={kpi.percentuale_obiettivo||0} />
                    </div>
                  </div>

                  <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                    <div className="font-semibold mb-2">Fatturato per Provincia (Top 10)</div>
                    <div className="h-80">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={topProv}>
                          <CartesianGrid stroke="#eee" />
                          <XAxis dataKey="provincia" />
                          <YAxis tickFormatter={formatEuro} />
                          <Tooltip formatter={(v)=>formatEuro(v)} />
                          <Bar dataKey="fatturato" fill="#2563eb" />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="text-sm text-gray-500">Fatturato medio per agente</div>
                      <div className="text-2xl font-bold mt-1">
                        {formatEuro((kpi.fatturato_totale||0)/Math.max(1,(kpi.agenti_attivi||1)))}
                      </div>
                    </div>
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="text-sm text-gray-500">Clienti medi per agente</div>
                      <div className="text-2xl font-bold mt-1">
                        {formatNumber((kpi.clienti_totali||0)/Math.max(1,(kpi.agenti_attivi||1)))}
                      </div>
                    </div>
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="text-sm text-gray-500">Fatturato medio per cliente</div>
                      <div className="text-2xl font-bold mt-1">
                        {formatEuro((kpi.fatturato_totale||0)/Math.max(1,(kpi.clienti_totali||1)))}
                      </div>
                    </div>
                  </div>
                </section>
              )}

              {tab==='regioni' && (
                <section className="space-y-6">
                  <div className="flex flex-col md:flex-row gap-3">
                    <select className="px-3 py-2 rounded-xl border border-gray-200"
                            value={provSel} onChange={e=>setProvSel(e.target.value)}>
                      <option value="">Tutte le Province</option>
                      {province.map(p=> <option key={p.provincia} value={p.provincia}>{p.provincia}</option>)}
                    </select>
                    <button className="px-3 py-2 rounded-xl border border-gray-200" onClick={()=>setProvSel('')}>Reset</button>
                  </div>

                  {provSel && (()=>{
                    const P = province.find(p=>p.provincia===provSel);
                    if (!P) return null;
                    return (
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <KPICard label="Fatturato Provincia" value={formatEuro(P.fatturato_totale||0)} icon="â‚¬" />
                        <KPICard label="Agenti operanti" value={formatNumber(P.numero_agenti||0)} icon="ðŸ§‘â€ðŸ’¼" />
                        <KPICard label="Clienti totali" value={formatNumber(P.clienti_totali||0)} icon="ðŸ‘¥" />
                        <KPICard label="% Obiettivo" value={formatPercent(P.percentuale_obiettivo||0)} icon="ðŸŽ¯" color="text-success" />
                      </div>
                    );
                  })()}

                  <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                    <div className="font-semibold mb-2">Fatturato per Provincia (tutte)</div>
                    <div className="h-96">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={[...province].sort((a,b)=> (b.fatturato_totale||0)-(a.fatturato_totale||0))}>
                          <CartesianGrid stroke="#eee" />
                          <XAxis dataKey="provincia" interval={0} angle={-45} textAnchor="end" height={80} />
                          <YAxis tickFormatter={formatEuro} />
                          <Tooltip formatter={(v)=>formatEuro(v)} />
                          <Bar dataKey="fatturato_totale">
                            {[...province].sort((a,b)=> (b.fatturato_totale||0)-(a.fatturato_totale||0)).map((p,i)=>
                              <Cell key={i} fill={getColorByPerformance(p.percentuale_obiettivo||0)} />
                            )}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>

                  <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                    <div className="font-semibold mb-2">Clienti vs Fatturato (per Provincia)</div>
                    <div className="h-96">
                      <ResponsiveContainer width="100%" height="100%">
                        <ScatterChart>
                          <CartesianGrid stroke="#eee" />
                          <XAxis type="number" dataKey="x" name="Clienti" />
                          <YAxis type="number" dataKey="y" name="Fatturato" tickFormatter={formatEuro} />
                          <Tooltip formatter={(v, name)=> name==='y'?formatEuro(v):formatNumber(v)}
                                   labelFormatter={(_,i)=> province[i]?.provincia } />
                          <Scatter data={province.map(p=>({x:p.clienti_totali||0,y:p.fatturato_totale||0}))} fill="#2563eb" />
                        </ScatterChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>
              )}

              {tab==='agenti' && (
                <section className="space-y-6">
                  <div className="flex flex-col md:flex-row gap-3">
                    <select className="px-3 py-2 rounded-xl border border-gray-200"
                            value={agSel} onChange={e=>setAgSel(e.target.value)}>
                      {agenti.map(a=> <option key={a.codice} value={a.codice}>{a.codice} â€” {a.nome}</option>)}
                    </select>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-6 gap-6">
                    <KPICard label="Fatturato A.C." value={formatEuro(agenteCorrente?.fatturato||0)} icon="â‚¬" />
                    <KPICard label="Obiettivo" value={formatEuro(agenteCorrente?.obiettivo||0)} icon="ðŸŽ¯" />
                    <KPICard label="% Raggiungimento" value={formatPercent(agenteCorrente?.perc||0)} icon="âœ“" color="text-success" />
                    <KPICard label="Clienti Serviti" value={formatNumber(agenteCorrente?.clienti||0)} icon="ðŸ‘¥" />
                    <KPICard label="Variazione YoY" value={formatPercent(((agenteCorrente?.fatturato||0)-(agenteCorrente?.precedente||0))/Math.max(1,(agenteCorrente?.precedente||0))*100 || 0)} icon="â†•"
                             color={((agenteCorrente?.fatturato||0)-(agenteCorrente?.precedente||0))>=0?'text-success':'text-danger'} />
                    <KPICard label="Province coperte" value={formatNumber((agenteCorrente?.perProvincia||[]).length)} icon="ðŸ—ºï¸" />
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="font-semibold mb-2">Fatturato per Provincia (Agente)</div>
                      <div className="h-80">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={[...(agenteCorrente?.perProvincia||[])].sort((a,b)=> (b.fatturato||0)-(a.fatturato||0))}>
                            <CartesianGrid stroke="#eee" />
                            <XAxis dataKey="provincia" />
                            <YAxis tickFormatter={formatEuro} />
                            <Tooltip formatter={(v)=>formatEuro(v)} />
                            <Bar dataKey="fatturato" fill="#2563eb" />
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                      <div className="font-semibold mb-2">Performance vs Obiettivo</div>
                      <div className="h-60">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={[{value:agenteCorrente?.perc||0},{value:100-(agenteCorrente?.perc||0)}]} startAngle={180} endAngle={0} innerRadius={70} outerRadius={100} dataKey="value">
                              <Cell fill={getColorByPerformance(agenteCorrente?.perc||0)} /><Cell fill="#eee" />
                            </Pie>
                            <text x="50%" y="60%" textAnchor="middle" dominantBaseline="middle" className="fill-gray-700" style={{fontSize:24,fontWeight:700}}>
                              {formatPercent(agenteCorrente?.perc||0)}
                            </text>
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white border border-gray-100 rounded-2xl shadow-md p-6">
                    <div className="font-semibold mb-2">Top Province (Distribuzione Fatturato)</div>
                    <div className="h-80">
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie data={[...(agenteCorrente?.perProvincia||[])].sort((a,b)=>b.fatturato-a.fatturato).slice(0,5)}
                               dataKey="fatturato" nameKey="provincia" cx="50%" cy="50%" outerRadius={120} label>
                            {(agenteCorrente?.perProvincia||[]).slice(0,5).map((_,i)=>(
                              <Cell key={i} fill={`hsl(${200 + i*25},70%,50%)`} />
                            ))}
                          </Pie>
                          <Tooltip formatter={(v)=>formatEuro(v)} />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>
              )}
            </main>
          </div>
        );
      }

      function renderApp(){
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(mount));
      }

      renderApp();
    }

    async function bootstrap(){
      await loadLiveData();
      // Wait for Recharts to be defined
      if (typeof Recharts === 'undefined') {
        const timer = setInterval(()=>{
          if (typeof Recharts !== 'undefined') {
            clearInterval(timer);
            mount();
          }
        }, 100);
      } else {
        mount();
      }
    }

    // Kick off after DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bootstrap);
    } else {
      bootstrap();
    }
  </script>
</body>
</html>
