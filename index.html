<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard B2B</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { bg:"#0b1320", panel:"#0f172a", stroke:"#1e293b", text:"#e2e8f0", muted:"#94a3b8", brand:"#3b82f6", good:"#22c55e" }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    th,td{white-space:nowrap}
    thead th{position:sticky;top:0;background:#0b1222;z-index:1}
  </style>
</head>
<body class="bg-bg text-text">
  <main class="max-w-6xl mx-auto p-5 grid gap-5">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold">Dashboard B2B</h1>
        <p id="meta" class="text-sm text-muted">Caricamento…</p>
      </div>
      <button id="refresh" class="px-4 py-2 rounded-xl bg-brand text-white">Aggiorna</button>
    </header>

    <!-- Filtri -->
    <section class="bg-panel border border-stroke rounded-2xl p-4 grid gap-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="flex items-center gap-2">
          <label class="text-sm text-muted min-w-28">Agente</label>
          <select id="agent" class="bg-[#0b1222] border border-stroke rounded-xl px-3 py-2 w-full"></select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-muted min-w-28">Sezione</label>
          <select id="section" class="bg-[#0b1222] border border-stroke rounded-xl px-3 py-2 w-full"></select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-muted min-w-28">Cerca</label>
          <input id="search" class="bg-[#0b1222] border border-stroke rounded-xl px-3 py-2 w-full" placeholder="cliente, provincia, categoria…"/>
        </div>
      </div>
    </section>

    <!-- KPI -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-panel border border-stroke rounded-2xl p-5"><div class="text-xs text-muted">Righe</div><div id="k-rows" class="text-2xl font-bold">–</div></div>
      <div class="bg-panel border border-stroke rounded-2xl p-5"><div class="text-xs text-muted">Fatturato Totale</div><div id="k-fat" class="text-2xl font-bold">–</div></div>
      <div class="bg-panel border border-stroke rounded-2xl p-5"><div class="text-xs text-muted">% Obiettivo (media)</div><div id="k-perc" class="text-2xl font-bold">–</div></div>
      <div class="bg-panel border border-stroke rounded-2xl p-5"><div class="text-xs text-muted">Clienti Serviti</div><div id="k-cli" class="text-2xl font-bold">–</div></div>
    </section>

    <!-- Grafico + Tabella -->
    <section class="grid lg:grid-cols-2 gap-5">
      <div class="bg-panel border border-stroke rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Fatturato per Provincia</h3>
          <span id="chart-note" class="text-xs text-muted"></span>
        </div>
        <div class="h-[340px]"><canvas id="chart"></canvas></div>
      </div>

      <div class="bg-panel border border-stroke rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Tabella</h3>
          <span class="text-xs text-muted">prime 300 righe</span>
        </div>
        <div class="overflow-auto border border-stroke rounded-xl">
          <table id="tbl" class="w-full text-sm"></table>
        </div>
      </div>
    </section>
  </main>

<script>
let RAW=[], VIEW=[], chart;
const el = id => document.getElementById(id);
const fmt = n => (n==null||isNaN(n)) ? '—' : n.toLocaleString('it-IT',{maximumFractionDigits:2});

function buildAgents(){
  const byKey = r => (r.Agente_Codice || '') + '|' + (r.Agente_Nome || '');
  const set = new Set(RAW.map(byKey));
  const options = ['|Tutti gli agenti', ...Array.from(set)];
  el('agent').innerHTML = options.map(k=>{
    const [cod, nome] = k.split('|');
    const label = nome || 'Tutti gli agenti';
    return `<option value="${cod}||${nome}">${label}</option>`;
  }).join('');
}

function buildSections(){
  const set = new Set(RAW.map(r=>r.__Sezione||'Generale').filter(Boolean));
  el('section').innerHTML = '<option value="">Tutte le sezioni</option>' +
    Array.from(set).map(x=>`<option>${x}</option>`).join('');
}

function filterRows(){
  const [cod, nome] = (el('agent').value||'|').split('||');
  const sec = el('section').value;
  const q   = el('search').value.toLowerCase().trim();

  let rows = RAW;
  // filtro agente (se non è "Tutti gli agenti")
  if (cod || nome){
    rows = rows.filter(r =>
      (r.Agente_Codice||'')===cod && (r.Agente_Nome||'')===nome
    );
  }
  if (sec) rows = rows.filter(r => (r.__Sezione||'')===sec);
  if (q) rows = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
  return rows;
}

function computeTotals(rows){
  // somme per Fatturato/Anno_Corrente/Importo_* e clienti
  const num = k => rows.reduce((a,r)=>a + (Number(r[k])||0), 0);
  const arr = k => rows.map(r=>Number(r[k])).filter(Number.isFinite);

  const fatturato = num('Fatturato') + num('Importo_Totale') + num('Importo') + num('Anno_Corrente');
  const clienti   = num('Clienti_Serviti') + num('Clienti_Totale') + num('Clienti_Anno_Corrente');

  const percCols = ['Percentuale_Obiettivo','Percentuale_Obiettivo_Clienti'];
  const pVals = percCols.flatMap(k => arr(k));
  const pAvg  = pVals.length ? pVals.reduce((a,b)=>a+b,0) / pVals.length : null;

  return { fatturato, clienti, pAvg };
}

function drawTable(rows){
  const tbl = el('tbl');
  if (!rows.length){ tbl.innerHTML = '<thead><tr><th class="px-3 py-2 text-left text-gray-400">Nessun dato</th></tr></thead>'; return []; }
  const cols = Object.keys(rows[0]);
  const percCols = new Set(cols.filter(c => c.toLowerCase().includes('percentuale')));
  const head = '<thead class="border-b border-stroke"><tr>'+cols.map(c=>`<th class="px-3 py-2 text-left">${c}</th>`).join('')+'</tr></thead>';
  const body = rows.slice(0,300).map(r=>{
    return '<tr class="border-b border-stroke/50">'+cols.map(c=>{
      let v = r[c];
      if (v == null) v = '';
      else if (percCols.has(c) && typeof v === 'number') v = v.toLocaleString('it-IT',{maximumFractionDigits:2}) + '%';
      else if (typeof v === 'number') v = v.toLocaleString('it-IT',{maximumFractionDigits:2});
      return `<td class="px-3 py-2">${v}</td>`;
    }).join('')+'</tr>';
  }).join('');
  tbl.innerHTML = head + '<tbody>' + body + '</tbody>';
  return cols;
}

function drawChart(rows){
  const ctx = el('chart').getContext('2d');
  if (chart) chart.destroy();
  if (!rows.length){ chart = new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'',data:[]}]}}); el('chart-note').textContent=''; return; }

  // Aggrego Fatturato per Provincia (usando Fatturato || Importo_Totale || Anno_Corrente come fallback)
  const valueKeys = ['Fatturato','Importo_Totale','Importo','Anno_Corrente'];
  const pick = r => {
    for (const k of valueKeys){ if (Number.isFinite(+r[k])) return +r[k]; }
    return 0;
  };

  const agg = new Map();
  for (const r of rows){
    const prov = (r.Provincia || 'Generale').toString();
    agg.set(prov, (agg.get(prov)||0) + pick(r));
  }
  const labels = Array.from(agg.keys());
  const data   = Array.from(agg.values());

  chart = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ label:'Fatturato', data, backgroundColor:'#3b82f6' }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:'#e2e8f0' } },
        tooltip:{ callbacks:{ label:(ctx)=> '€ ' + ctx.parsed.y.toLocaleString('it-IT') } }
      },
      scales:{
        x:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2942' } },
        y:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2942' }, suggestedMin:0 }
      }
    }
  });
  el('chart-note').textContent = 'Somma valori per provincia';
}

function updateKpi(rows, cols, updatedAt){
  const t = computeTotals(rows);
  el('k-rows').textContent = rows.length;
  el('k-fat').textContent  = '€ ' + fmt(t.fatturato);
  el('k-cli').textContent  = fmt(t.clienti);
  el('k-perc').textContent = t.pAvg==null ? '—' : t.pAvg.toLocaleString('it-IT',{maximumFractionDigits:2}) + '%';
  el('meta').textContent   = `${rows.length} righe • ${cols.length} colonne • aggiornato ${new Date(updatedAt).toLocaleString('it-IT')}`;
}

async function load(){
  el('meta').textContent = 'Carico dati…';
  const res = await fetch('/data', { cache:'no-store' });
  const json = await res.json();
  RAW = json.rows || [];

  // costruisco tendine
  buildAgents();
  buildSections();

  // applico filtri e disegno
  VIEW = filterRows();
  const cols = drawTable(VIEW);
  drawChart(VIEW);
  updateKpi(VIEW, cols, json.updatedAt || new Date());
}

el('refresh').addEventListener('click', load);
el('agent').addEventListener('change',  ()=>{ VIEW=filterRows(); const c=drawTable(VIEW); drawChart(VIEW); updateKpi(VIEW,c,new Date()); });
el('section').addEventListener('change',()=>{ VIEW=filterRows(); const c=drawTable(VIEW); drawChart(VIEW); updateKpi(VIEW,c,new Date()); });
el('search').addEventListener('input',   ()=>{ VIEW=filterRows(); const c=drawTable(VIEW); drawChart(VIEW); updateKpi(VIEW,c,new Date()); });

load().catch(e=>{ el('meta').textContent='Errore: '+e.message; console.error(e); });
</script>
</body>
</html>
