<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Executive Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      /* --- PALETTE PREMIUM --- */
      --primary: #c2410c;         
      --primary-gradient: linear-gradient(135deg, #c2410c 0%, #ea580c 100%);
      --secondary: #1e293b;       
      
      /* Backgrounds */
      --bg-body: #fffaf5;         
      --bg-card: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.8);
      
      /* Text */
      --text-main: #0f172a;
      --text-muted: #64748b;
      
      /* Borders & Shadows */
      --border: rgba(194, 65, 12, 0.08);
      --radius: 24px;
      --shadow-glow: 0 20px 40px -10px rgba(194, 65, 12, 0.15), 0 10px 20px -5px rgba(0,0,0,0.02);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
    }

    * { box-sizing: border-box; outline: none; }
    
    body { 
      margin: 0; background: var(--bg-body); color: var(--text-main); 
      font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 80px; 
      -webkit-font-smoothing: antialiased;
      background-image: radial-gradient(at 0% 0%, rgba(194, 65, 12, 0.03) 0px, transparent 50%), 
                        radial-gradient(at 100% 0%, rgba(234, 88, 12, 0.03) 0px, transparent 50%);
      background-attachment: fixed;
    }

    .animate-in { animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(20px); }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    .container { max-width: 1500px; margin: 0 auto; padding: 0 32px; }

    /* --- HEADER (MIGLIORATO) --- */
    header {
      background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      padding: 20px 0; margin-bottom: 40px;
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px; }
    
    .brand { display: flex; align-items: center; gap: 16px; }
    .logo-img { height: 48px; width: auto; }
    
    .h-title { font-size: 24px; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: var(--text-main); }
    .h-sub { font-size: 14px; color: var(--text-muted); font-weight: 600; display:flex; align-items:center; gap:6px; }
    
    /* --- CONTROLS (MIGLIORATI) --- */
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    
    .select-wrapper { position: relative; display: inline-block; flex-grow: 1; }
    select {
      background: #fff; border: 1px solid #e2e8f0;
      padding: 12px 40px 12px 16px; border-radius: 12px; 
      font-size: 14px; font-weight: 700; color: var(--text-main); 
      cursor: pointer; width: 100%; min-width: 180px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: var(--shadow-sm); appearance: none;
    }
    select:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.05); border-color: var(--primary); }
    select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(194, 65, 12, 0.1); }
    select:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .sel-arrow { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted); font-size: 18px; transition: 0.2s; }
    .select-wrapper:hover .sel-arrow { color: var(--primary); transform: translateY(-50%) rotate(180deg); }

    .btn {
      background: #fff; border: 1px solid #e2e8f0;
      padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 700;
      cursor: pointer; display: inline-flex; gap: 8px; align-items: center;
      transition: all 0.3s; color: var(--text-main); box-shadow: var(--shadow-sm);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
    
    .btn-reset { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }
    .btn-reset:hover { background: #fee2e2; border-color: #fecaca; box-shadow: 0 8px 16px rgba(239, 68, 68, 0.1); }

    /* Filter hint badge */
    .filter-hint {
      font-size: 10px;
      color: var(--primary);
      background: #fff7ed;
      padding: 2px 8px;
      border-radius: 10px;
      position: absolute;
      top: -8px;
      right: 10px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(5px);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    .filter-hint.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* --- CARDS --- */
    .card {
      background: linear-gradient(180deg, #ffffff 0%, #fffbf8 100%);
      border-radius: var(--radius); padding: 32px;
      box-shadow: var(--shadow-glow); border: 1px solid rgba(255,255,255,0.6);
      position: relative; transition: transform 0.3s ease;
      display: flex; flex-direction: column; height: 100%;
    }
    .card:hover { transform: translateY(-4px); }

    /* LAYOUT GRIDS */
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .grid-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px; }
    .grid-charts-rev { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 32px; }
    .grid-split { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }

    @media (max-width: 1200px) { 
        .grid-charts, .grid-charts-rev, .grid-split { grid-template-columns: 1fr; }
        .header-inner { flex-direction: column; align-items: stretch; }
        .controls { width: 100%; }
        .select-wrapper, .btn { flex-grow: 1; }
    }

    /* --- KPI DESIGN --- */
    .kpi-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; min-height: 48px; }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .kpi-icon-wrap {
      width: 48px; height: 48px; border-radius: 14px; flex-shrink: 0;
      background: linear-gradient(135deg, #fff5eb 0%, #fff0e0 100%);
      color: var(--primary); display: grid; place-items: center; font-size: 22px;
      box-shadow: inset 0 0 0 1px rgba(194, 65, 12, 0.05);
    }
    .kpi-body { margin-top: auto; display: flex; flex-direction: column; justify-content: flex-end; }
    .kpi-val-row { display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--text-main); letter-spacing: -1.5px; line-height: 1; }
    .kpi-prev-row { font-size: 13px; color: #64748b; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .kpi-prev-num { font-family: 'JetBrains Mono', monospace; color: #334155; font-weight: 700; }

    /* KPI Animation */
    .kpi-val.animating {
      animation: kpiPulse 0.4s ease-out;
    }
    @keyframes kpiPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); color: var(--primary); }
      100% { transform: scale(1); }
    }

    /* TREND BADGES */
    .trend-badge {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 4px 10px; border-radius: 20px;
        font-size: 12px; font-weight: 700; letter-spacing: -0.3px;
        transform: translateY(-3px); font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .trend-up { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
    .trend-down { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .trend-neutral { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
    .trend-val-abs { opacity: 0.9; } .trend-sep { opacity: 0.4; font-weight: 400; margin: 0 2px; }

    .card-dark { background: radial-gradient(circle at top right, #334155 0%, #0f172a 100%); color: white; border: 1px solid rgba(255,255,255,0.1); }
    .card-dark .kpi-label { color: rgba(255,255,255,0.5); }
    .card-dark .kpi-icon-wrap { background: rgba(255,255,255,0.1); color: #fbbf24; border:none; }
    .card-dark .kpi-val { color: #fff; font-size:18px; font-family:'Plus Jakarta Sans', sans-serif; letter-spacing: 0; margin-bottom: 4px; }
    .card-dark .money-gold { color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 24px; }

    /* --- CHART STYLES & EXTRAS --- */
    .chart-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .chart-title { font-size: 18px; font-weight: 700; margin: 0; }
    .chart-badge { background: #fff7ed; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Expand button */
    .chart-header-right { display: flex; align-items: center; gap: 10px; }
    .btn-expand {
      background: transparent; border: 1px solid #e2e8f0;
      width: 32px; height: 32px; border-radius: 8px;
      display: grid; place-items: center; cursor: pointer;
      color: var(--text-muted); font-size: 16px;
      transition: all 0.2s ease;
    }
    .btn-expand:hover {
      background: var(--primary); border-color: var(--primary);
      color: white; transform: scale(1.1);
    }
    
    /* Descrizioni grafici */
    .chart-desc { 
        font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 16px; font-style: italic; padding: 0; 
    }

    /* --- MODAL (POP UP) STYLES --- */
    .modal-overlay {
        position: fixed; inset: 0; 
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        z-index: 99999; /* Sempre sopra */
        display: none; 
        justify-content: center; align-items: center; padding: 20px;
        animation: fadeIn 0.2s ease;
    }
    
    .modal-content {
        background: #fff; width: 100%; max-width: 600px; max-height: 85vh;
        border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex; flex-direction: column; overflow: hidden;
        position: relative;
        animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-header {
        padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
        display: flex; justify-content: space-between; align-items: center; background: #f8fafc;
    }
    
    .modal-title { font-size: 16px; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Tasto X */
    .btn-close-modal {
        background: #e2e8f0; border: none; font-size: 20px; color: var(--text-muted);
        cursor: pointer; display: grid; place-items: center; width: 36px; height: 36px; border-radius: 50%;
        transition: 0.2s;
    }
    .btn-close-modal:hover { background: #cbd5e1; color: #b91c1c; }
    
    .modal-body { padding: 24px; overflow-y: auto; background: #fff; }

    /* LIST ITEMS IN MODAL */
    .agent-list-item { 
      display: flex; flex-direction: column; gap:8px;
      padding: 16px; background: #fff; border: 1px solid #e2e8f0; margin-bottom: 12px; border-radius: 12px; 
      transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .agent-list-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 8px 16px rgba(194, 65, 12, 0.1); }
    
    .agent-row-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 8px; }
    .agent-name { font-weight: 700; font-size: 14px; color: var(--text-main); }
    .agent-val-highlight { font-size: 13px; font-weight: 800; color: var(--primary); }

    .agent-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
    .det-label { color: var(--text-muted); font-weight: 500; }
    .det-val { color: var(--text-main); font-weight: 700; }
    
    .tag-pct { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 800; }
    .tag-crit { background: #fee2e2; color: #b91c1c; }
    .tag-warn { background: #ffedd5; color: #c2410c; }
    .tag-ok { background: #dcfce7; color: #15803d; }

    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes slideUpModal { from { transform: translateY(40px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    /* --- EXPANDED DATA MODAL --- */
    .modal-lg .modal-content {
      max-width: 900px;
    }
    .data-table-modal {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table-modal thead th {
      background: #f8fafc;
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
    }
    .data-table-modal tbody tr {
      transition: background 0.2s;
    }
    .data-table-modal tbody tr:hover {
      background: #fff7ed;
    }
    .data-table-modal tbody td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 13px;
    }
    .data-table-modal .rank-cell {
      width: 50px;
      text-align: center;
    }
    .data-table-modal .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      font-weight: 800;
      font-size: 12px;
    }
    .rank-gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
    .rank-silver { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); color: white; }
    .rank-bronze { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; }
    .rank-default { background: #f1f5f9; color: #64748b; }
    
    .data-table-modal .name-cell {
      font-weight: 700;
      color: var(--text-main);
    }
    .data-table-modal .value-cell {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      color: var(--primary);
    }
    .data-table-modal .pct-cell {
      font-weight: 600;
    }
    .pct-bar-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pct-bar-track {
      flex: 1;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    .pct-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ea580c 0%, #c2410c 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .pct-bar-label {
      min-width: 45px;
      text-align: right;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-main);
    }
    
    /* Color dot for regions */
    .region-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    /* Modal summary stats */
    .modal-summary {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      flex-wrap: wrap;
    }
    .modal-stat {
      flex: 1;
      min-width: 120px;
      text-align: center;
      padding: 8px;
    }
    .modal-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    .modal-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* --- TABLE --- */
    table.dataTable { width: 100% !important; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
    table.dataTable thead th { background: transparent; padding: 16px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; border-bottom: 2px solid var(--border) !important; text-align: left; }
    table.dataTable tbody td { padding: 20px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; font-weight: 500; }
    table.dataTable tbody tr:hover { background-color: #fff7ed !important; transform: scale(1.005); box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-radius: 8px; }
    .badge-pill { padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .badge-geo { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .badge-prov { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .money-cell { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); font-size: 15px; }

    /* --- LOADING --- */
    #loading { position: fixed; inset: 0; background: #fffaf5; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease; }
    .loader-container { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; }
    .loader-ring { position: absolute; inset: 0; border: 4px solid rgba(194, 65, 12, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .loader-icon { font-size: 32px; color: var(--primary); animation: pulseIcon 2s infinite ease-in-out; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulseIcon { 0%, 100% { transform: scale(0.8); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }

    /* --- ALERTS SECTION (Minimal Design) --- */
    .alerts-container {
      display: none;
      margin-bottom: 20px;
    }
    .alerts-container.visible {
      display: block;
    }
    .alerts-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    /* Alert pill badges */
    .alert-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: default;
    }
    .alert-pill:hover {
      transform: translateY(-1px);
    }
    .alert-pill i {
      font-size: 14px;
    }
    
    /* Alert Types - Subtle colors */
    .alert-pill.critical {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    .alert-pill.warning {
      background: #fffbeb;
      color: #d97706;
      border: 1px solid #fde68a;
    }
    .alert-pill.success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }
    .alert-pill.info {
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }

    /* --- YOY COMPARISON BAR --- */
    .yoy-bar-container {
      margin-top: 8px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    .yoy-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .yoy-bar-track {
      position: relative;
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }
    .yoy-bar-prev {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #94a3b8 0%, #64748b 100%);
      border-radius: 12px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }
    .yoy-bar-curr {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #ea580c 0%, #c2410c 100%);
      border-radius: 12px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transition-delay: 0.2s;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      box-shadow: 2px 0 8px rgba(194, 65, 12, 0.3);
    }
    .yoy-bar-target {
      position: absolute;
      top: -4px;
      bottom: -4px;
      width: 3px;
      background: #15803d;
      border-radius: 2px;
      transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 8px rgba(21, 128, 61, 0.4);
    }
    .yoy-bar-target::after {
      content: 'OBJ';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      font-weight: 700;
      color: #15803d;
      white-space: nowrap;
    }
    .yoy-bar-value {
      font-size: 10px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .yoy-legend {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 11px;
    }
    .yoy-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .yoy-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .yoy-dot-prev { background: #64748b; }
    .yoy-dot-curr { background: #c2410c; }
    .yoy-dot-target { background: #15803d; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="loader-container">
        <div class="loader-ring"></div>
        <i class="ri-pie-chart-2-fill loader-icon"></i>
    </div>
    <p style="margin-top:20px; font-weight:700; color:var(--primary); letter-spacing:1px; text-transform:uppercase; font-size:12px;">Analisi Dati in corso...</p>
  </div>

  <header>
    <div class="container header-inner">
      <div class="brand">
        <img src="https://www.cottocusimano.com/Resources/dashboard-agenti/logo-cusimano-nero-area-riservata.png" alt="Cotto Cusimano" class="logo-img">
        <div>
          <h1 class="h-title">Cotto Cusimano</h1>
          <div class="h-sub">Analytics Hub</div>
        </div>
      </div>
      
      <div class="controls">
        <div class="select-wrapper">
            <select id="selAgente"><option value="">Tutti gli Agenti</option></select>
            <i class="ri-user-3-line sel-arrow"></i>
        </div>
        
        <div class="select-wrapper">
            <select id="selRegione">
                <option value="">Filtra Regione</option> 
            </select>
            <i class="ri-map-2-line sel-arrow"></i>
            <span id="hintRegione" class="filter-hint"></span>
        </div>

        <div class="select-wrapper">
            <select id="selProvincia"><option value="">Tutte le Province</option></select>
            <i class="ri-map-pin-range-line sel-arrow"></i>
            <span id="hintProvincia" class="filter-hint"></span>
        </div>

        <button class="btn btn-reset" id="btnReset"><i class="ri-refresh-line"></i> Reset</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <!-- ALERT SECTION - Minimal pills -->
    <div id="alertsSection" class="alerts-container animate-in" style="animation-delay: 0.05s;">
      <div class="alerts-strip" id="alertsStrip">
        <!-- Alert pills injected here -->
      </div>
    </div>

    <div class="grid-kpi animate-in" style="animation-delay: 0.1s">
      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Fatturato Totale</span>
          <div class="kpi-icon-wrap"><i class="ri-money-euro-circle-line"></i></div>
        </div>
        <div class="kpi-body">
            <div class="kpi-val-row">
                <div class="kpi-val" id="kpiFatturato">€ 0</div>
                <div id="kpiTrendFatt" class="trend-badge trend-neutral" style="display:none"></div>
            </div>
            <div class="kpi-prev-row">
                <span>Anno Prec:</span>
                <span id="kpiFatturatoPrev" class="kpi-prev-num">€ 0</span>
            </div>
            <!-- YOY Comparison Bar -->
            <div class="yoy-bar-container" id="yoyBarFatt">
              <div class="yoy-bar-labels">
                <span>0</span>
                <span id="yoyMaxLabel">€ 0</span>
              </div>
              <div class="yoy-bar-track">
                <div class="yoy-bar-prev" id="yoyBarPrev" style="width: 0%">
                  <span class="yoy-bar-value" id="yoyValPrev"></span>
                </div>
                <div class="yoy-bar-curr" id="yoyBarCurr" style="width: 0%">
                  <span class="yoy-bar-value" id="yoyValCurr"></span>
                </div>
                <div class="yoy-bar-target" id="yoyBarTarget" style="left: 0%"></div>
              </div>
              <div class="yoy-legend">
                <div class="yoy-legend-item"><div class="yoy-dot yoy-dot-prev"></div><span>Anno Prec.</span></div>
                <div class="yoy-legend-item"><div class="yoy-dot yoy-dot-curr"></div><span>Anno Corr.</span></div>
                <div class="yoy-legend-item"><div class="yoy-dot yoy-dot-target"></div><span>Obiettivo</span></div>
              </div>
            </div>
        </div>
      </div>
      
      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Clienti Attivi</span>
          <div class="kpi-icon-wrap"><i class="ri-building-2-line"></i></div>
        </div>
        <div class="kpi-body">
            <div class="kpi-val-row">
                <div class="kpi-val" id="kpiClienti">0</div>
                <div id="kpiTrendCli" class="trend-badge trend-neutral" style="display:none"></div>
            </div>
            <div class="kpi-prev-row">
                <span>Anno Prec:</span>
                <span id="kpiClientiPrev" class="kpi-prev-num">0</span>
            </div>
        </div>
      </div>

      <div class="card">
        <div class="kpi-head">
          <span class="kpi-label">Obiettivo Annuale</span>
          <div class="kpi-icon-wrap"><i class="ri-focus-3-line"></i></div>
        </div>
        <div class="kpi-body">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; width:100%">
                <div>
                   <div class="kpi-val" id="kpiTargetVal">0%</div>
                   <div class="kpi-sub" style="font-size:12px; color:var(--text-muted)">Completamento</div>
                </div>
                <div id="miniRadial" style="margin-bottom:-10px; margin-right:-10px"></div>
            </div>
        </div>
      </div>
      
      <div class="card card-dark">
        <div class="kpi-head">
          <span class="kpi-label">Top Performer</span>
          <div class="kpi-icon-wrap"><i class="ri-trophy-fill"></i></div>
        </div>
        <div class="kpi-body">
            <div id="kpiTopAgent" class="kpi-val" style="font-size:18px; margin-bottom:2px">--</div>
            <div id="kpiTopAgentVal" class="money-gold">€ 0</div>
        </div>
      </div>
    </div>

    <div class="grid-charts animate-in" style="animation-delay: 0.2s">
      <div class="card">
        <div class="chart-header">
          <h3 class="chart-title">Classifica Agenti</h3>
          <div class="chart-header-right">
            <span class="chart-badge">Fatturato</span>
            <button class="btn-expand" onclick="openAgentiModal()" title="Espandi tutti i dati">
              <i class="ri-fullscreen-line"></i>
            </button>
          </div>
        </div>
        <div id="chartBar"></div>
      </div>
      <div class="card">
        <div class="chart-header">
          <h3 class="chart-title">Macro Aree</h3>
          <div class="chart-header-right">
            <span class="chart-badge">Geografia</span>
            <button class="btn-expand" onclick="openRegioniModal()" title="Espandi tutti i dati">
              <i class="ri-fullscreen-line"></i>
            </button>
          </div>
        </div>
        <div id="chartDonut" style="display:flex; justify-content:center; align-items:center; height:100%"></div>
      </div>
    </div>

    <div class="grid-charts-rev animate-in" style="animation-delay: 0.3s">
      <div class="card">
        <div class="chart-header">
          <h3 class="chart-title">Peso Province</h3>
          <div class="chart-header-right">
            <span class="chart-badge">Impatto %</span>
            <button class="btn-expand" onclick="openProvinceModal()" title="Espandi tutti i dati">
              <i class="ri-fullscreen-line"></i>
            </button>
          </div>
        </div>
        <div id="chartPolar" style="display:flex; justify-content:center"></div>
      </div>
      <div class="card">
        <div class="chart-header">
          <h3 class="chart-title">Top 5 Clienti</h3>
          <span class="chart-badge">Strategici</span>
        </div>
        <div id="chartClients"></div>
      </div>
    </div>

    <div class="grid-split animate-in" style="animation-delay: 0.35s">
      
      <div class="card">
        <div class="chart-header">
          <div>
            <h3 class="chart-title">Top 5 Regioni</h3>
            <div style="font-size:12px; color:var(--text-muted); font-weight:500">Mappa Valore Geografico</div>
          </div>
          <span class="chart-badge" style="background:#fff1f2; color:#e11d48">Leaderboard</span>
        </div>
        <div class="chart-desc">
            Visualizza le 5 regioni che guidano il fatturato. La dimensione dei blocchi indica il <strong>volume di affari</strong>.
        </div>
        <div id="chartMap"></div>
      </div>

      <div class="card">
        <div class="chart-header">
          <div>
            <h3 class="chart-title">Salute Obiettivi</h3>
            <div style="font-size:12px; color:var(--text-muted); font-weight:500">Distribuzione Performance Rete</div>
          </div>
          <span class="chart-badge" style="background:#ecfccb; color:#3f6212">Target</span>
        </div>
        <div class="chart-desc">
          Mostra la <strong>qualità</strong> del risultato. Evita che i "Top Performer" nascondano le difficoltà della massa. <br>
          <span style="font-weight:600; color:var(--primary)"><i class="ri-cursor-line"></i> Clicca su una colonna per vedere i dettagli.</span>
        </div>
        <div id="chartHisto"></div>
      </div>
  
    </div>

    <div class="card animate-in" style="animation-delay: 0.4s">
      <div class="chart-header">
        <h3 class="chart-title">Dettaglio Transazioni</h3>
        <div style="margin-left:auto; font-size:12px; color:var(--text-muted)">Ultimi dati sync</div>
      </div>
      <table id="tbl" class="display hover" style="width:100%"></table>
    </div>

    <div style="text-align:center; margin-top:60px; font-size:12px; color:var(--text-muted); font-weight:500">
      Cotto Cusimano Analytics System • Aggiornato: <span id="lastUpdate" style="color:var(--primary)">--</span>
    </div>

  </div>

  <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
          <div class="modal-header">
              <div class="modal-title" id="modalTitle">Titolo</div>
              <button class="btn-close-modal" onclick="forceCloseModal()"><i class="ri-close-line"></i></button>
          </div>
          <div class="modal-body" id="modalBody">
              </div>
      </div>
  </div>

  <!-- Modal Espanso per Dati Completi -->
  <div id="expandedModal" class="modal-overlay modal-lg" onclick="closeExpandedModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
          <div class="modal-header">
              <div class="modal-title" id="expandedModalTitle">Dati Completi</div>
              <button class="btn-close-modal" onclick="forceCloseExpandedModal()"><i class="ri-close-line"></i></button>
          </div>
          <div class="modal-body" id="expandedModalBody" style="max-height: 70vh; overflow-y: auto;">
          </div>
      </div>
  </div>

  <script>
    // --- CONFIGURAZIONE ---
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const fmtNum = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 }); 
    const asNum = v => (typeof v === 'number') ? v : Number((v||"0").toString().replace(/\./g, '').replace(',', '.') || 0);

    const GEO_DATA = {
      'AG':{n:'Agrigento',r:'Sicilia'}, 'AL':{n:'Alessandria',r:'Piemonte'}, 'AN':{n:'Ancona',r:'Marche'}, 'AO':{n:'Aosta',r:'Valle d\'Aosta'}, 
      'AR':{n:'Arezzo',r:'Toscana'}, 'AP':{n:'Ascoli Piceno',r:'Marche'}, 'AT':{n:'Asti',r:'Piemonte'}, 'AV':{n:'Avellino',r:'Campania'}, 
      'BA':{n:'Bari',r:'Puglia'}, 'BT':{n:'Barletta-Andria-Trani',r:'Puglia'}, 'BL':{n:'Belluno',r:'Veneto'}, 'BN':{n:'Benevento',r:'Campania'}, 
      'BG':{n:'Bergamo',r:'Lombardia'}, 'BI':{n:'Biella',r:'Piemonte'}, 'BO':{n:'Bologna',r:'Emilia-Romagna'}, 'BZ':{n:'Bolzano',r:'Trentino-Alto Adige'}, 
      'BS':{n:'Brescia',r:'Lombardia'}, 'BR':{n:'Brindisi',r:'Puglia'}, 'CA':{n:'Cagliari',r:'Sardegna'}, 'CL':{n:'Caltanissetta',r:'Sicilia'}, 
      'CB':{n:'Campobasso',r:'Molise'}, 'CI':{n:'Carbonia-Iglesias',r:'Sardegna'}, 'CE':{n:'Caserta',r:'Campania'}, 'CT':{n:'Catania',r:'Sicilia'}, 
      'CZ':{n:'Catanzaro',r:'Calabria'}, 'CH':{n:'Chieti',r:'Abruzzo'}, 'CO':{n:'Como',r:'Lombardia'}, 'CS':{n:'Cosenza',r:'Calabria'}, 
      'CR':{n:'Cremona',r:'Lombardia'}, 'KR':{n:'Crotone',r:'Calabria'}, 'CN':{n:'Cuneo',r:'Piemonte'}, 'EN':{n:'Enna',r:'Sicilia'}, 
      'FM':{n:'Fermo',r:'Marche'}, 'FE':{n:'Ferrara',r:'Emilia-Romagna'}, 'FI':{n:'Firenze',r:'Toscana'}, 'FG':{n:'Foggia',r:'Puglia'}, 
      'FC':{n:'Forlì-Cesena',r:'Emilia-Romagna'}, 'FR':{n:'Frosinone',r:'Lazio'}, 'GE':{n:'Genova',r:'Liguria'}, 'GO':{n:'Gorizia',r:'Friuli-Venezia Giulia'}, 
      'GR':{n:'Grosseto',r:'Toscana'}, 'IM':{n:'Imperia',r:'Liguria'}, 'IS':{n:'Isernia',r:'Molise'}, 'SP':{n:'La Spezia',r:'Liguria'}, 
      'AQ':{n:'L\'Aquila',r:'Abruzzo'}, 'LT':{n:'Latina',r:'Lazio'}, 'LE':{n:'Lecce',r:'Puglia'}, 'LC':{n:'Lecco',r:'Lombardia'}, 
      'LI':{n:'Livorno',r:'Toscana'}, 'LO':{n:'Lodi',r:'Lombardia'}, 'LU':{n:'Lucca',r:'Toscana'}, 'MC':{n:'Macerata',r:'Marche'}, 
      'MN':{n:'Mantova',r:'Lombardia'}, 'MS':{n:'Massa-Carrara',r:'Toscana'}, 'MT':{n:'Matera',r:'Basilicata'}, 'VS':{n:'Medio Campidano',r:'Sardegna'}, 
      'ME':{n:'Messina',r:'Sicilia'}, 'MI':{n:'Milano',r:'Lombardia'}, 'MO':{n:'Modena',r:'Emilia-Romagna'}, 'MB':{n:'Monza e Brianza',r:'Lombardia'}, 
      'NA':{n:'Napoli',r:'Campania'}, 'NO':{n:'Novara',r:'Piemonte'}, 'NU':{n:'Nuoro',r:'Sardegna'}, 'OG':{n:'Ogliastra',r:'Sardegna'}, 
      'OT':{n:'Olbia-Tempio',r:'Sardegna'}, 'OR':{n:'Oristano',r:'Sardegna'}, 'PD':{n:'Padova',r:'Veneto'}, 'PA':{n:'Palermo',r:'Sicilia'}, 
      'PR':{n:'Parma',r:'Emilia-Romagna'}, 'PV':{n:'Pavia',r:'Lombardia'}, 'PG':{n:'Perugia',r:'Umbria'}, 'PU':{n:'Pesaro e Urbino',r:'Marche'}, 
      'PE':{n:'Pescara',r:'Abruzzo'}, 'PC':{n:'Piacenza',r:'Emilia-Romagna'}, 'PI':{n:'Pisa',r:'Toscana'}, 'PT':{n:'Pistoia',r:'Toscana'}, 
      'PN':{n:'Pordenone',r:'Friuli-Venezia Giulia'}, 'PZ':{n:'Potenza',r:'Basilicata'}, 'PO':{n:'Prato',r:'Toscana'}, 'RG':{n:'Ragusa',r:'Sicilia'}, 
      'RA':{n:'Ravenna',r:'Emilia-Romagna'}, 'RC':{n:'Reggio Calabria',r:'Calabria'}, 'RE':{n:'Reggio Emilia',r:'Emilia-Romagna'}, 'RI':{n:'Rieti',r:'Lazio'}, 
      'RN':{n:'Rimini',r:'Emilia-Romagna'}, 'RM':{n:'Roma',r:'Lazio'}, 'RO':{n:'Rovigo',r:'Veneto'}, 'SA':{n:'Salerno',r:'Campania'}, 
      'SS':{n:'Sassari',r:'Sardegna'}, 'SV':{n:'Savona',r:'Liguria'}, 'SI':{n:'Siena',r:'Toscana'}, 'SR':{n:'Siracusa',r:'Sicilia'}, 
      'SO':{n:'Sondrio',r:'Lombardia'}, 'TA':{n:'Taranto',r:'Puglia'}, 'TE':{n:'Teramo',r:'Abruzzo'}, 'TR':{n:'Terni',r:'Umbria'}, 
      'TO':{n:'Torino',r:'Piemonte'}, 'TP':{n:'Trapani',r:'Sicilia'}, 'TN':{n:'Trento',r:'Trentino-Alto Adige'}, 'TV':{n:'Treviso',r:'Veneto'}, 
      'TS':{n:'Trieste',r:'Friuli-Venezia Giulia'}, 'UD':{n:'Udine',r:'Friuli-Venezia Giulia'}, 'VA':{n:'Varese',r:'Lombardia'}, 'VE':{n:'Venezia',r:'Veneto'}, 
      'VB':{n:'Verbano-Cusio-Ossola',r:'Piemonte'}, 'VC':{n:'Vercelli',r:'Piemonte'}, 'VR':{n:'Verona',r:'Veneto'}, 'VV':{n:'Vibo Valentia',r:'Calabria'}, 
      'VI':{n:'Vicenza',r:'Veneto'}, 'VT':{n:'Viterbo',r:'Lazio'}
    };

    // --- STATE ---
    let state = { all: [], rows: [] };
    let charts = { bar: null, donut: null, radial: null, clients: null, polar: null, map: null, histo: null };
    let dataTable = null;
    let agentPerformanceData = [];
    
    // Mappa regione -> province (per filtri a cascata)
    let regioneProvinceMap = {};
    let allProvince = [];
    
    // Dati completi per modal espansi
    let fullAgentiData = [];
    let fullRegioniData = [];
    let fullProvinceData = [];

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            if(!res.ok) throw new Error("Errore caricamento dati");
            const data = await res.json();

            // NORMALIZZAZIONE DATI
            state.all = (data.rows || []).map(r => {
                if(r.Provincia) {
                    const code = r.Provincia.trim().toUpperCase();
                    if(code === 'GENERALE') {
                        r.Provincia = 'Generale'; r.Regione = 'Altro'; 
                    } else {
                        const geo = GEO_DATA[code];
                        if(geo) { r.Provincia = geo.n; r.Regione = geo.r; } 
                        else { r.Regione = 'Altro'; }
                    }
                } else { r.Regione = 'N/D'; }
                return r;
            });
            state.rows = [...state.all];
            
            if(data.updatedAt) document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString();
            
            const loader = document.getElementById('loading');
            loader.style.opacity = '0';
            setTimeout(()=>loader.remove(), 500);

            buildRegionProvinceMap();
            buildAgenteAreasMap();
            populateFilters();
            initCharts();
            updateDashboard();

        } catch (err) {
            document.getElementById('loading').innerHTML = `<h3 style="color:#c2410c">Errore Connessione</h3><p>${err.message}</p>`;
        }

        // Event Listeners
        document.getElementById('selAgente').addEventListener('change', handleAgenteChange);
        document.getElementById('selRegione').addEventListener('change', handleRegioneChange);
        document.getElementById('selProvincia').addEventListener('change', applyFilters);
        document.getElementById('btnReset').addEventListener('click', resetFilters);
    });

    // Mappa agente -> { regioni: [], province: [] }
    let agenteAreasMap = {};

    // --- FILTRI A CASCATA ---
    function buildRegionProvinceMap() {
        regioneProvinceMap = {};
        allProvince = [];
        
        state.all.forEach(r => {
            const prov = (r.Provincia || '').trim();
            const reg = r.Regione;
            
            if(prov && prov !== 'Generale' && reg && reg !== 'N/D' && reg !== 'Altro') {
                if(!regioneProvinceMap[reg]) regioneProvinceMap[reg] = new Set();
                regioneProvinceMap[reg].add(prov);
                if(!allProvince.includes(prov)) allProvince.push(prov);
            }
        });
        
        // Converti Set in Array ordinati
        Object.keys(regioneProvinceMap).forEach(reg => {
            regioneProvinceMap[reg] = [...regioneProvinceMap[reg]].sort();
        });
        allProvince.sort();
    }

    function buildAgenteAreasMap() {
        agenteAreasMap = {};
        
        state.all.forEach(r => {
            const agente = (r.Agente_Nome || r.Agente_Codice || '').trim();
            const prov = (r.Provincia || '').trim();
            const reg = r.Regione;
            
            if(!agente) return;
            
            if(!agenteAreasMap[agente]) {
                agenteAreasMap[agente] = { regioni: new Set(), province: new Set() };
            }
            
            if(reg && reg !== 'N/D' && reg !== 'Altro') {
                agenteAreasMap[agente].regioni.add(reg);
            }
            if(prov && prov !== 'Generale') {
                agenteAreasMap[agente].province.add(prov);
            }
        });
        
        // Converti Set in Array ordinati
        Object.keys(agenteAreasMap).forEach(ag => {
            agenteAreasMap[ag].regioni = [...agenteAreasMap[ag].regioni].sort();
            agenteAreasMap[ag].province = [...agenteAreasMap[ag].province].sort();
        });
    }

    function populateFilters() {
        const agenti = [...new Set(state.all.map(r => (r.Agente_Nome || r.Agente_Codice || '').trim()))].filter(Boolean).sort();
        const regioni = Object.keys(regioneProvinceMap).sort();
        
        const sA = document.getElementById('selAgente');
        const sR = document.getElementById('selRegione');
        
        sA.innerHTML='<option value="">Tutti gli Agenti</option>';
        sR.innerHTML='<option value="">Filtra Regione</option>';

        agenti.forEach(a => sA.add(new Option(a, a)));
        regioni.forEach(r => sR.add(new Option(r, r)));
        
        // Popola province iniziali (tutte)
        updateProvinceDropdown();
        updateRegioneDropdown();
    }

    function handleAgenteChange() {
        const ag = document.getElementById('selAgente').value;
        
        // Reset regione e provincia quando cambia agente
        document.getElementById('selRegione').value = '';
        document.getElementById('selProvincia').value = '';
        document.getElementById('hintRegione').classList.remove('visible');
        document.getElementById('hintProvincia').classList.remove('visible');
        
        // Aggiorna i dropdown in base all'agente selezionato
        updateRegioneDropdown(ag);
        updateProvinceDropdown('', ag);
        
        applyFilters();
    }

    function updateRegioneDropdown(selectedAgente = '') {
        const sR = document.getElementById('selRegione');
        const currentVal = sR.value;
        
        sR.innerHTML = '<option value="">Filtra Regione</option>';
        
        let regioniToShow = [];
        
        if(selectedAgente && agenteAreasMap[selectedAgente]) {
            regioniToShow = agenteAreasMap[selectedAgente].regioni;
        } else {
            regioniToShow = Object.keys(regioneProvinceMap).sort();
        }
        
        regioniToShow.forEach(r => sR.add(new Option(r, r)));
        
        // Se la regione precedente è ancora valida, mantienila
        if(currentVal && regioniToShow.includes(currentVal)) {
            sR.value = currentVal;
        }
    }

    function updateProvinceDropdown(selectedRegione = '', selectedAgente = '') {
        const sP = document.getElementById('selProvincia');
        const hintProv = document.getElementById('hintProvincia');
        const currentVal = sP.value;
        
        // Se non passiamo l'agente, prendiamolo dal dropdown
        if(!selectedAgente) {
            selectedAgente = document.getElementById('selAgente').value;
        }
        
        sP.innerHTML = '<option value="">Tutte le Province</option>';
        
        let provinceToShow = [];
        
        // Prima filtro per agente se selezionato
        if(selectedAgente && agenteAreasMap[selectedAgente]) {
            provinceToShow = [...agenteAreasMap[selectedAgente].province];
            
            // Poi filtro ulteriormente per regione se selezionata
            if(selectedRegione && regioneProvinceMap[selectedRegione]) {
                const provinceRegione = regioneProvinceMap[selectedRegione];
                provinceToShow = provinceToShow.filter(p => provinceRegione.includes(p));
            }
        } else if(selectedRegione && regioneProvinceMap[selectedRegione]) {
            // Solo filtro regione
            provinceToShow = regioneProvinceMap[selectedRegione];
        } else {
            // Tutte le province
            provinceToShow = allProvince;
        }
        
        // Hint
        if(provinceToShow.length < allProvince.length && provinceToShow.length > 0) {
            hintProv.textContent = `${provinceToShow.length} province`;
            hintProv.classList.add('visible');
        } else {
            hintProv.classList.remove('visible');
        }
        
        provinceToShow.sort().forEach(p => sP.add(new Option(p, p)));
        
        // Se la provincia precedente è ancora valida, mantienila
        if(currentVal && provinceToShow.includes(currentVal)) {
            sP.value = currentVal;
        }
    }

    function handleRegioneChange() {
        const reg = document.getElementById('selRegione').value;
        const ag = document.getElementById('selAgente').value;
        const hintReg = document.getElementById('hintRegione');
        
        // Aggiorna hint regione
        if(reg && regioneProvinceMap[reg]) {
            let numProv = regioneProvinceMap[reg].length;
            // Se c'è un agente selezionato, conta solo le sue province in quella regione
            if(ag && agenteAreasMap[ag]) {
                const agenteProv = agenteAreasMap[ag].province;
                numProv = regioneProvinceMap[reg].filter(p => agenteProv.includes(p)).length;
            }
            hintReg.textContent = `${numProv} prov.`;
            hintReg.classList.add('visible');
        } else {
            hintReg.classList.remove('visible');
        }
        
        // Aggiorna dropdown province (considera anche agente)
        updateProvinceDropdown(reg, ag);
        
        // Reset provincia se non più valida
        const sP = document.getElementById('selProvincia');
        if(sP.value) {
            const options = Array.from(sP.options).map(o => o.value);
            if(!options.includes(sP.value)) {
                sP.value = '';
            }
        }
        
        applyFilters();
    }

    function resetFilters() {
        document.getElementById('selAgente').value = "";
        document.getElementById('selRegione').value = "";
        document.getElementById('selProvincia').value = "";
        document.getElementById('hintRegione').classList.remove('visible');
        document.getElementById('hintProvincia').classList.remove('visible');
        
        // Ripopola i dropdown con tutti i valori
        updateRegioneDropdown();
        updateProvinceDropdown();
        
        applyFilters();
    }

    function applyFilters() { updateDashboard(); }

    // --- ANIMAZIONE COUNT-UP KPI ---
    function animateValue(element, start, end, duration = 600, formatter = null) {
        const startTime = performance.now();
        const diff = end - start;
        
        element.classList.add('animating');
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing: easeOutCubic
            const easeProgress = 1 - Math.pow(1 - progress, 3);
            const current = start + (diff * easeProgress);
            
            if(formatter) {
                element.textContent = formatter(current);
            } else {
                element.textContent = Math.round(current);
            }
            
            if(progress < 1) {
                requestAnimationFrame(update);
            } else {
                element.classList.remove('animating');
            }
        }
        
        requestAnimationFrame(update);
    }

    // Store previous values for animation
    let prevKpiValues = {
        fatturato: 0,
        fatturatoPrev: 0,
        clienti: 0,
        clientiPrev: 0,
        target: 0,
        obiettivo: 0
    };

    function updateDashboard() {
        const ag = document.getElementById('selAgente').value;
        const reg = document.getElementById('selRegione').value;
        const pr = document.getElementById('selProvincia').value;

        // 1. Filtro Dati Vendite
        const venditeData = state.all.filter(r => {
            if (r.Tipo_Dato !== 'VENDITE_CLIENTE') return false;
            const rAg = (r.Agente_Nome || r.Agente_Codice || '').trim();
            return (!ag || rAg === ag) && (!reg || r.Regione === reg) && (!pr || (r.Provincia||'').trim() === pr);
        });

        // 2. Filtro Dati Obiettivi
        const hasGeoFilter = reg || pr;
        const obiettiviData = state.all.filter(r => {
            if (r.Tipo_Dato !== 'OBIETTIVI') return false;
            const rAg = (r.Agente_Nome || r.Agente_Codice || '').trim();
            if (ag && rAg !== ag) return false;
            if (!hasGeoFilter) return r.Provincia === 'Generale';
            else {
                if (r.Provincia === 'Generale') return false;
                if (reg && r.Regione !== reg) return false;
                if (pr && (r.Provincia||'').trim() !== pr) return false;
                return true;
            }
        });

        // KPI Calculations
        let fatturatoCorrente = 0, fatturatoPrecedente = 0, targetTotale = 0, cliCorrente = 0, cliPrecedente = 0;
        obiettiviData.forEach(r => {
            fatturatoCorrente += asNum(r.Anno_Corrente);
            fatturatoPrecedente += asNum(r.Anno_Precedente);
            targetTotale += asNum(r.Obiettivo);
            cliCorrente += asNum(r.Clienti_Anno_Corrente);
            cliPrecedente += asNum(r.Clienti_Anno_Precedente);
        });
        if (obiettiviData.length === 0 && venditeData.length > 0) {
             fatturatoCorrente = venditeData.reduce((a,b) => a + asNum(b.Fatturato), 0);
             cliCorrente = new Set(venditeData.map(r => r.Ragione_Sociale_Cliente)).size;
        }

        // Animate KPI - Fatturato
        const kpiFattEl = document.getElementById('kpiFatturato');
        animateValue(kpiFattEl, prevKpiValues.fatturato, fatturatoCorrente, 800, (v) => fmtEUR.format(v));
        prevKpiValues.fatturato = fatturatoCorrente;

        const kpiFattPrevEl = document.getElementById('kpiFatturatoPrev');
        animateValue(kpiFattPrevEl, prevKpiValues.fatturatoPrev, fatturatoPrecedente, 800, (v) => fmtEUR.format(v));
        prevKpiValues.fatturatoPrev = fatturatoPrecedente;

        // Trend badge fatturato
        const kpiTrendFatt = document.getElementById('kpiTrendFatt');
        if (fatturatoPrecedente > 0) {
            const deltaEur = fatturatoCorrente - fatturatoPrecedente;
            const deltaPct = ((deltaEur) / fatturatoPrecedente) * 100;
            const isPos = deltaEur >= 0;
            kpiTrendFatt.style.display = 'inline-flex';
            kpiTrendFatt.className = `trend-badge ${isPos ? 'trend-up' : 'trend-down'}`;
            kpiTrendFatt.innerHTML = `<i class="${isPos ? 'ri-arrow-up-line' : 'ri-arrow-down-line'}"></i><span class="trend-val-abs">${isPos?'+':''}€ ${fmtNum.format(deltaEur)}</span><span class="trend-sep">|</span><span>${Math.abs(deltaPct).toFixed(1)}%</span>`;
        } else { kpiTrendFatt.style.display = 'none'; }

        // --- YOY COMPARISON BAR ---
        updateYoYBar(fatturatoCorrente, fatturatoPrecedente, targetTotale);

        // Animate KPI - Clienti
        const kpiCliEl = document.getElementById('kpiClienti');
        animateValue(kpiCliEl, prevKpiValues.clienti, cliCorrente, 800);
        prevKpiValues.clienti = cliCorrente;

        const kpiCliPrevEl = document.getElementById('kpiClientiPrev');
        animateValue(kpiCliPrevEl, prevKpiValues.clientiPrev, cliPrecedente, 800);
        prevKpiValues.clientiPrev = cliPrecedente;

        // Trend badge clienti
        const kpiTrendCli = document.getElementById('kpiTrendCli');
        if (cliPrecedente > 0) {
            const deltaCli = cliCorrente - cliPrecedente;
            const deltaCliPct = ((deltaCli) / cliPrecedente) * 100;
            const isPosCli = deltaCli >= 0;
            kpiTrendCli.style.display = 'inline-flex';
            kpiTrendCli.className = `trend-badge ${isPosCli ? 'trend-up' : 'trend-down'}`;
            kpiTrendCli.innerHTML = `<i class="${isPosCli ? 'ri-arrow-up-line' : 'ri-arrow-down-line'}"></i><span class="trend-val-abs">${isPosCli?'+':''}${deltaCli}</span><span class="trend-sep">|</span><span>${Math.abs(deltaCliPct).toFixed(1)}%</span>`;
        } else { kpiTrendCli.style.display = 'none'; }

        // Target %
        let pctTarget = 0; if(targetTotale > 0) pctTarget = (fatturatoCorrente / targetTotale) * 100;
        charts.radial.updateSeries([pctTarget]);
        
        const kpiTargetEl = document.getElementById('kpiTargetVal');
        animateValue(kpiTargetEl, prevKpiValues.target, pctTarget, 800, (v) => v.toFixed(1) + "%");
        prevKpiValues.target = pctTarget;

        // Top Agent
        const agMap = {};
        obiettiviData.forEach(r => { const k = r.Agente_Nome || 'N/D'; agMap[k] = (agMap[k]||0) + asNum(r.Anno_Corrente); });
        if (Object.keys(agMap).length === 0) { venditeData.forEach(r => { const k = r.Agente_Nome || 'N/D'; agMap[k] = (agMap[k]||0) + asNum(r.Fatturato); }); }
        const top = Object.entries(agMap).sort((a,b)=>b[1]-a[1])[0];
        if(top) { document.getElementById('kpiTopAgent').textContent = top[0]; document.getElementById('kpiTopAgentVal').textContent = fmtEUR.format(top[1]); }
        else { document.getElementById('kpiTopAgent').textContent = "—"; document.getElementById('kpiTopAgentVal').textContent = "€ 0"; }

        // Standard Charts Updates - SALVA DATI COMPLETI PER MODAL
        const agSortedFull = Object.entries(agMap).sort((a,b)=>b[1]-a[1]);
        fullAgentiData = agSortedFull.map(([name, val], idx) => ({ rank: idx + 1, name, value: val }));
        
        const agSorted = agSortedFull.slice(0,10);
        charts.bar.updateOptions({ xaxis: { categories: agSorted.map(x=>x[0]) } });
        charts.bar.updateSeries([{ data: agSorted.map(x=>x[1]) }]);

        let sourceDataForCharts = venditeData;
        if (sourceDataForCharts.length < 5) {
             sourceDataForCharts = state.all.filter(r => r.Tipo_Dato === 'OBIETTIVI' && r.Provincia !== 'Generale');
             if(ag) sourceDataForCharts = sourceDataForCharts.filter(r=>(r.Agente_Nome||'').trim()===ag);
        }
        const prMap = {}; const regMap = {};
        sourceDataForCharts.forEach(r => {
            const p = (r.Provincia||'?').trim(); const val = asNum(r.Fatturato || r.Anno_Corrente); 
            prMap[p] = (prMap[p]||0) + val; regMap[r.Regione||'Altro'] = (regMap[r.Regione||'Altro']||0) + val;
        });
        
        // SALVA DATI COMPLETI REGIONI PER MODAL
        const regSortedFull = Object.entries(regMap).sort((a,b)=>b[1]-a[1]);
        const totalRegioni = regSortedFull.reduce((sum, [,val]) => sum + val, 0);
        fullRegioniData = regSortedFull.map(([name, val], idx) => ({ 
            rank: idx + 1, 
            name, 
            value: val, 
            pct: totalRegioni > 0 ? (val / totalRegioni * 100) : 0 
        }));
        
        const regSorted = regSortedFull;
        charts.donut.updateOptions({ labels: regSorted.map(x=>x[0]) }); charts.donut.updateSeries(regSorted.map(x=>x[1]));
        
        // SALVA DATI COMPLETI PROVINCE PER MODAL
        const prSortedFull = Object.entries(prMap).sort((a,b)=>b[1]-a[1]);
        const totalProvince = prSortedFull.reduce((sum, [,val]) => sum + val, 0);
        fullProvinceData = prSortedFull.map(([name, val], idx) => ({ 
            rank: idx + 1, 
            name, 
            value: val, 
            pct: totalProvince > 0 ? (val / totalProvince * 100) : 0 
        }));
        
        const prSortedPolar = prSortedFull.slice(0,8);
        charts.polar.updateOptions({ labels: prSortedPolar.map(x=>x[0]) }); charts.polar.updateSeries(prSortedPolar.map(x=>x[1]));

        const clMap = {};
        venditeData.forEach(r => { const k = r.Ragione_Sociale_Cliente||'N/D'; clMap[k] = (clMap[k]||0) + asNum(r.Fatturato); });
        const clSorted = Object.entries(clMap).sort((a,b)=>b[1]-a[1]).slice(0,5); 
        charts.clients.updateOptions({ xaxis: { categories: clSorted.map(x=>x[0]) } });
        charts.clients.updateSeries([{ data: clSorted.map(x=>x[1]) }]);

        // --- STRATEGIC CHARTS CALCULATIONS ---
        
        // 1. HISTOGRAMMA (Salute Obiettivi)
        agentPerformanceData = []; 
        let histoCounts = [0, 0, 0, 0]; 
        const objMap = {};
        let objSource = obiettiviData.length > 0 ? obiettiviData : state.all.filter(r => r.Tipo_Dato === 'OBIETTIVI');
        
        objSource.forEach(r => {
            if(r.Provincia === 'Generale' && r.Agente_Nome === 'N/D') return;
            const agName = (r.Agente_Nome || r.Agente_Codice || 'N/D').trim();
            if(!objMap[agName]) objMap[agName] = { curr: 0, target: 0, reg: r.Regione, prov: r.Provincia, cli: asNum(r.Clienti_Anno_Corrente) };
            objMap[agName].curr += asNum(r.Anno_Corrente);
            objMap[agName].target += asNum(r.Obiettivo);
            if(r.Regione && r.Regione !== 'Altro') objMap[agName].reg = r.Regione;
        });

        Object.entries(objMap).forEach(([name, data]) => {
            if(data.target > 0) {
                const pct = (data.curr / data.target) * 100;
                let bucket = 0;
                if(pct >= 100) bucket = 3; else if(pct >= 80) bucket = 2; else if(pct >= 50) bucket = 1;
                histoCounts[bucket]++;
                let avgOrder = data.cli > 0 ? (data.curr / data.cli) : 0;
                agentPerformanceData.push({ 
                    name: name, pct: pct, bucket: bucket, val: data.curr, target: data.target,
                    reg: data.reg || 'N/D', prov: data.prov || 'Generale', cli: data.cli, avg: avgOrder
                });
            }
        });
        charts.histo.updateSeries([{ data: histoCounts }]);

        // 2. TREEMAP (Top 5 Regioni)
        const regionList = Object.entries(regMap).map(([r, val]) => ({ x: r, y: val })).sort((a,b) => b.y - a.y).slice(0, 5);
        charts.map.updateSeries([{ data: regionList }]);

        updateTable(venditeData);
        
        // 3. GENERA ALERT AUTOMATICI
        generateAlerts(fatturatoCorrente, fatturatoPrecedente, targetTotale, histoCounts, fullRegioniData);
    }

    // --- YOY BAR UPDATE ---
    function updateYoYBar(curr, prev, target) {
        const maxVal = Math.max(curr, prev, target, 1);
        const scale = maxVal * 1.15; // 15% padding
        
        const currPct = (curr / scale) * 100;
        const prevPct = (prev / scale) * 100;
        const targetPct = (target / scale) * 100;
        
        document.getElementById('yoyMaxLabel').textContent = fmtEUR.format(scale);
        
        // Animate bars with slight delay
        setTimeout(() => {
            document.getElementById('yoyBarPrev').style.width = prevPct + '%';
            document.getElementById('yoyValPrev').textContent = prev > scale * 0.15 ? (prev/1000).toFixed(0) + 'k' : '';
        }, 100);
        
        setTimeout(() => {
            document.getElementById('yoyBarCurr').style.width = currPct + '%';
            document.getElementById('yoyValCurr').textContent = curr > scale * 0.15 ? (curr/1000).toFixed(0) + 'k' : '';
        }, 300);
        
        setTimeout(() => {
            document.getElementById('yoyBarTarget').style.left = `calc(${targetPct}% - 1.5px)`;
        }, 500);
    }

    // --- ALERT AUTOMATICI (Ricalcolati su dati filtrati) ---
    function generateAlerts(fattCorr, fattPrev, target, histoCounts, regioniData) {
        const alerts = [];
        const ag = document.getElementById('selAgente').value;
        const isFiltered = ag || document.getElementById('selRegione').value || document.getElementById('selProvincia').value;
        
        // Se è selezionato un singolo agente, mostra alert specifici per lui
        if(ag) {
            // Performance vs obiettivo
            if(target > 0) {
                const pct = (fattCorr / target) * 100;
                if(pct >= 100) {
                    alerts.push({ type: 'success', icon: 'ri-trophy-fill', text: `Obiettivo superato: ${pct.toFixed(0)}%` });
                } else if(pct >= 80) {
                    alerts.push({ type: 'info', icon: 'ri-focus-3-line', text: `In target: ${pct.toFixed(0)}% obiettivo` });
                } else if(pct >= 50) {
                    alerts.push({ type: 'warning', icon: 'ri-time-line', text: `In ritardo: ${pct.toFixed(0)}% obiettivo` });
                } else if(pct > 0) {
                    alerts.push({ type: 'critical', icon: 'ri-alert-fill', text: `Critico: solo ${pct.toFixed(0)}% obiettivo` });
                }
            }
            
            // Trend YoY
            if(fattPrev > 0) {
                const delta = ((fattCorr - fattPrev) / fattPrev) * 100;
                if(delta > 10) {
                    alerts.push({ type: 'success', icon: 'ri-arrow-up-line', text: `+${delta.toFixed(0)}% vs anno scorso` });
                } else if(delta < -10) {
                    alerts.push({ type: 'critical', icon: 'ri-arrow-down-line', text: `${delta.toFixed(0)}% vs anno scorso` });
                }
            }
            
            // Aree coperte
            if(regioniData.length === 1) {
                alerts.push({ type: 'info', icon: 'ri-map-pin-line', text: `Opera in ${regioniData[0].name}` });
            } else if(regioniData.length > 1) {
                alerts.push({ type: 'info', icon: 'ri-map-2-line', text: `${regioniData.length} regioni coperte` });
            }
        } else {
            // Vista generale - alert aggregati
            
            // Agenti critici
            if(histoCounts[0] > 0) {
                alerts.push({ type: 'critical', icon: 'ri-alert-fill', text: `${histoCounts[0]} agenti sotto 50%` });
            }
            
            // Star performers
            if(histoCounts[3] > 0) {
                alerts.push({ type: 'success', icon: 'ri-star-fill', text: `${histoCounts[3]} agenti oltre obiettivo` });
            }
            
            // Trend YoY generale
            if(fattPrev > 0) {
                const delta = ((fattCorr - fattPrev) / fattPrev) * 100;
                if(delta > 10) {
                    alerts.push({ type: 'success', icon: 'ri-trending-up-line', text: `Crescita +${delta.toFixed(0)}% YoY` });
                } else if(delta < -10) {
                    alerts.push({ type: 'critical', icon: 'ri-trending-down-line', text: `Calo ${delta.toFixed(0)}% YoY` });
                }
            }
            
            // Obiettivo globale
            if(target > 0) {
                const pct = (fattCorr / target) * 100;
                if(pct >= 100) {
                    alerts.push({ type: 'success', icon: 'ri-trophy-fill', text: `Target raggiunto: ${pct.toFixed(0)}%` });
                } else if(pct < 50) {
                    alerts.push({ type: 'warning', icon: 'ri-focus-3-line', text: `${pct.toFixed(0)}% del target annuale` });
                }
            }
        }
        
        renderAlerts(alerts);
    }
    
    function renderAlerts(alerts) {
        const section = document.getElementById('alertsSection');
        const strip = document.getElementById('alertsStrip');
        
        if(alerts.length === 0) {
            section.classList.remove('visible');
            return;
        }
        
        section.classList.add('visible');
        strip.innerHTML = alerts.map(a => `
            <span class="alert-pill ${a.type}">
                <i class="${a.icon}"></i>
                ${a.text}
            </span>
        `).join('');
    }

    function initCharts() {
        const font = "'Plus Jakarta Sans', sans-serif";
        
        charts.bar = new ApexCharts(document.querySelector("#chartBar"), {
            series: [{ name:'Fatturato', data:[] }],
            chart: { type:'bar', height:340, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'55%', distributed:true } },
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.25, inverseColors: true, opacityFrom: 0.85, opacityTo: 0.85, stops: [50, 0, 100] } },
            colors: ['#c2410c', '#ea580c', '#f97316', '#fdba74', '#94a3b8'],
            legend: { show:false }, dataLabels: { enabled:false }, grid: { show:false },
            xaxis: { labels: { formatter: v => "€ " + (v/1000).toFixed(0) + "k" } },
            tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        }); charts.bar.render();

        charts.donut = new ApexCharts(document.querySelector("#chartDonut"), {
            series: [], labels: [],
            chart: { type:'donut', height:340, fontFamily:font },
            colors: ['#c2410c', '#334155', '#64748b', '#94a3b8', '#cbd5e1'],
            plotOptions: { pie: { donut: { size:'70%', labels:{show:true, name:{fontSize:'12px'}, value:{fontSize:'20px', fontWeight:700}, total:{show:true, label:'TOTALE', color:'#64748b', fontSize:'11px', formatter: w => { const t = w.globals.seriesTotals.reduce((a,b)=>a+b,0); return (t/1000).toFixed(0) + "k"; }}}}} },
            legend: { position:'bottom', markers:{radius:12} }, dataLabels: { enabled:false }, tooltip: { theme:'dark' }
        }); charts.donut.render();

        charts.clients = new ApexCharts(document.querySelector("#chartClients"), {
            series: [{ name:'Acquisti', data:[] }],
            chart: { type:'bar', height:320, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'60%' } },
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.25, inverseColors: true, opacityFrom: 0.9, opacityTo: 0.9, stops: [50, 0, 100] } },
            colors: ['#c2410c'], 
            dataLabels: { enabled:true, formatter: v => "€ " + (v/1000).toFixed(1) + "k", offsetX: 0, style: { colors: ['#fff'], fontSize:'11px', fontWeight:700 } },
            xaxis: { show:false }, grid: { show:false }, tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        }); charts.clients.render();

        charts.polar = new ApexCharts(document.querySelector("#chartPolar"), {
            series: [], labels: [],
            chart: { type: 'polarArea', height: 340, fontFamily: font, toolbar:{show:false} },
            stroke: { colors: ['#fff'], width:1 }, fill: { opacity: 0.9 },
            colors: ['#78350f', '#9a3412', '#c2410c', '#d97706', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
            legend: { position: 'bottom' }, yaxis: { show: false }, tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        }); charts.polar.render();

        charts.radial = new ApexCharts(document.querySelector("#miniRadial"), {
            series: [0], chart: { type:'radialBar', height:130, width:130, sparkline:{enabled:true} },
            plotOptions: { radialBar: { hollow: { size: '50%' }, track: { background: '#ffedd5', strokeWidth: '100%' }, dataLabels: { show: false } } },
            fill: { type: "gradient", gradient: { shade: "dark", type: "horizontal", gradientToColors: ["#fbbf24"], stops: [0, 100] } },
            colors: ['#c2410c'], stroke: { lineCap:'round' }
        }); charts.radial.render();

        // --- TREEMAP ---
        charts.map = new ApexCharts(document.querySelector("#chartMap"), {
            series: [],
            chart: { type: 'treemap', height: 320, fontFamily: font, toolbar: {show: false} },
            colors: ['#c2410c'], 
            plotOptions: { 
                treemap: { 
                    distributed: true, enableShades: true, shadeIntensity: 0.5, reverseNegativeShade: true,
                    dataLabels: { format: 'scale' }
                } 
            },
            dataLabels: { 
                enabled: true, style: { fontSize: '14px', fontWeight: 'bold'}, 
                formatter: function(text, op) { return [text, "€ " + (op.value/1000).toFixed(0) + "k"]; },
                offsetY: -4
            },
            tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.map.render();

        // --- HISTO ---
        charts.histo = new ApexCharts(document.querySelector("#chartHisto"), {
            series: [{ name: 'Agenti', data: [] }],
            chart: { type: 'bar', height: 320, fontFamily: font, toolbar: {show: false}, events: { dataPointSelection: (e, c, cfg) => openModal(cfg.dataPointIndex) } },
            plotOptions: { bar: { borderRadius: 6, columnWidth: '50%', distributed: true, dataLabels: { position: 'top' } } },
            dataLabels: { enabled: true, offsetY: -20, style: { fontSize: '12px', colors: ["#334155"] } },
            legend: { show: false }, colors: ['#ef4444', '#f97316', '#84cc16', '#15803d'], 
            xaxis: { categories: ['Critico (<50%)', 'Ritardo (50-80%)', 'Target (80-100%)', 'Star (>100%)'], labels: { style: { fontSize: '11px', fontWeight: 600 } } },
            yaxis: { show: false }, grid: { show: false },
            tooltip: { theme: 'dark', y: { formatter: undefined, title: { formatter: (s) => "Agenti:" } } }
        }); charts.histo.render();
    }

    function updateTable(data) {
        const body = data.map(r => [
            `<div style="font-weight:700; color:var(--text-main)">${r.Agente_Nome||'—'}</div>`,
            `<div><span class="badge-pill badge-geo"><i class="ri-map-2-line"></i> ${r.Regione}</span> <span class="badge-pill badge-prov">${r.Provincia}</span></div>`,
            `<div style="font-weight:600; color:#475569">${r.Ragione_Sociale_Cliente}</div>`,
            `<div class="money-cell">${fmtEUR.format(asNum(r.Fatturato))}</div>`
        ]);
        if (dataTable) dataTable.destroy();
        dataTable = new DataTable('#tbl', {
            data: body, columns: [{title:"Agente"},{title:"Area Geografica"},{title:"Cliente"},{title:"Fatturato", className:"dt-right"}],
            order: [[3,'desc']], pageLength: 10, lengthChange: false,
            language: { search:"_INPUT_", searchPlaceholder:"Cerca cliente o agente...", paginate:{next:">", previous:"<"}, info:"_START_ - _END_ di _TOTAL_" }
        });
    }

    // --- MODAL LOGIC ---
    function openModal(bucketIndex) {
        const modal = document.getElementById('detailModal');
        const body = document.getElementById('modalBody');
        const title = document.getElementById('modalTitle');
        const bucketsNames = ['Critico (<50%)', 'In Ritardo (50-80%)', 'In Target (80-100%)', 'Star (>100%)'];
        const bucketColors = ['tag-crit', 'tag-warn', 'tag-ok', 'tag-ok']; 
        
        // ORDINAMENTO CRESCENTE (PERCENTUALE MINORE IN CIMA)
        const agents = agentPerformanceData.filter(a => a.bucket === bucketIndex).sort((a,b) => a.pct - b.pct);
        
        title.textContent = `${bucketsNames[bucketIndex]} (${agents.length} Agenti)`;
        body.innerHTML = '';
        
        if(agents.length === 0) { 
            body.innerHTML = '<div style="padding:40px; text-align:center; font-style:italic; color:#94a3b8">Nessun agente in questa fascia.</div>'; 
        } else {
            agents.forEach(a => {
                const diff = a.val - a.target;
                const div = document.createElement('div'); div.className = 'agent-list-item';
                
                div.innerHTML = `
                    <div class="agent-row-main">
                        <span class="agent-name">${a.name}</span>
                        <div style="text-align:right">
                            <span style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:2px">FATTURATO FINORA</span>
                            <span class="agent-val-highlight">€ ${fmtNum.format(a.val)}</span>
                        </div>
                    </div>
                    <div class="agent-details-grid">
                        <div class="det-label">Obiettivo:</div> <div class="det-val">€ ${fmtNum.format(a.target)}</div>
                        <div class="det-label">Area:</div> <div class="det-val">${a.reg} • ${a.prov}</div>
                        <div class="det-label">Differenza:</div> <div class="det-val" style="color:${diff>=0?'#15803d':'#b91c1c'}">${diff>0?'+':''}€ ${fmtNum.format(diff)}</div>
                        <div class="det-label">Performance:</div> <div><span class="tag-pct ${bucketColors[bucketIndex]}">${a.pct.toFixed(1)}%</span></div>
                        <div class="det-label">Clienti Attivi:</div> <div class="det-val">${a.cli}</div>
                        <div class="det-label">Scontrino Medio:</div> <div class="det-val">€ ${fmtNum.format(a.avg.toFixed(0))}</div>
                    </div>
                `;
                body.appendChild(div);
            });
        }
        modal.style.display = 'flex';
    }

    function closeModal(event) {
        if (event.target.id === 'detailModal') {
            document.getElementById('detailModal').style.display = 'none';
        }
    }
    function forceCloseModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // --- MODAL ESPANSI PER DATI COMPLETI ---
    function closeExpandedModal(event) {
        if (event.target.id === 'expandedModal') {
            document.getElementById('expandedModal').style.display = 'none';
        }
    }
    function forceCloseExpandedModal() {
        document.getElementById('expandedModal').style.display = 'none';
    }

    // Colori per le regioni nel modal
    const regionColors = ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#fdba74', '#fed7aa', '#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1', '#e2e8f0'];

    function openAgentiModal() {
        const modal = document.getElementById('expandedModal');
        const body = document.getElementById('expandedModalBody');
        const title = document.getElementById('expandedModalTitle');
        
        title.textContent = `Classifica Completa Agenti (${fullAgentiData.length})`;
        
        const totalFatt = fullAgentiData.reduce((sum, a) => sum + a.value, 0);
        const avgFatt = fullAgentiData.length > 0 ? totalFatt / fullAgentiData.length : 0;
        const maxVal = fullAgentiData.length > 0 ? fullAgentiData[0].value : 1;
        
        let html = `
            <div class="modal-summary">
                <div class="modal-stat">
                    <div class="modal-stat-value">${fullAgentiData.length}</div>
                    <div class="modal-stat-label">Agenti Totali</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fmtEUR.format(totalFatt)}</div>
                    <div class="modal-stat-label">Fatturato Totale</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fmtEUR.format(avgFatt)}</div>
                    <div class="modal-stat-label">Media per Agente</div>
                </div>
            </div>
            <table class="data-table-modal">
                <thead>
                    <tr>
                        <th class="rank-cell">#</th>
                        <th>Agente</th>
                        <th>Fatturato</th>
                        <th style="width:35%">% sul Totale</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        fullAgentiData.forEach((agent, idx) => {
            const pct = totalFatt > 0 ? (agent.value / totalFatt * 100) : 0;
            const barPct = maxVal > 0 ? (agent.value / maxVal * 100) : 0;
            let rankClass = 'rank-default';
            if(idx === 0) rankClass = 'rank-gold';
            else if(idx === 1) rankClass = 'rank-silver';
            else if(idx === 2) rankClass = 'rank-bronze';
            
            html += `
                <tr>
                    <td class="rank-cell"><span class="rank-badge ${rankClass}">${agent.rank}</span></td>
                    <td class="name-cell">${agent.name}</td>
                    <td class="value-cell">${fmtEUR.format(agent.value)}</td>
                    <td>
                        <div class="pct-bar-container">
                            <div class="pct-bar-track">
                                <div class="pct-bar-fill" style="width: ${barPct}%"></div>
                            </div>
                            <span class="pct-bar-label">${pct.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        body.innerHTML = html;
        modal.style.display = 'flex';
    }

    function openRegioniModal() {
        const modal = document.getElementById('expandedModal');
        const body = document.getElementById('expandedModalBody');
        const title = document.getElementById('expandedModalTitle');
        
        title.textContent = `Dettaglio Macro Aree (${fullRegioniData.length} Regioni)`;
        
        const totalFatt = fullRegioniData.reduce((sum, r) => sum + r.value, 0);
        const maxVal = fullRegioniData.length > 0 ? fullRegioniData[0].value : 1;
        
        let html = `
            <div class="modal-summary">
                <div class="modal-stat">
                    <div class="modal-stat-value">${fullRegioniData.length}</div>
                    <div class="modal-stat-label">Regioni Attive</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fmtEUR.format(totalFatt)}</div>
                    <div class="modal-stat-label">Fatturato Totale</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fullRegioniData.length > 0 ? fullRegioniData[0].name : '-'}</div>
                    <div class="modal-stat-label">Top Regione</div>
                </div>
            </div>
            <table class="data-table-modal">
                <thead>
                    <tr>
                        <th class="rank-cell">#</th>
                        <th>Regione</th>
                        <th>Fatturato</th>
                        <th style="width:35%">Quota di Mercato</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        fullRegioniData.forEach((reg, idx) => {
            const barPct = maxVal > 0 ? (reg.value / maxVal * 100) : 0;
            let rankClass = 'rank-default';
            if(idx === 0) rankClass = 'rank-gold';
            else if(idx === 1) rankClass = 'rank-silver';
            else if(idx === 2) rankClass = 'rank-bronze';
            
            const dotColor = regionColors[idx % regionColors.length];
            
            html += `
                <tr>
                    <td class="rank-cell"><span class="rank-badge ${rankClass}">${reg.rank}</span></td>
                    <td class="name-cell"><span class="region-dot" style="background:${dotColor}"></span>${reg.name}</td>
                    <td class="value-cell">${fmtEUR.format(reg.value)}</td>
                    <td>
                        <div class="pct-bar-container">
                            <div class="pct-bar-track">
                                <div class="pct-bar-fill" style="width: ${barPct}%"></div>
                            </div>
                            <span class="pct-bar-label">${reg.pct.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        body.innerHTML = html;
        modal.style.display = 'flex';
    }

    function openProvinceModal() {
        const modal = document.getElementById('expandedModal');
        const body = document.getElementById('expandedModalBody');
        const title = document.getElementById('expandedModalTitle');
        
        title.textContent = `Dettaglio Province (${fullProvinceData.length} Province)`;
        
        const totalFatt = fullProvinceData.reduce((sum, p) => sum + p.value, 0);
        const maxVal = fullProvinceData.length > 0 ? fullProvinceData[0].value : 1;
        const avgFatt = fullProvinceData.length > 0 ? totalFatt / fullProvinceData.length : 0;
        
        let html = `
            <div class="modal-summary">
                <div class="modal-stat">
                    <div class="modal-stat-value">${fullProvinceData.length}</div>
                    <div class="modal-stat-label">Province Attive</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fmtEUR.format(totalFatt)}</div>
                    <div class="modal-stat-label">Fatturato Totale</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fullProvinceData.length > 0 ? fullProvinceData[0].name : '-'}</div>
                    <div class="modal-stat-label">Top Provincia</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${fmtEUR.format(avgFatt)}</div>
                    <div class="modal-stat-label">Media per Provincia</div>
                </div>
            </div>
            <table class="data-table-modal">
                <thead>
                    <tr>
                        <th class="rank-cell">#</th>
                        <th>Provincia</th>
                        <th>Fatturato</th>
                        <th style="width:35%">Quota %</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        fullProvinceData.forEach((prov, idx) => {
            const barPct = maxVal > 0 ? (prov.value / maxVal * 100) : 0;
            let rankClass = 'rank-default';
            if(idx === 0) rankClass = 'rank-gold';
            else if(idx === 1) rankClass = 'rank-silver';
            else if(idx === 2) rankClass = 'rank-bronze';
            
            const dotColor = regionColors[idx % regionColors.length];
            
            html += `
                <tr>
                    <td class="rank-cell"><span class="rank-badge ${rankClass}">${prov.rank}</span></td>
                    <td class="name-cell"><span class="region-dot" style="background:${dotColor}"></span>${prov.name}</td>
                    <td class="value-cell">${fmtEUR.format(prov.value)}</td>
                    <td>
                        <div class="pct-bar-container">
                            <div class="pct-bar-track">
                                <div class="pct-bar-fill" style="width: ${barPct}%"></div>
                            </div>
                            <span class="pct-bar-label">${prov.pct.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        body.innerHTML = html;
        modal.style.display = 'flex';
    }
  </script>
</body>
</html>
