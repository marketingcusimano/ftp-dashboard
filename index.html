<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard B2B</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b1320;--panel:#131e33;--muted:#94a3b8;--text:#e2e8f0;--accent:#3b82f6}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px} h1{margin:0 0 8px}
    .panel{background:var(--panel);border:1px solid #1f2a44;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
    select,input,button{background:#0f172a;color:var(--text);border:1px solid #283556;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;background:var(--accent);border:none}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .table-wrap{overflow:auto;max-height:500px;border:1px solid #1f2a44;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:#0f172a}
    th,td{padding:8px 10px;border-bottom:1px solid #223055;white-space:nowrap;text-align:left}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard B2B</h1>
  <div id="meta" class="muted">Caricamento…</div>

  <div class="controls">
    <button id="refresh">Aggiorna</button>
    <select id="section"></select>
    <input id="search" placeholder="Cerca…">
  </div>

  <div class="grid">
    <section class="panel">
      <h3 style="margin:0 0 8px">Grafico</h3>
      <canvas id="chart" height="320"></canvas>
    </section>
    <section class="panel">
      <h3 style="margin:0 0 8px">Tabella</h3>
      <div class="table-wrap"><table id="tbl"></table></div>
    </section>
  </div>
</div>

<script>
let RAW=[], VIEW=[], chart;

const el = id => document.getElementById(id);
const euro = s => {
  if (s==null) return null;
  const t = String(s).replace(/\./g,'').replace(',', '.').replace(/\s/g,'');
  const n = Number(t);
  return Number.isFinite(n)? n : null;
};

// ---- PARSING TESTO GREZZO (TAB o SPAZI, sezioni, commenti) ----
function splitLines(t){ return t.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); }
function splitFlex(line){
  const norm = line.replace(/\u00A0/g,' ');
  return (norm.includes('\t') ? norm.split(/\t+/) : norm.split(/ {2,}/)).map(s=>s.trim());
}
function parseText(text){
  const lines = splitLines(text);
  let section = null, header = null;
  const out = [];
  for (const raw of lines){
    const t = raw.trim();
    if (!t) continue;
    if (t.startsWith('##')){ section = t.replace(/^##\s*/,''); header=null; continue; }
    if (t.startsWith('#')) continue;

    const cells = splitFlex(raw);
    if (!header && /^tipo[_\s]?dato$/i.test((cells[0]||'').trim())){ header=cells; continue; }
    if (/^tipo[_\s]?dato$/i.test((cells[0]||'').trim())){ header=cells; continue; }
    if (!header) continue;

    const row = {};
    for (let i=0;i<header.length;i++){
      const k = (header[i]||'').trim(); if (!k) continue;
      let v = (cells[i] ?? '').toString().trim();
      // prova numerico su alcune chiavi note
      if (['Anno_Precedente','Anno_Corrente','Obiettivo','Percentuale_Obiettivo','Clienti_Anno_Precedente','Clienti_Anno_Corrente','Obiettivo_Clienti','Percentuale_Obiettivo_Clienti','Fatturato','Importo_Totale','Importo','Percentuale','Valore','Clienti_Serviti'].includes(k)){
        const n = euro(v); if (n!=null) v = n;
      }
      row[k]=v;
    }
    if (section) row['__Sezione']=section;
    out.push(row);
  }
  return out;
}

// ---- UI ----
function fillSectionOptions(){
  const s = el('section');
  const sections = Array.from(new Set(RAW.map(r=>r.__Sezione||'Generale'))).filter(Boolean);
  s.innerHTML = '<option value="">Tutte le sezioni</option>' + sections.map(x=>`<option>${x}</option>`).join('');
}
function filterRows(){
  const sec = el('section').value, q = el('search').value.toLowerCase().trim();
  let rows = RAW;
  if (sec) rows = rows.filter(r=> (r.__Sezione||'') === sec);
  if (q) rows = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(q));
  return rows;
}
function drawTable(rows){
  const tbl = el('tbl');
  if (!rows.length){ tbl.innerHTML = '<thead><tr><th>Nessun dato</th></tr></thead>'; return []; }
  const cols = Object.keys(rows[0]);
  const head = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const body = rows.slice(0,200).map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('');
  tbl.innerHTML = head + '<tbody>'+body+'</tbody>';
  return cols;
}
function drawChart(rows){
  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) chart.destroy();
  if (!rows.length){ chart = new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'',data:[]}]}}); return; }

  const has = k => rows[0] && k in rows[0];
  let label='Provincia', value='Fatturato', title='Fatturato per Provincia';
  if (has('Ragione_Sociale_Cliente') && has('Fatturato')) { label='Ragione_Sociale_Cliente'; value='Fatturato'; title='Top Vendite per Cliente'; }
  else if (has('Categoria') && (has('Importo_Totale')||has('Importo'))) { label='Categoria'; value=has('Importo_Totale')?'Importo_Totale':'Importo'; title='Riepilogo Categoria'; }
  else if (has('Provincia') && has('Clienti_Serviti')) { label='Provincia'; value='Clienti_Serviti'; title='Clienti per Provincia'; }
  const agg = new Map();
  for (const r of rows) agg.set(r[label]||'(vuoto)', (agg.get(r[label])||0) + (+r[value]||0));
  const labels = Array.from(agg.keys()), data = Array.from(agg.values());
  chart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:title,data}]},options:{responsive:true,maintainAspectRatio:false}});
}

async function load(){
  el('meta').textContent='Caricamento…';
  const res = await fetch('/raw',{cache:'no-store'});
  const txt = await res.text();
  RAW = parseText(txt);
  fillSectionOptions();
  VIEW = filterRows();
  const cols = drawTable(VIEW);
  drawChart(VIEW);
  el('meta').textContent = `${VIEW.length} righe · ${cols.length} colonne`;
}

document.getElementById('refresh').addEventListener('click', load);
document.getElementById('section').addEventListener('change', ()=>{ VIEW=filterRows(); const c=drawTable(VIEW); drawChart(VIEW); });
document.getElementById('search').addEventListener('input', ()=>{ VIEW=filterRows(); const c=drawTable(VIEW); drawChart(VIEW); });

load().catch(e=>{ el('meta').textContent='Errore: '+e.message; console.error(e); });
</script>
</body>
</html>
