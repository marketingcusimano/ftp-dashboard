<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Analytics Hub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #D2691E; --primary-dark: #A0522D;
      --bg-body: #f3f4f6; --bg-card: #ffffff;
      --text-main: #111827; --text-muted: #6b7280;
      --border: #e5e7eb; --success: #10b981; --danger: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 40px; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
    
    /* Header */
    header { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); padding: 16px 0; margin-bottom: 32px; }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 10px; color: #fff; display: grid; place-items: center; font-weight: 700; font-size: 18px; box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3); }
    
    /* Controls */
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    select { background: var(--bg-card); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 13px; color: var(--text-main); cursor: pointer; min-width: 160px; }
    .btn { background: var(--bg-card); border: 1px solid var(--border); padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; gap: 6px; align-items: center; }
    .btn:hover { background: #f9fafb; }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-primary:hover { background: var(--primary-dark); }

    /* Grids */
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .grid-charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1024px) { .grid-charts-row { grid-template-columns: 1fr; } }

    /* Cards */
    .card { background: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.04); }
    
    /* Typography & KPI */
    .kpi-head { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 26px; font-weight: 700; color: var(--text-main); }
    .chart-title { font-size: 15px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    
    /* Table */
    table.dataTable { width: 100% !important; border-collapse: collapse; }
    table.dataTable thead th { background: #f9fafb; padding: 12px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
    table.dataTable tbody td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #eff6ff; color: #2563eb; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Loading */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:16px; font-weight:600; color:#555">Caricamento dati...</p>
  </div>

  <header>
    <div class="container header-inner">
      <div class="brand">
        <div class="logo">CC</div>
        <div>
          <div style="font-weight:700; font-size:18px;">Cotto Cusimano</div>
          <div style="font-size:11px; color:var(--text-muted)">Dashboard Vendite</div>
        </div>
      </div>
      <div class="controls">
        <select id="selAgente"><option value="">Tutti gli Agenti</option></select>
        <select id="selProvincia"><option value="">Tutte le Province</option></select>
        <button class="btn" id="btnReset"><i class="ri-restart-line"></i> Reset</button>
        <button class="btn btn-primary" id="btnExcel"><i class="ri-file-excel-2-line"></i> Export</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="grid-kpi">
      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Fatturato Totale</span><i class="ri-money-euro-circle-line" style="color:var(--primary)"></i></div>
        <div class="kpi-val" id="kpiFatturato">€ 0</div>
      </div>
      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Clienti Attivi</span><i class="ri-building-4-line" style="color:var(--primary)"></i></div>
        <div class="kpi-val" id="kpiClienti">0</div>
      </div>
      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Target Raggiunto</span><i class="ri-target-line" style="color:var(--primary)"></i></div>
        <div style="display:flex; align-items:center; gap:10px">
            <div id="chartRadial" style="flex:1"></div>
            <div class="kpi-val" style="font-size:20px" id="kpiTargetVal">0%</div>
        </div>
      </div>
      <div class="card" style="background:#222; color:#fff">
        <div class="kpi-head"><span class="kpi-label" style="color:#aaa">Top Performer</span><i class="ri-trophy-line" style="color:#ffd700"></i></div>
        <div id="kpiTopAgent" style="font-weight:600; font-size:18px">—</div>
        <div id="kpiTopAgentVal" class="mono" style="color:#ccc; font-size:14px; margin-top:4px">€ 0</div>
      </div>
    </div>

    <div class="grid-charts-row">
      <div class="card">
        <div class="chart-title"><i class="ri-bar-chart-fill"></i> Performance per Agente</div>
        <div id="chartBar"></div>
      </div>
      <div class="card">
        <div class="chart-title"><i class="ri-pie-chart-fill"></i> Distribuzione Geografica</div>
        <div id="chartDonut" style="display:flex; justify-content:center"></div>
      </div>
    </div>

    <div class="grid-charts-row">
      <div class="card">
        <div class="chart-title"><i class="ri-vip-crown-fill"></i> Top 5 Clienti</div>
        <div id="chartClients"></div>
      </div>
      <div class="card">
        <div class="chart-title"><i class="ri-layout-grid-fill"></i> Mappa Province (Treemap)</div>
        <div id="chartTreemap"></div>
      </div>
    </div>

    <div class="card">
      <div class="chart-title"><i class="ri-table-line"></i> Dettaglio Transazioni</div>
      <table id="tbl" class="display hover" style="width:100%"></table>
    </div>
    
    <div style="text-align:center; margin-top:30px; font-size:11px; color:#888">
      Dati aggiornati al: <span id="lastUpdate">--</span>
    </div>
  </div>

  <script>
    // FORMATTERS
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const asNum = v => {
        if (typeof v === 'number') return v;
        if (!v) return 0;
        // Pulisce stringhe tipo "1.200,50" -> 1200.50
        return Number(v.toString().replace(/\./g, '').replace(',', '.'));
    };

    // STATE
    let state = { all: [], rows: [] };
    let charts = { bar: null, donut: null, radial: null, clients: null, treemap: null };
    let dataTable = null;

    // MAIN
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // 1. FETCH DATI REALI
            // Assicurati che il tuo server risponda a /data con il JSON
            const res = await fetch('/data', { cache: "no-store" });
            if(!res.ok) throw new Error("Server Error: " + res.status);
            const data = await res.json();

            state.all = data.rows || [];
            state.rows = [...state.all]; // copia iniziale
            
            if(data.updatedAt) document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString();
            
            // 2. INIT
            document.getElementById('loading').style.display = 'none';
            populateFilters();
            initCharts();
            updateDashboard();

        } catch (err) {
            document.getElementById('loading').innerHTML = `<h3 style="color:red">Errore</h3><p>${err.message}</p>`;
            console.error(err);
        }

        // 3. HANDLERS
        document.getElementById('selAgente').addEventListener('change', applyFilters);
        document.getElementById('selProvincia').addEventListener('change', applyFilters);
        document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('selAgente').value = "";
            document.getElementById('selProvincia').value = "";
            applyFilters();
        });
        document.getElementById('btnExcel').addEventListener('click', exportExcel);
    });

    function populateFilters() {
        // Usiamo trim() per pulire eventuali spazi vuoti che rompono i filtri
        const agenti = [...new Set(state.all.map(r => (r.Agente_Nome || r.Agente_Codice || '').trim()))].filter(Boolean).sort();
        const province = [...new Set(state.all.map(r => (r.Provincia || '').trim()))].filter(Boolean).sort();
        
        const sA = document.getElementById('selAgente');
        const sP = document.getElementById('selProvincia');
        
        agenti.forEach(a => sA.add(new Option(a, a)));
        province.forEach(p => sP.add(new Option(p, p)));
    }

    function applyFilters() {
        const ag = document.getElementById('selAgente').value;
        const pr = document.getElementById('selProvincia').value;

        state.rows = state.all.filter(r => {
            // Confronto sicuro: puliamo gli spazi e gestiamo i null
            const rAg = (r.Agente_Nome || r.Agente_Codice || '').trim();
            const rPr = (r.Provincia || '').trim();

            const matchA = !ag || rAg === ag;
            const matchP = !pr || rPr === pr;
            return matchA && matchP;
        });
        updateDashboard();
    }

    function updateDashboard() {
        const data = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const objs = state.all.find(r => r.Tipo_Dato === 'OBIETTIVI');

        // --- KPI ---
        const totFatt = data.reduce((a,b) => a + asNum(b.Fatturato), 0);
        const totCli = new Set(data.map(r => r.Ragione_Sociale_Cliente)).size;
        
        document.getElementById('kpiFatturato').textContent = fmtEUR.format(totFatt);
        document.getElementById('kpiClienti').textContent = totCli;
        
        // Target
        const pct = objs ? objs.Percentuale_Obiettivo : 0;
        charts.radial.updateSeries([pct]);
        document.getElementById('kpiTargetVal').textContent = Number(pct).toFixed(1) + "%";

        // Top Agent
        const agMap = {};
        data.forEach(r => { const k = (r.Agente_Nome||'N/D'); agMap[k] = (agMap[k]||0) + asNum(r.Fatturato); });
        const top = Object.entries(agMap).sort((a,b)=>b[1]-a[1])[0];
        if(top) {
            document.getElementById('kpiTopAgent').textContent = top[0];
            document.getElementById('kpiTopAgentVal').textContent = fmtEUR.format(top[1]);
        } else {
            document.getElementById('kpiTopAgent').textContent = "—";
        }

        // --- GRAFICI ---
        
        // 1. Bar Chart Agenti
        const agSorted = Object.entries(agMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        charts.bar.updateOptions({ xaxis: { categories: agSorted.map(x=>x[0]) } });
        charts.bar.updateSeries([{ data: agSorted.map(x=>x[1]) }]);

        // 2. Donut Province
        const prMap = {};
        data.forEach(r => { const k = (r.Provincia||'?').trim(); prMap[k] = (prMap[k]||0) + asNum(r.Fatturato); });
        const prSorted = Object.entries(prMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        charts.donut.updateOptions({ labels: prSorted.map(x=>x[0]) });
        charts.donut.updateSeries(prSorted.map(x=>x[1]));

        // 3. Top 5 Clienti (NUOVO)
        const clMap = {};
        data.forEach(r => { const k = r.Ragione_Sociale_Cliente||'N/D'; clMap[k] = (clMap[k]||0) + asNum(r.Fatturato); });
        const clSorted = Object.entries(clMap).sort((a,b)=>b[1]-a[1]).slice(0,5); // Top 5
        charts.clients.updateOptions({ xaxis: { categories: clSorted.map(x=>x[0]) } });
        charts.clients.updateSeries([{ data: clSorted.map(x=>x[1]) }]);

        // 4. Treemap Province (NUOVO)
        const treeData = Object.entries(prMap).map(([k,v]) => ({ x: k, y: v }));
        charts.treemap.updateSeries([{ data: treeData }]);

        // --- TABELLA ---
        updateTable(data);
    }

    function initCharts() {
        const font = 'Inter, sans-serif';
        
        // Agenti
        charts.bar = new ApexCharts(document.querySelector("#chartBar"), {
            series: [{ name:'Fatturato', data:[] }],
            chart: { type:'bar', height:300, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:4, barHeight:'60%', distributed:true } },
            colors: ['#D2691E', '#A0522D', '#CD853F', '#DEB887', '#F4A460'],
            dataLabels: { enabled:false },
            legend: { show:false },
            xaxis: { labels: { formatter: v => "€ " + (v/1000).toFixed(0) + "k" } },
            tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.bar.render();

        // Province Donut
        charts.donut = new ApexCharts(document.querySelector("#chartDonut"), {
            series: [], labels: [],
            chart: { type:'donut', height:300, fontFamily:font },
            colors: ['#D2691E', '#212529', '#6c757d', '#adb5bd', '#ced4da'],
            plotOptions: { pie: { donut: { size:'70%', labels:{show:true, total:{show:true, label:'Totale', formatter: w => {
                const t = w.globals.seriesTotals.reduce((a,b)=>a+b,0);
                return "€ " + (t/1000).toFixed(0) + "k";
            }}}}}},
            legend: { position:'bottom' }, dataLabels: { enabled:false }
        });
        charts.donut.render();

        // Clients Bar (NUOVO)
        charts.clients = new ApexCharts(document.querySelector("#chartClients"), {
            series: [{ name:'Acquisti', data:[] }],
            chart: { type:'bar', height:300, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:4, barHeight:'50%' } },
            colors: ['#2563eb'], // Blu per i clienti
            dataLabels: { enabled:true, formatter: v => "€ " + (v/1000).toFixed(1) + "k", offsetX: 30, style: { colors: ['#333'] } },
            xaxis: { labels: { show:false } }, // Nascondo asse X tanto ho le label
            grid: { show:false },
            tooltip: { y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.clients.render();

        // Treemap (NUOVO)
        charts.treemap = new ApexCharts(document.querySelector("#chartTreemap"), {
            series: [],
            chart: { type:'treemap', height:300, fontFamily:font, toolbar:{show:false} },
            colors: ['#D2691E'],
            plotOptions: { treemap: { distributed: true, enableShades: true } },
            dataLabels: { formatter: (text, op) => [text, fmtEUR.format(op.value)] } // Mostra nome e valore
        });
        charts.treemap.render();

        // Radial KPI
        charts.radial = new ApexCharts(document.querySelector("#chartRadial"), {
            series: [0],
            chart: { type:'radialBar', height:140, width:140 },
            plotOptions: { radialBar: { hollow:{size:'65%'}, track:{background:'#f0f0f0'}, dataLabels:{show:false} } },
            colors: ['#10b981'], stroke: { lineCap:'round' }
        });
        charts.radial.render();
    }

    function updateTable(data) {
        const body = data.map(r => [
            `<b>${r.Agente_Nome||'—'}</b>`,
            `<span class="badge">${r.Provincia||'?'}</span>`,
            r.Ragione_Sociale_Cliente,
            `<span class="mono" style="color:var(--primary);font-weight:700">${fmtEUR.format(asNum(r.Fatturato))}</span>`
        ]);
        
        if (dataTable) dataTable.destroy();
        dataTable = new DataTable('#tbl', {
            data: body,
            columns: [{title:"Agente"},{title:"Prov"},{title:"Cliente"},{title:"Fatturato", className:"dt-right"}],
            order: [[3,'desc']], pageLength: 5, lengthChange: false,
            language: { search:"", paginate:{next:">", previous:"<"}, info:"_START_-_END_ di _TOTAL_" }
        });
    }

    function exportExcel() {
        const data = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dati");
        XLSX.writeFile(wb, "CottoCusimano_Export.xlsx");
    }
  </script>
</body>
</html>
