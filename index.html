
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard B2B - Rete Commerciale</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            success: '#10b981',
            warning: '#f59e0b',
            danger:  '#ef4444',
          }
        }
      }
    }
  </script>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone (permette JSX inline) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts (UMD) -->
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>

  <style>
    body { background: #ffffff; color: #0b1320; font-family: Inter, Segoe UI, Roboto, system-ui, -apple-system, sans-serif; }
    .card { background:#fff; border:1px solid #f0f0f0; border-radius:16px; padding:24px; box-shadow: 0 6px 16px rgba(0,0,0,.05); }
    .kpi-label { font-size: .875rem; color:#6b7280 }
    .kpi-value { font-size: 1.5rem; font-weight: 700 }
    .chip { font-size:.75rem; padding:.25rem .5rem; border-radius:999px; border:1px solid #e5e7eb }
    .tab-btn { padding:.5rem 1rem; border-radius:999px; border:1px solid #e5e7eb; font-size:.875rem }
    .tab-btn-active { background:#2563eb; color:#fff; border-color:#2563eb }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState } = React;
    const {
      ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
      LineChart, Line, PieChart, Pie, Cell, ScatterChart, Scatter, ZAxis
    } = Recharts;

    /* ================= Data (demo fallback) ================= */
    const demoData = {
      riepilogo_generale: {
        fatturato_totale: 4649230.79,
        percentuale_obiettivo: 73.56,
        clienti_totali: 777,
        agenti_attivi: 36,
        variazione_yoy: -13.04
      },
      province: [
        { provincia: 'RG', fatturato_totale: 310000, clienti_totali: 92, numero_agenti: 2, obiettivo_totale: 380000, percentuale_obiettivo: 81.6 },
        { provincia: 'ME', fatturato_totale: 210000, clienti_totali: 41, numero_agenti: 1, obiettivo_totale: 250000, percentuale_obiettivo: 84.0 },
        { provincia: 'NA', fatturato_totale: 480000, clienti_totali: 120, numero_agenti: 3, obiettivo_totale: 600000, percentuale_obiettivo: 80.0 },
        { provincia: 'SA', fatturato_totale: 95000, clienti_totali: 22, numero_agenti: 1, obiettivo_totale: 140000, percentuale_obiettivo: 67.8 },
        { provincia: 'CT', fatturato_totale: 365000, clienti_totali: 75, numero_agenti: 2, obiettivo_totale: 420000, percentuale_obiettivo: 86.9 },
        { provincia: 'PA', fatturato_totale: 150000, clienti_totali: 45, numero_agenti: 1, obiettivo_totale: 220000, percentuale_obiettivo: 68.2 },
      ],
      agenti: Array.from({length: 12}).map((_,i)=>({
        codice: "631."+String(10000+i),
        ragione_sociale: ["BILOTTI ANDREA","SPL SERVICE SNC","DG&G GRANATA","ARENA SNC","GAROFALO SRL","CAGGIA & BELLASSAI","EDIL FORNITURE","ARCA SRL","POLIS SRL","LEADER CEMENTI","ESAGONO SAS","TUTTO EDILE"][i],
        periodo: "01/01/2025 - 02/10/2025",
        obiettivi: { generale: { anno_precedente: 200000 + i*5000, anno_corrente: 160000 + i*4000, obiettivo: 235000 + i*3000, percentuale_obiettivo: 60 + i*2.1 } },
        clienti_per_provincia: [
          { provincia: 'RG', clienti: 18, fatturato: 165244.16 },
          { provincia: 'ME', clienti: 1, fatturato: 803.24 },
          { provincia: 'NA', clienti: 33, fatturato: 211381.33 }
        ],
        totali: { fatturato: 166047.40 + i*10000, clienti: 19 + i, ordini: 25 + i*2, yoy: i%2 ? -5.2 : 3.1 }
      }))
    };
    const dataSrc = window.dashboardData || demoData;

    /* ============== Helpers ============== */
    const formatEuro = (v) => new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(v||0);
    const formatPercent = (v) => (isFinite(v) ? (v.toFixed(2).replace('.',',')) : '0,00') + '%';
    const formatNumber = (v) => new Intl.NumberFormat('it-IT').format(v||0);
    const getColorByPerformance = (p) => p>=90 ? '#10b981' : (p>=70 ? '#f59e0b' : '#ef4444');

    const KPI = ({ label, value, delta, icon, color }) => {
      const isPos = (delta ?? 0) >= 0;
      return (
        <div className="card">
          <div className="flex items-start justify-between">
            <div>
              <div className="kpi-label">{label}</div>
              <div className="kpi-value mt-1">{value}</div>
            </div>
            <div className="w-9 h-9 rounded-xl flex items-center justify-center" style={{backgroundColor:'#f3f6ff', color: color || '#2563eb'}}>
              <span className="text-base">{icon || '‚óè'}</span>
            </div>
          </div>
          {typeof delta === 'number' && (
            <div className="mt-3 text-sm">
              <span className={isPos ? 'text-success' : 'text-danger'}>
                {isPos ? '‚Üë' : '‚Üì'} {Math.abs(delta).toFixed(2).replace('.', ',')}%
              </span>
              <span className="text-gray-500"> vs prec.</span>
            </div>
          )}
        </div>
      );
    };

    const Gauge = ({ value }) => {
      const cl = getColorByPerformance(value||0);
      const pct = Math.max(0, Math.min(100, value||0));
      const angle = Math.PI * pct/100;
      const r = 80; const cx = 100, cy = 100;
      const x = cx + r*Math.cos(Math.PI - angle);
      const y = cy + r*Math.sin(Math.PI - angle);
      const largeArc = pct>50 ? 1 : 0;
      return (
        <div className="card">
          <div className="kpi-label mb-2">Raggiungimento Obiettivo</div>
          <svg width="100%" viewBox="0 0 200 120">
            <path d={`M ${cx-r},${cy} A ${r},${r} 0 1 1 ${cx+r},${cy}`} stroke="#e5e7eb" strokeWidth="16" fill="none" />
            <path d={`M ${cx-r},${cy} A ${r},${r} 0 ${largeArc} 1 ${x},${y}`} stroke={cl} strokeWidth="16" fill="none" />
            <text x="100" y="85" textAnchor="middle" className="text-xl font-bold" fill="#0b1320">{formatPercent(pct)}</text>
          </svg>
        </div>
      );
    };

    const SectionTitle = ({children}) => <div className="font-semibold text-lg mb-2">{children}</div>;

    function TabPanoramica({ data }){
      const topAgenti = React.useMemo(()=>{
        const items = data.agenti.map(a => ({ nome: a.ragione_sociale, fatturato: a.totali?.fatturato || 0 }));
        return items.sort((a,b)=>b.fatturato-a.fatturato).slice(0,10);
      }, [data]);

      const fattPerProv = React.useMemo(()=>{
        const items = (data.province||[]).map(p=>({ provincia: p.provincia, fatturato: p.fatturato_totale||0 }));
        return items.sort((a,b)=>b.fatturato-a.fatturato).slice(0,10);
      }, [data]);

      const metricheAgg = React.useMemo(()=>{
        const fattTot = data.riepilogo_generale?.fatturato_totale || 0;
        const nAg = data.riepilogo_generale?.agenti_attivi || data.agenti.length || 1;
        const nCli = data.riepilogo_generale?.clienti_totali || 0;
        return [
          { label:'Fatturato medio per agente', val: formatEuro(fattTot / nAg) },
          { label:'Clienti medi per agente', val: formatNumber(nCli / nAg) },
          { label:'Fatturato medio per cliente', val: formatEuro(nCli ? (fattTot / nCli) : 0) },
        ];
      }, [data]);

      const pctObj = data.riepilogo_generale?.percentuale_obiettivo ?? 0;

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5">
            <KPI label="Fatturato Totale Rete" value={formatEuro(data.riepilogo_generale?.fatturato_totale||0)} delta={data.riepilogo_generale?.variazione_yoy} icon="‚Ç¨" color="#2563eb" />
            <KPI label="% Raggiungimento" value={formatPercent(pctObj)} icon="üéØ" color="#10b981" />
            <KPI label="Clienti Totali" value={formatNumber(data.riepilogo_generale?.clienti_totali||0)} icon="üë•" color="#2563eb" />
            <KPI label="Agenti Attivi" value={formatNumber(data.riepilogo_generale?.agenti_attivi||0)} icon="üßë‚Äçüíº" color="#2563eb" />
            <KPI label="Variazione YoY" value={formatPercent(Math.abs(data.riepilogo_generale?.variazione_yoy||0))} delta={data.riepilogo_generale?.variazione_yoy} icon="‚Üï" color="#ef4444" />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <div className="card">
              <SectionTitle>Top 10 Agenti per Fatturato</SectionTitle>
              <div style={{height: 360}}>
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={topAgenti} layout="vertical" margin={{left: 16, right: 16, top: 8, bottom: 8}}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis type="number" tickFormatter={formatEuro} />
                    <YAxis type="category" dataKey="nome" width={140} />
                    <Tooltip formatter={(v)=>formatEuro(v)} />
                    <Bar dataKey="fatturato">
                      {topAgenti.map((_,i)=> <Cell key={i} fill={i<3 ? '#2563eb' : (i<6 ? '#60a5fa' : '#93c5fd')} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <Gauge value={pctObj} />
          </div>

          <div className="card">
            <SectionTitle>Fatturato per Provincia (Top 10)</SectionTitle>
            <div style={{height: 360}}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={fattPerProv} margin={{left: 8, right: 16, top: 8, bottom: 8}}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="provincia" />
                  <YAxis tickFormatter={formatEuro} />
                  <Tooltip formatter={(v)=>formatEuro(v)} />
                  <Bar dataKey="fatturato" fill="#34d399" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
            {metricheAgg.map((m, idx)=>(
              <div className="card" key={idx}>
                <div className="kpi-label">{m.label}</div>
                <div className="kpi-value mt-1">{m.val}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function TabRegioni({ data }){
      const [provSel, setProvSel] = React.useState('');
      const listProv = React.useMemo(()=> (data.province||[]).map(p=>p.provincia).sort(), [data]);

      const kpi = React.useMemo(()=>{
        const p = (data.province||[]).find(x=>x.provincia===provSel);
        return p ? {
          fatt: p.fatturato_totale,
          nAg: p.numero_agenti,
          nCli: p.clienti_totali,
          pct: p.percentuale_obiettivo
        } : null;
      }, [provSel, data]);

      const allProvSorted = React.useMemo(()=>{
        return (data.province||[]).slice().sort((a,b)=>b.fatturato_totale-a.fatturato_totale);
      }, [data]);

      const scatter = React.useMemo(()=>{
        return (data.province||[]).map(p=>({ x: p.clienti_totali, y: p.fatturato_totale, name: p.provincia }));
      }, [data]);

      const listAgentiProv = React.useMemo(()=>{
        if (!provSel) return [];
        const res = [];
        (data.agenti||[]).forEach(a=>{
          const voce = (a.clienti_per_provincia||[]).find(v=>v.provincia===provSel);
          if (voce) res.push({
            nome: a.ragione_sociale,
            fatt: voce.fatturato||0,
            clienti: voce.clienti||0,
            pct: a.obiettivi?.generale?.percentuale_obiettivo ?? null
          });
        });
        return res.sort((a,b)=>b.fatt-a.fatt);
      }, [provSel, data]);

      return (
        <div className="space-y-6">
          <div className="flex flex-wrap items-center gap-3">
            <label className="text-sm text-gray-600">Provincia:</label>
            <select className="border rounded-lg px-3 py-2" value={provSel} onChange={e=>setProvSel(e.target.value)}>
              <option value="">Tutte le Province</option>
              {listProv.map(p=><option key={p} value={p}>{p}</option>)}
            </select>
          </div>

          {kpi && (
            <div className="grid grid-cols-1 md:grid-cols-4 gap-5">
              <KPI label="Fatturato Provincia" value={formatEuro(kpi.fatt)} icon="‚Ç¨" />
              <KPI label="N¬∞ Agenti operanti" value={formatNumber(kpi.nAg)} icon="üßë‚Äçüíº" />
              <KPI label="N¬∞ Clienti" value={formatNumber(kpi.nCli)} icon="üë•" />
              <KPI label="% Raggiungimento" value={formatPercent(kpi.pct||0)} icon="üéØ" />
            </div>
          )}

          <div className="card">
            <SectionTitle>Fatturato per Provincia (tutte)</SectionTitle>
            <div style={{height: 360}}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={allProvSorted}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="provincia" />
                  <YAxis tickFormatter={formatEuro} />
                  <Tooltip formatter={(v)=>formatEuro(v)} />
                  <Bar dataKey="fatturato_totale">
                    {allProvSorted.map((p,i)=> <Cell key={i} fill={getColorByPerformance(p.percentuale_obiettivo||0)} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="card">
            <SectionTitle>Clienti vs Fatturato (per provincia)</SectionTitle>
            <div style={{height: 360}}>
              <ResponsiveContainer width="100%" height="100%">
                <ScatterChart>
                  <CartesianGrid />
                  <XAxis type="number" dataKey="x" name="Clienti" tickFormatter={formatNumber} />
                  <YAxis type="number" dataKey="y" name="Fatturato" tickFormatter={formatEuro} />
                  <Tooltip cursor={{ strokeDasharray: '3 3' }} formatter={(v, n)=> n==='x' ? formatNumber(v) : formatEuro(v)} />
                  <Scatter data={scatter} fill="#2563eb" />
                </ScatterChart>
              </ResponsiveContainer>
            </div>
          </div>

          {provSel && (
            <div className="card">
              <SectionTitle>Agenti operanti in {provSel}</SectionTitle>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-gray-50">
                      <th className="text-left px-3 py-2">Nome</th>
                      <th className="text-right px-3 py-2">Fatturato</th>
                      <th className="text-right px-3 py-2">Clienti</th>
                      <th className="text-right px-3 py-2">% Obiettivo</th>
                    </tr>
                  </thead>
                  <tbody>
                    {listAgentiProv.map((r,idx)=>(
                      <tr key={idx} className="border-t">
                        <td className="px-3 py-2">{r.nome}</td>
                        <td className="px-3 py-2 text-right">{formatEuro(r.fatt)}</td>
                        <td className="px-3 py-2 text-right">{formatNumber(r.clienti)}</td>
                        <td className="px-3 py-2 text-right">
                          <span className="chip" style={{borderColor:getColorByPerformance(r.pct||0), color:getColorByPerformance(r.pct||0)}}>
                            {r.pct!=null ? formatPercent(r.pct) : '‚Äî'}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );
    }

    function TabAgenti({ data }){
      const [agSel, setAgSel] = React.useState(data.agenti?.[0]?.codice || '');
      const agente = React.useMemo(()=> (data.agenti||[]).find(a=>a.codice===agSel) || data.agenti?.[0], [agSel, data]);

      const fattProv = React.useMemo(()=>{
        const arr = (agente?.clienti_per_provincia||[]).map(v=>({ provincia:v.provincia, fatturato:v.fatturato||0 }));
        return arr.sort((a,b)=>b.fatturato-a.fatturato);
      }, [agente]);

      const top5Pie = React.useMemo(()=> fattProv.slice(0,5).map(v=>({ name:v.provincia, value:v.fatturato })), [fattProv]);

      const pct = agente?.obiettivi?.generale?.percentuale_obiettivo ?? null;

      return (
        <div className="space-y-6">
          <div className="flex flex-wrap items-center gap-3">
            <label className="text-sm text-gray-600">Agente:</label>
            <select className="border rounded-lg px-3 py-2" value={agSel} onChange={e=>setAgSel(e.target.value)}>
              {(data.agenti||[]).map(a=> <option key={a.codice} value={a.codice}>{a.codice} ‚Äî {a.ragione_sociale}</option>)}
            </select>
          </div>

          <div className="card">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              <div><div className="kpi-label">Codice Agente</div><div className="kpi-value mt-1">{agente?.codice||'‚Äî'}</div></div>
              <div><div className="kpi-label">Ragione Sociale</div><div className="kpi-value mt-1">{agente?.ragione_sociale||'‚Äî'}</div></div>
              <div><div className="kpi-label">Periodo di riferimento</div><div className="kpi-value mt-1">{agente?.periodo||'‚Äî'}</div></div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-5">
            <KPI label="Fatturato Corrente" value={formatEuro(agente?.totali?.fatturato||0)} icon="‚Ç¨" />
            <KPI label="Obiettivo Assegnato" value={formatEuro(agente?.obiettivi?.generale?.obiettivo||0)} icon="üéØ" />
            <KPI label="% Ragg. Fatturato" value={pct!=null ? formatPercent(pct) : '‚Äî'} icon="‚úî" />
            <KPI label="Clienti Serviti" value={formatNumber(agente?.totali?.clienti||0)} icon="üë•" />
            <KPI label="Obiettivo Clienti" value={formatNumber(agente?.obiettivi?.generale?.obiettivo_clienti||0)} icon="üìå" />
            <KPI label="Variazione YoY" value={formatPercent(Math.abs(agente?.totali?.yoy||0))} delta={agente?.totali?.yoy||0} icon="‚Üï" />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <div className="card">
              <SectionTitle>Fatturato per Provincia</SectionTitle>
              <div style={{height: 360}}>
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={fattProv} margin={{left: 8, right: 16, top: 8, bottom: 8}}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="provincia" />
                    <YAxis tickFormatter={formatEuro} />
                    <Tooltip formatter={(v)=>formatEuro(v)} />
                    <Bar dataKey="fatturato" fill="#2563eb" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="card">
              <SectionTitle>Performance vs Obiettivo</SectionTitle>
              <Gauge value={pct || 0} />
            </div>
          </div>

          <div className="card">
            <SectionTitle>Top Province (distribuzione)</SectionTitle>
            <div style={{height: 320}}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={top5Pie} dataKey="value" nameKey="name" outerRadius={110} label>
                    {top5Pie.map((_, i)=> <Cell key={i} fill={['#2563eb','#10b981','#f59e0b','#ef4444','#60a5fa'][i%5]} />)}
                  </Pie>
                  <Tooltip formatter={(v)=>formatEuro(v)} />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
            <div className="card"><div className="kpi-label">Migliore Provincia</div><div className="kpi-value mt-1">{fattProv[0]?.provincia || '‚Äî'}</div></div>
            <div className="card"><div className="kpi-label">Province Coperte</div><div className="kpi-value mt-1">{fattProv.length}</div></div>
            <div className="card"><div className="kpi-label">Media Fatt./Cliente</div><div className="kpi-value mt-1">
              {formatEuro((agente?.totali?.clienti||0) ? (agente?.totali?.fatturato||0)/(agente?.totali?.clienti||1) : 0)}
            </div></div>
          </div>
        </div>
      );
    }

    function App(){
      const [tab, setTab] = React.useState('panoramica');
      const data = dataSrc;
      return (
        <div className="max-w-7xl mx-auto px-4 py-8">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-primary text-white font-bold flex items-center justify-center">CC</div>
              <div>
                <div className="font-bold text-xl">Cotto Cusimano</div>
                <div className="text-gray-500 text-sm">Dashboard B2B ‚Äî Rete Commerciale</div>
              </div>
            </div>
            <div className="text-sm text-gray-500">Ultimo aggiornamento: <span id="updated">oggi</span></div>
          </div>

          <div className="mt-6 flex flex-wrap gap-2">
            <button className={\`tab-btn \${tab==='panoramica'?'tab-btn-active':''}\`} onClick={()=>setTab('panoramica')}>Panoramica Generale</button>
            <button className={\`tab-btn \${tab==='regioni'?'tab-btn-active':''}\`} onClick={()=>setTab('regioni')}>Regioni</button>
            <button className={\`tab-btn \${tab==='agenti'?'tab-btn-active':''}\`} onClick={()=>setTab('agenti')}>Agenti</button>
          </div>

          <div className="mt-6">
            {tab==='panoramica' && <TabPanoramica data={data} />}
            {tab==='regioni'    && <TabRegioni data={data} />}
            {tab==='agenti'     && <TabAgenti data={data} />}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
