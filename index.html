<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Performance Agenti ‚Ä¢ Cotto Cusimano</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>

  <!-- SheetJS (opzionale: export Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --terracotta:#D2691E;     /* chocolate */
      --terracotta-2:#CD853F;   /* peru */
      --accent:#b85c1a;
      --light:#ffffff;
      --muted:#6b7280;
      --stroke:#e6e6e6;
      --bg:#ffffff;
      --text:#0b1320;
      --good:#16a34a;
      --bad:#dc2626;
      --chip:#f7efe9;
    }
    *{ box-sizing: border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, Segoe UI, Roboto, system-ui, -apple-system, sans-serif }
    .wrap{ max-width:1280px; margin:0 auto; padding:20px }

    /* Header */
    header{ display:grid; grid-template-columns: 220px 1fr auto; gap:16px; align-items:center; }
    @media (max-width: 900px){ header{ grid-template-columns: 1fr } }
    .brand{ display:flex; align-items:center; gap:12px }
    .brand .logo{
      width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,var(--terracotta),var(--terracotta-2));
      display:flex; align-items:center; justify-content:center; color:white; font-weight:700;
    }
    .title{ text-align:center }
    .title h1{ margin:0; font-size:22px; }
    .title .sub{ color:var(--muted); font-size:12px; margin-top:4px }
    .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
    .btn{ border:1px solid var(--stroke); background:#fff; color:var(--text); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer }
    .btn:hover{ border-color:#d8d8d8 }

    /* Filters bar */
    .bar{ margin-top:16px; display:grid; grid-template-columns: 1.5fr 1fr 1fr auto; gap:10px; }
    @media (max-width: 900px){ .bar{ grid-template-columns: 1fr } }
    select, input[type="month"]{
      width:100%; border:1px solid var(--stroke); background:#fff; color:var(--text); border-radius:10px; padding:8px 12px; font-size:13px;
    }

    /* Cards */
    .grid{ display:grid; gap:12px }
    .g4{ grid-template-columns: repeat(4, 1fr) }
    .g2{ grid-template-columns: repeat(2, 1fr) }
    @media (max-width: 1100px){ .g4{ grid-template-columns: repeat(2, 1fr) } }
    @media (max-width: 600px){ .g4, .g2{ grid-template-columns: 1fr } }

    .card{
      background:#fff; border:1px solid var(--stroke); border-radius:14px; padding:14px;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
    }
    .kpi{ display:flex; align-items:center; gap:12px }
    .kpi .ico{
      width:36px; height:36px; border-radius:10px; background:var(--chip); display:flex; align-items:center; justify-content:center;
      color:var(--terracotta); font-weight:700;
    }
    .kpi .val{ font-size:26px; font-weight:700 }
    .kpi .delta{ font-size:12px; display:flex; align-items:center; gap:6px }
    .muted{ color:var(--muted); font-size:12px }

    /* Charts layout */
    canvas{ width:100%; height:340px }
    .section-title{ font-weight:600; margin-bottom:8px }

    /* DataTable */
    table{ width:100% }
    table.dataTable thead th{ background:#fafafa }
    .right{ text-align:right }
    tbody tr:hover{ background:#fff7f1 }

    /* Terracotta gradient helper for charts */
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo">CC</div>
        <div>
          <div style="font-weight:700">Cotto Cusimano</div>
          <div class="muted">Materiali edilizi in terracotta</div>
        </div>
      </div>
      <div class="title">
        <h1>Dashboard Performance Agenti</h1>
        <div class="sub">Ultimo aggiornamento: <span id="updated">‚Äî</span></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnExportXlsx">Esporta Excel</button>
        <button class="btn" id="btnPrint">Stampa / PDF</button>
        <button class="btn" id="btnShare">Condividi</button>
      </div>
    </header>

    <!-- FILTERS -->
    <div class="bar">
      <select id="selAgente">
        <option value="">Tutti gli agenti</option>
      </select>
      <select id="selProvincia">
        <option value="">Tutte le province</option>
      </select>
      <input id="selPeriodo" type="month" />
      <button class="btn" id="btnReset">Reset filtri</button>
    </div>

    <!-- KPI CARDS -->
    <div class="grid g4" style="margin-top:16px;">
      <div class="card">
        <div class="muted">Fatturato totale</div>
        <div class="kpi">
          <div class="ico">‚Ç¨</div>
          <div>
            <div class="val" id="kpiFatturato">‚Äî</div>
            <div class="delta" id="kpiFattDelta"><span class="muted">vs prec.</span></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Clienti attivi</div>
        <div class="kpi">
          <div class="ico">üë•</div>
          <div>
            <div class="val" id="kpiClienti">‚Äî</div>
            <div class="delta muted" id="kpiClientiDelta">‚Äî</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Ordini totali</div>
        <div class="kpi">
          <div class="ico">üì¶</div>
          <div>
            <div class="val" id="kpiOrdini">‚Äî</div>
            <div class="delta muted">Proxy: vendite cliente</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Valore medio ordine</div>
        <div class="kpi">
          <div class="ico">√ò</div>
          <div>
            <div class="val" id="kpiAOV">‚Äî</div>
            <div class="delta muted">Fatt/Ordini</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Tasso di crescita</div>
        <div class="kpi">
          <div class="ico">‚Üó</div>
          <div>
            <div class="val" id="kpiGrowth">‚Äî</div>
            <div class="delta" id="kpiGrowthIcon"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Target raggiunto</div>
        <div class="kpi">
          <div class="ico">üéØ</div>
          <div>
            <div class="val" id="kpiTarget">‚Äî</div>
            <div class="delta muted">Provincia ‚ÄúGenerale‚Äù</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="grid g2" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Performance agenti per fatturato</div>
        <canvas id="chartBarAgenti"></canvas>
      </div>
      <div class="card">
        <div class="section-title">Trend fatturato (mensile/trimestrale)</div>
        <div class="muted" id="trendNote" style="margin-bottom:6px;"></div>
        <canvas id="chartLineTrend"></canvas>
      </div>
    </div>

    <!-- ANALISI PER PROVINCIA -->
    <div class="grid g2" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Distribuzione fatturato per provincia</div>
        <canvas id="chartDonutProv"></canvas>
      </div>
      <div class="card">
        <div class="section-title">Top 3 province per fatturato</div>
        <div id="top3Prov" class="muted">‚Äî</div>
      </div>
    </div>

    <!-- TABELLA DETTAGLIATA -->
    <div class="card" style="margin-top:16px;">
      <div class="section-title">Dettaglio performance</div>
      <table id="tbl" class="display">
        <thead>
          <tr>
            <th>Nome Agente</th>
            <th>Provincia</th>
            <th class="right">N¬∞ Clienti</th>
            <th class="right">N¬∞ Ordini</th>
            <th class="right">Fatturato (‚Ç¨)</th>
            <th class="right">Val. medio ordine</th>
            <th class="right">% Target</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:8px;">Ordinamento, ricerca e evidenziazione sono attivi (DataTables).</div>
    </div>
  </div>

  <script>
    // ---------------------- Helpers ----------------------
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
    const fmtINT = new Intl.NumberFormat('it-IT');
    const asNum = v => (typeof v === 'number') ? v : Number(v||0);

    const state = {
      raw: [],
      rows: [],
      agenti: [],
      province: [],
      filtroAgente: '',
      filtroProv: '',
      filtroPeriodo: '' // non presente nei dati: usato solo come metadato UI
    };

    const byTipo = (rows,t) => rows.filter(r => r.Tipo_Dato === t);

    // Chart refs
    let chBarAg=null, chTrend=null, chDonut=null;

    function destroyChart(c){ if(c && c.destroy) c.destroy(); }

    // Terracotta gradient
    function terracottaGradient(ctx){
      const g = ctx.createLinearGradient(0,0,0,340);
      g.addColorStop(0,'#D2691E'); // terracotta
      g.addColorStop(1,'#CD853F');
      return g;
    }

    // ---------------------- Data Loading ----------------------
    async function load(){
      const res = await fetch('/data', { cache:'no-store' });
      if (!res.ok) throw new Error('Fetch /data failed');
      const data = await res.json();
      state.raw = data.rows || [];
      state.rows = state.raw.slice();

      // meta
      document.getElementById('updated').textContent =
        new Date(data.updatedAt).toLocaleString('it-IT');

      // combo
      const agenti = [...new Set(state.rows.map(r => r.Agente_Nome || r.Agente_Codice).filter(Boolean))].sort();
      const province = [...new Set(state.rows.map(r => r.Provincia).filter(Boolean))].sort();
      state.agenti = agenti; state.province = province;

      const selA = document.getElementById('selAgente');
      const selP = document.getElementById('selProvincia');
      agenti.forEach(a => { const o=document.createElement('option'); o.value=a; o.textContent=a; selA.appendChild(o); });
      province.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; selP.appendChild(o); });

      // handlers
      selA.addEventListener('change', e=>{ state.filtroAgente=e.target.value; applyFilters(); });
      selP.addEventListener('change', e=>{ state.filtroProv=e.target.value; applyFilters(); });
      document.getElementById('selPeriodo').addEventListener('change', e=>{ state.filtroPeriodo=e.target.value; applyFilters(); });
      document.getElementById('btnReset').addEventListener('click', ()=>{
        state.filtroAgente=''; state.filtroProv=''; state.filtroPeriodo='';
        selA.value=''; selP.value=''; document.getElementById('selPeriodo').value='';
        applyFilters();
      });

      document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
      document.getElementById('btnShare').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(location.href); alert('Link copiato negli appunti'); }
        catch{ prompt('Copia il link:', location.href); }
      });
      document.getElementById('btnExportXlsx').addEventListener('click', exportXlsx);

      // first render
      applyFilters();
    }

    function applyFilters(){
      const { filtroAgente, filtroProv } = state;
      let rows = state.raw.slice();
      if (filtroAgente) rows = rows.filter(r => (r.Agente_Nome === filtroAgente) || (r.Agente_Codice === filtroAgente));
      if (filtroProv)   rows = rows.filter(r => r.Provincia === filtroProv);
      state.rows = rows;
      render();
    }

    // ---------------------- KPIs ----------------------
    function computeKPIs(rows){
      const tot = byTipo(rows,'TOTALE');
      const fatt = tot.find(r => r.Descrizione === 'Fatturato_Totale');
      const cli  = tot.find(r => r.Descrizione === 'Clienti_Totale');

      const fattVal = asNum(fatt?.Valore||0);
      const cliVal  = asNum(cli?.Valore||0);

      // ordini proxy = numero VENDITE_CLIENTE
      const ordini = byTipo(rows,'VENDITE_CLIENTE').length;
      const aov = ordini ? (fattVal / ordini) : 0;

      // crescita = (Anno_Corrente - Anno_Precedente)/Anno_Precedente
      const obGen = byTipo(rows,'OBIETTIVI').find(r => (r.Provincia === 'Generale'));
      const prec = asNum(obGen?.Anno_Precedente||0);
      const curr = asNum(obGen?.Anno_Corrente||0);
      const growth = (prec > 0) ? ((curr - prec) / prec) : null;

      // target raggiunto (%)
      const target = (typeof obGen?.Percentuale_Obiettivo === 'number') ? obGen.Percentuale_Obiettivo : null;

      return { fattVal, cliVal, ordini, aov, growth, target };
    }

    function renderKPIs(rows){
      const { fattVal, cliVal, ordini, aov, growth, target } = computeKPIs(rows);
      document.getElementById('kpiFatturato').textContent = fmtEUR.format(fattVal);
      document.getElementById('kpiClienti').textContent   = fmtINT.format(cliVal);
      document.getElementById('kpiOrdini').textContent    = fmtINT.format(ordini);
      document.getElementById('kpiAOV').textContent       = (ordini?fmtEUR.format(aov):'‚Äî');

      const gEl = document.getElementById('kpiGrowth');
      const gi  = document.getElementById('kpiGrowthIcon');
      if (growth==null){ gEl.textContent='‚Äî'; gi.textContent=''; }
      else{
        const perc = (growth*100);
        gEl.textContent = perc.toFixed(1)+'%';
        gi.innerHTML = perc>=0
          ? `<span style="color:var(--good)">‚ñ≤ in crescita</span>`
          : `<span style="color:var(--bad)">‚ñº in calo</span>`;
      }

      document.getElementById('kpiTarget').textContent =
        (typeof target==='number') ? target.toFixed(2)+'%' : '‚Äî';

      // delta fatturato vs precedente (se disponibile)
      const obGen = byTipo(rows,'OBIETTIVI').find(r => (r.Provincia === 'Generale'));
      const prec = asNum(obGen?.Anno_Precedente||0);
      const deltaEl = document.getElementById('kpiFattDelta');
      if (prec>0){
        const d = ((asNum(obGen?.Anno_Corrente||0) - prec)/prec)*100;
        deltaEl.innerHTML = (d>=0)
          ? `<span style="color:var(--good)">‚ñ≤ ${d.toFixed(1)}%</span>`
          : `<span style="color:var(--bad)">‚ñº ${d.toFixed(1)}%</span>`;
      } else deltaEl.textContent = '‚Äî';
    }

    // ---------------------- Charts ----------------------
    function renderBarAgenti(rows){
      const byAgent = {};
      rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE').forEach(r=>{
        const a = r.Agente_Nome || r.Agente_Codice || '‚Äî';
        byAgent[a] = (byAgent[a]||0) + asNum(r.Fatturato||0);
      });
      const pairs = Object.entries(byAgent).sort((a,b)=>b[1]-a[1]);
      const labels = pairs.map(p=>p[0]);
      const values = pairs.map(p=>p[1]);

      const ctx = document.getElementById('chartBarAgenti').getContext('2d');
      destroyChart(chBarAg);
      const grad = terracottaGradient(ctx);
      chBarAg = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Fatturato', data: values, backgroundColor: grad }] },
        options:{
          indexAxis:'y',
          responsive:true,
          plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ label:(c)=> fmtEUR.format(c.parsed.x||0) } }
          },
          scales:{
            x:{ ticks:{ callback:(v)=> fmtEUR.format(v) }, grid:{ color:'#eee' } },
            y:{ grid:{ display:false } }
          }
        }
      });
    }

    function renderTrend(rows){
      const note = document.getElementById('trendNote');
      // Non ci sono date nel dataset: mostro nota e sintetizzo 2 barre (prec/corrente)
      const obGen = byTipo(rows,'OBIETTIVI').find(r => r.Provincia==='Generale');
      const prec = asNum(obGen?.Anno_Precedente||0);
      const corr = asNum(obGen?.Anno_Corrente||0);
      note.textContent = 'Nota: dati temporali non presenti nel dataset. Visualizzazione sintetica anno precedente vs corrente.';

      const ctx = document.getElementById('chartLineTrend').getContext('2d');
      destroyChart(chTrend);
      const grad = terracottaGradient(ctx);
      chTrend = new Chart(ctx, {
        type:'line',
        data:{
          labels:['Anno precedente','Anno corrente'],
          datasets:[{ label:'Fatturato', data:[prec,corr], borderColor: grad, backgroundColor: grad, tension:.3, fill:false }]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmtEUR.format(c.parsed.y||0) } } },
          scales:{ y:{ ticks:{ callback:(v)=>fmtEUR.format(v) }, grid:{ color:'#f1f1f1' } } }
        }
      });
    }

    function renderDonutProvincia(rows){
      const perProv = {};
      rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE').forEach(r=>{
        const k=r.Provincia||'‚Äî';
        perProv[k]=(perProv[k]||0)+asNum(r.Fatturato||0);
      });
      const ordered = Object.entries(perProv).sort((a,b)=>b[1]-a[1]);
      const labels = ordered.map(e=>e[0]);
      const values = ordered.map(e=>e[1]);

      const top3 = ordered.slice(0,3).map(([k,v],i)=>`${i+1}. <b>${k}</b> ‚Äî ${fmtEUR.format(v)}`).join('<br>');
      document.getElementById('top3Prov').innerHTML = top3 || '‚Äî';

      const ctx = document.getElementById('chartDonutProv').getContext('2d');
      destroyChart(chDonut);
      chDonut = new Chart(ctx, {
        type:'doughnut',
        data:{ labels, datasets:[{ data: values }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // ---------------------- Table ----------------------
    let dt=null;
    function renderTable(rows){
      // Aggregazione per agente+provincia
      const key = r => (r.Agente_Nome||r.Agente_Codice||'‚Äî')+'|'+(r.Provincia||'‚Äî');
      const agg = {};
      rows.forEach(r=>{
        if (r.Tipo_Dato==='CLIENTI_PROVINCIA'){
          const k = (r.Agente_Nome||r.Agente_Codice||'‚Äî')+'|'+(r.Provincia||'‚Äî');
          if(!agg[k]) agg[k]={ agente:r.Agente_Nome||r.Agente_Codice||'‚Äî', prov:r.Provincia||'‚Äî', clienti:0, ordini:0, fatt:0, target:null, prec:0, corr:0 };
          agg[k].clienti += asNum(r.Clienti_Serviti||0);
          agg[k].fatt    += asNum(r.Fatturato||0);
        }
        if (r.Tipo_Dato==='VENDITE_CLIENTE'){
          const k = key(r);
          if(!agg[k]) agg[k]={ agente:r.Agente_Nome||r.Agente_Codice||'‚Äî', prov:r.Provincia||'‚Äî', clienti:0, ordini:0, fatt:0, target:null, prec:0, corr:0 };
          agg[k].ordini += 1;
          agg[k].fatt   += asNum(r.Fatturato||0);
        }
        if (r.Tipo_Dato==='OBIETTIVI' && r.Provincia!=='Generale'){
          const k = (r.Agente_Nome||r.Agente_Codice||'‚Äî')+'|'+(r.Provincia||'‚Äî');
          if(!agg[k]) agg[k]={ agente:r.Agente_Nome||r.Agente_Codice||'‚Äî', prov:r.Provincia||'‚Äî', clienti:0, ordini:0, fatt:0, target:null, prec:0, corr:0 };
          agg[k].target = (typeof r.Percentuale_Obiettivo==='number') ? r.Percentuale_Obiettivo : agg[k].target;
          agg[k].prec   = asNum(r.Anno_Precedente||agg[k].prec);
          agg[k].corr   = asNum(r.Anno_Corrente||agg[k].corr);
        }
      });

      const rowsOut = Object.values(agg).map(o=>{
        const aov = (o.ordini>0) ? (o.fatt/o.ordini) : 0;
        const trendUp = (o.corr>=o.prec);
        return [
          o.agente,
          o.prov,
          fmtINT.format(o.clienti),
          fmtINT.format(o.ordini),
          fmtEUR.format(o.fatt),
          fmtEUR.format(aov),
          (o.target!=null ? o.target.toFixed(2)+'%' : '‚Äî'),
          trendUp ? '‚ñ≤' : '‚ñº'
        ];
      });

      if (dt){ dt.destroy(); document.querySelector('#tbl tbody').innerHTML=''; }
      dt = new DataTable('#tbl', {
        data: rowsOut,
        columns: [
          { title:'Nome Agente' },
          { title:'Provincia' },
          { title:'N¬∞ Clienti' },
          { title:'N¬∞ Ordini' },
          { title:'Fatturato (‚Ç¨)' },
          { title:'Val. medio ordine' },
          { title:'% Target' },
          { title:'Trend' }
        ],
        order: [[4,'desc']],
        paging: true,
        pageLength: 10,
        searchable: true
      });
    }

    // ---------------------- Export ----------------------
    function exportXlsx(){
      const ws = XLSX.utils.json_to_sheet(state.rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DatiDashboard');
      XLSX.writeFile(wb, 'dashboard-cotto-cusimano.xlsx');
    }

    // ---------------------- Render orchestrator ----------------------
    function render(){
      const rows = state.rows;
      renderKPIs(rows);
      renderBarAgenti(rows);
      renderTrend(rows);
      renderDonutProvincia(rows);
      renderTable(rows);
    }

    // init
    load().catch(err=>{
      console.error(err);
      alert('Errore nel caricamento dati: '+err.message);
    });
  </script>
</body>
</html>
