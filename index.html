<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Executive Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #c2410c;         
      --primary-gradient: linear-gradient(135deg, #c2410c 0%, #ea580c 100%);
      --bg-body: #fffaf5;         
      --bg-card: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.85);
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: rgba(194, 65, 12, 0.08);
      --radius: 24px;
      --shadow-glow: 0 20px 40px -10px rgba(194, 65, 12, 0.15), 0 10px 20px -5px rgba(0,0,0,0.02);
      
      /* Trend Colors */
      --trend-up-bg: #dcfce7; --trend-up-text: #15803d;
      --trend-down-bg: #fee2e2; --trend-down-text: #b91c1c;
    }

    * { box-sizing: border-box; outline: none; }
    
    body { 
      margin: 0; background: var(--bg-body); color: var(--text-main); 
      font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 80px; 
      background-image: radial-gradient(at 0% 0%, rgba(194, 65, 12, 0.03) 0px, transparent 50%), 
                        radial-gradient(at 100% 0%, rgba(234, 88, 12, 0.03) 0px, transparent 50%);
      background-attachment: fixed;
    }

    .animate-in { animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(20px); }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    .container { max-width: 1500px; margin: 0 auto; padding: 0 32px; }

    /* HEADER */
    header {
      background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      padding: 20px 0; margin-bottom: 40px;
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px; }
    .brand { display: flex; align-items: center; gap: 16px; }
    .logo { 
      width: 52px; height: 52px; background: var(--primary-gradient);
      border-radius: 16px; color: #fff; display: grid; place-items: center; font-weight: 800; font-size: 22px;
      box-shadow: 0 8px 20px rgba(194, 65, 12, 0.3);
    }
    .h-title { font-size: 24px; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: var(--text-main); }
    .h-sub { font-size: 14px; color: var(--text-muted); font-weight: 600; }
    
    /* CONTROLS */
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .select-wrapper { position: relative; display: inline-block; }
    select {
      background: #fff; border: 1px solid #e2e8f0;
      padding: 12px 36px 12px 16px; border-radius: 12px; 
      font-size: 13px; font-weight: 600; color: var(--text-main); 
      cursor: pointer; min-width: 160px; appearance: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .sel-arrow { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted); }
    .btn {
      background: #fff; border: 1px solid #e2e8f0; padding: 12px 20px; border-radius: 12px; 
      font-size: 13px; font-weight: 700; cursor: pointer; display: inline-flex; gap: 8px; align-items: center;
      color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .btn:hover { transform: translateY(-2px); }

    /* CARDS */
    .card {
      background: linear-gradient(180deg, #ffffff 0%, #fffbf8 100%);
      border-radius: var(--radius); padding: 32px;
      box-shadow: var(--shadow-glow); border: 1px solid rgba(255,255,255,0.6);
      display: flex; flex-direction: column; height: 100%;
    }
    .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .grid-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px; }
    .grid-charts-rev { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 32px; }
    @media (max-width: 1200px) { .grid-charts, .grid-charts-rev { grid-template-columns: 1fr; } }

    /* KPI */
    .kpi-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; min-height: 48px; }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .kpi-icon-wrap {
      width: 48px; height: 48px; border-radius: 14px; flex-shrink: 0;
      background: linear-gradient(135deg, #fff5eb 0%, #fff0e0 100%);
      color: var(--primary); display: grid; place-items: center; font-size: 22px;
    }
    .kpi-body { margin-top: auto; display: flex; flex-direction: column; justify-content: flex-end; }
    .kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--text-main); letter-spacing: -1.5px; line-height: 1.1; margin-bottom: 8px; }
    .kpi-sub { font-size: 13px; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
    
    /* TREND BADGE */
    .trend-badge { 
      display: inline-flex; align-items: center; gap: 4px; 
      padding: 6px 10px; border-radius: 8px; 
      font-size: 13px; font-weight: 700; 
    }
    .trend-up { background: var(--trend-up-bg); color: var(--trend-up-text); border: 1px solid #bbf7d0; }
    .trend-down { background: var(--trend-down-bg); color: var(--trend-down-text); border: 1px solid #fecaca; }

    .card-dark { background: radial-gradient(circle at top right, #334155 0%, #0f172a 100%); color: white; }
    .card-dark .kpi-label { color: rgba(255,255,255,0.5); }
    .card-dark .kpi-icon-wrap { background: rgba(255,255,255,0.1); color: #fbbf24; }
    .card-dark .kpi-val { color: #fff; font-size:18px; font-family:'Plus Jakarta Sans', sans-serif; letter-spacing: 0; margin-bottom: 4px; }
    .card-dark .money-gold { color: #fbbf24; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 24px; }

    /* CHART HEADER */
    .chart-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .chart-title { font-size: 18px; font-weight: 700; margin: 0; }
    .chart-badge { background: #fff7ed; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }

    /* TABLE */
    table.dataTable { width: 100% !important; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
    table.dataTable thead th { background: transparent; padding: 16px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; border-bottom: 2px solid var(--border) !important; }
    table.dataTable tbody td { padding: 20px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; font-weight: 500; }
    .badge-pill { padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .badge-geo { background: #f1f5f9; color: #475569; }
    .badge-prov { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .money-cell { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); font-size: 15px; }

    /* LOADING */
    #loading { position: fixed; inset: 0; background: #fffaf5; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease; }
    .loader-ring { width: 50px; height: 50px; border: 4px solid rgba(194, 65, 12, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading">
    <div class="loader-ring"></div>
    <p id="loadingText" style="font-weight:700; color:var(--primary); text-transform:uppercase; font-size:12px;">Caricamento...</p>
  </div>

  <header>
    <div class="container header-inner">
      <div class="brand">
        <div class="logo">CC</div>
        <div><h1 class="h-title">Cotto Cusimano</h1><div class="h-sub">Executive Dashboard</div></div>
      </div>
      <div class="controls">
        <div class="select-wrapper"><select id="selAgente"><option value="">Tutti gli Agenti</option></select><i class="ri-user-3-line sel-arrow"></i></div>
        <div class="select-wrapper"><select id="selRegione" style="border-color:#fbbf24; background:#fffdf5"><option value="">Filtra Regione</option></select><i class="ri-map-2-line sel-arrow" style="color:#d97706"></i></div>
        <div class="select-wrapper"><select id="selProvincia"><option value="">Tutte le Province</option></select><i class="ri-map-pin-range-line sel-arrow"></i></div>
        <button class="btn" id="btnReset"><i class="ri-refresh-line"></i> Reset</button>
        <button class="btn" id="btnExcel" style="background:#fff7ed; color:#c2410c; border-color:#ffedd5"><i class="ri-file-excel-2-line"></i> Export</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid-kpi animate-in">
      
      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Fatturato Totale</span><div class="kpi-icon-wrap"><i class="ri-money-euro-circle-line"></i></div></div>
        <div class="kpi-body">
            <div class="kpi-val" id="kpiFatturato">€ 0</div>
            <div class="kpi-sub" id="kpiTrendContainer">Caricamento trend...</div>
        </div>
      </div>
      
      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Clienti Attivi</span><div class="kpi-icon-wrap"><i class="ri-building-2-line"></i></div></div>
        <div class="kpi-body"><div class="kpi-val" id="kpiClienti">0</div><div class="kpi-sub">Aziende in portafoglio</div></div>
      </div>

      <div class="card">
        <div class="kpi-head"><span class="kpi-label">Obiettivo Annuale</span><div class="kpi-icon-wrap"><i class="ri-focus-3-line"></i></div></div>
        <div class="kpi-body">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; width:100%">
                <div><div class="kpi-val" id="kpiTargetVal">0%</div><div class="kpi-sub">Completamento</div></div>
                <div id="miniRadial" style="margin-bottom:-10px; margin-right:-10px"></div>
            </div>
        </div>
      </div>
      
      <div class="card card-dark">
        <div class="kpi-head"><span class="kpi-label">Top Performer</span><div class="kpi-icon-wrap"><i class="ri-trophy-fill"></i></div></div>
        <div class="kpi-body"><div id="kpiTopAgent" class="kpi-val" style="font-size:18px">--</div><div id="kpiTopAgentVal" class="money-gold">€ 0</div></div>
      </div>
    </div>

    <div class="grid-charts animate-in" style="animation-delay:0.2s">
      <div class="card"><div class="chart-header"><h3 class="chart-title">Classifica Agenti</h3><span class="chart-badge">Fatturato</span></div><div id="chartBar"></div></div>
      <div class="card"><div class="chart-header"><h3 class="chart-title">Macro Aree</h3><span class="chart-badge">Geografia</span></div><div id="chartDonut" style="display:flex; justify-content:center; align-items:center; height:100%"></div></div>
    </div>

    <div class="grid-charts-rev animate-in" style="animation-delay:0.3s">
      <div class="card"><div class="chart-header"><h3 class="chart-title">Peso Province</h3><span class="chart-badge">Impatto %</span></div><div id="chartPolar" style="display:flex; justify-content:center"></div></div>
      <div class="card"><div class="chart-header"><h3 class="chart-title">Top 5 Clienti</h3><span class="chart-badge">Strategici</span></div><div id="chartClients"></div></div>
    </div>

    <div class="card animate-in" style="animation-delay:0.4s">
      <div class="chart-header"><h3 class="chart-title">Dettaglio Transazioni</h3><div style="margin-left:auto;font-size:12px;color:var(--text-muted)">Ultimi dati sync</div></div>
      <table id="tbl" class="display hover" style="width:100%"></table>
    </div>

    <div style="text-align:center; margin-top:60px; font-size:12px; color:var(--text-muted); font-weight:500">
      Cotto Cusimano Analytics System • Aggiornato: <span id="lastUpdate" style="color:var(--primary)">--</span>
    </div>
  </div>

  <script>
    // 1. Errori
    window.addEventListener('error', function(e) {
        const l=document.getElementById('loading'), t=document.getElementById('loadingText');
        if(l&&t){ l.style.opacity=1; l.style.zIndex=99999; t.style.color='red'; t.innerHTML=`ERRORE:<br>${e.message}`; }
    });

    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const asNum = v => (typeof v === 'number') ? v : Number((v||"0").toString().replace(/\./g, '').replace(',', '.') || 0);

    // Geo Mapping
    const GEO_DATA = {'AG':{n:'Agrigento',r:'Sicilia'},'AL':{n:'Alessandria',r:'Piemonte'},'AN':{n:'Ancona',r:'Marche'},'AO':{n:'Aosta',r:'Valle d\'Aosta'},'AR':{n:'Arezzo',r:'Toscana'},'AP':{n:'Ascoli Piceno',r:'Marche'},'AT':{n:'Asti',r:'Piemonte'},'AV':{n:'Avellino',r:'Campania'},'BA':{n:'Bari',r:'Puglia'},'BT':{n:'Barletta-Andria-Trani',r:'Puglia'},'BL':{n:'Belluno',r:'Veneto'},'BN':{n:'Benevento',r:'Campania'},'BG':{n:'Bergamo',r:'Lombardia'},'BI':{n:'Biella',r:'Piemonte'},'BO':{n:'Bologna',r:'Emilia-Romagna'},'BZ':{n:'Bolzano',r:'Trentino-Alto Adige'},'BS':{n:'Brescia',r:'Lombardia'},'BR':{n:'Brindisi',r:'Puglia'},'CA':{n:'Cagliari',r:'Sardegna'},'CL':{n:'Caltanissetta',r:'Sicilia'},'CB':{n:'Campobasso',r:'Molise'},'CI':{n:'Carbonia-Iglesias',r:'Sardegna'},'CE':{n:'Caserta',r:'Campania'},'CT':{n:'Catania',r:'Sicilia'},'CZ':{n:'Catanzaro',r:'Calabria'},'CH':{n:'Chieti',r:'Abruzzo'},'CO':{n:'Como',r:'Lombardia'},'CS':{n:'Cosenza',r:'Calabria'},'CR':{n:'Cremona',r:'Lombardia'},'KR':{n:'Crotone',r:'Calabria'},'CN':{n:'Cuneo',r:'Piemonte'},'EN':{n:'Enna',r:'Sicilia'},'FM':{n:'Fermo',r:'Marche'},'FE':{n:'Ferrara',r:'Emilia-Romagna'},'FI':{n:'Firenze',r:'Toscana'},'FG':{n:'Foggia',r:'Puglia'},'FC':{n:'Forlì-Cesena',r:'Emilia-Romagna'},'FR':{n:'Frosinone',r:'Lazio'},'GE':{n:'Genova',r:'Liguria'},'GO':{n:'Gorizia',r:'Friuli-Venezia Giulia'},'GR':{n:'Grosseto',r:'Toscana'},'IM':{n:'Imperia',r:'Liguria'},'IS':{n:'Isernia',r:'Molise'},'SP':{n:'La Spezia',r:'Liguria'},'AQ':{n:'L\'Aquila',r:'Abruzzo'},'LT':{n:'Latina',r:'Lazio'},'LE':{n:'Lecce',r:'Puglia'},'LC':{n:'Lecco',r:'Lombardia'},'LI':{n:'Livorno',r:'Toscana'},'LO':{n:'Lodi',r:'Lombardia'},'LU':{n:'Lucca',r:'Toscana'},'MC':{n:'Macerata',r:'Marche'},'MN':{n:'Mantova',r:'Lombardia'},'MS':{n:'Massa-Carrara',r:'Toscana'},'MT':{n:'Matera',r:'Basilicata'},'VS':{n:'Medio Campidano',r:'Sardegna'},'ME':{n:'Messina',r:'Sicilia'},'MI':{n:'Milano',r:'Lombardia'},'MO':{n:'Modena',r:'Emilia-Romagna'},'MB':{n:'Monza e Brianza',r:'Lombardia'},'NA':{n:'Napoli',r:'Campania'},'NO':{n:'Novara',r:'Piemonte'},'NU':{n:'Nuoro',r:'Sardegna'},'OG':{n:'Ogliastra',r:'Sardegna'},'OT':{n:'Olbia-Tempio',r:'Sardegna'},'OR':{n:'Oristano',r:'Sardegna'},'PD':{n:'Padova',r:'Veneto'},'PA':{n:'Palermo',r:'Sicilia'},'PR':{n:'Parma',r:'Emilia-Romagna'},'PV':{n:'Pavia',r:'Lombardia'},'PG':{n:'Perugia',r:'Umbria'},'PU':{n:'Pesaro e Urbino',r:'Marche'},'PE':{n:'Pescara',r:'Abruzzo'},'PC':{n:'Piacenza',r:'Emilia-Romagna'},'PI':{n:'Pisa',r:'Toscana'},'PT':{n:'Pistoia',r:'Toscana'},'PN':{n:'Pordenone',r:'Friuli-Venezia Giulia'},'PZ':{n:'Potenza',r:'Basilicata'},'PO':{n:'Prato',r:'Toscana'},'RG':{n:'Ragusa',r:'Sicilia'},'RA':{n:'Ravenna',r:'Emilia-Romagna'},'RC':{n:'Reggio Calabria',r:'Calabria'},'RE':{n:'Reggio Emilia',r:'Emilia-Romagna'},'RI':{n:'Rieti',r:'Lazio'},'RN':{n:'Rimini',r:'Emilia-Romagna'},'RM':{n:'Roma',r:'Lazio'},'RO':{n:'Rovigo',r:'Veneto'},'SA':{n:'Salerno',r:'Campania'},'SS':{n:'Sassari',r:'Sardegna'},'SV':{n:'Savona',r:'Liguria'},'SI':{n:'Siena',r:'Toscana'},'SR':{n:'Siracusa',r:'Sicilia'},'SO':{n:'Sondrio',r:'Lombardia'},'TA':{n:'Taranto',r:'Puglia'},'TE':{n:'Teramo',r:'Abruzzo'},'TR':{n:'Terni',r:'Umbria'},'TO':{n:'Torino',r:'Piemonte'},'TP':{n:'Trapani',r:'Sicilia'},'TN':{n:'Trento',r:'Trentino-Alto Adige'},'TV':{n:'Treviso',r:'Veneto'},'TS':{n:'Trieste',r:'Friuli-Venezia Giulia'},'UD':{n:'Udine',r:'Friuli-Venezia Giulia'},'VA':{n:'Varese',r:'Lombardia'},'VE':{n:'Venezia',r:'Veneto'},'VB':{n:'Verbano-Cusio-Ossola',r:'Piemonte'},'VC':{n:'Vercelli',r:'Piemonte'},'VR':{n:'Verona',r:'Veneto'},'VV':{n:'Vibo Valentia',r:'Calabria'},'VI':{n:'Vicenza',r:'Veneto'},'VT':{n:'Viterbo',r:'Lazio'}};

    let state = { all: [], rows: [] };
    let charts = { bar: null, donut: null, radial: null, clients: null, polar: null };
    let dataTable = null;

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            if(!res.ok) throw new Error(`Server Error ${res.status}`);
            const data = await res.json();

            // 1. Preparazione Dati
            state.all = (data.rows || []).map(r => {
                if(r.Provincia) {
                    const code = r.Provincia.trim().toUpperCase();
                    // Mappiamo solo se non è "Generale" (riga obiettivi)
                    if (code !== 'GENERALE' && GEO_DATA[code]) {
                        r.Provincia = GEO_DATA[code].n; 
                        r.Regione = GEO_DATA[code].r; 
                    } else if (code !== 'GENERALE') {
                        r.Regione = 'Altro';
                    }
                } else { r.Regione = 'N/D'; }
                return r;
            });
            state.rows = [...state.all];
            
            if(data.updatedAt) document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString();

            populateFilters();
            initCharts();
            updateDashboard();

            // Rimuovi Loader
            const l=document.getElementById('loading');
            l.style.opacity='0'; setTimeout(()=>l.remove(), 500);

        } catch (err) {
            const t=document.getElementById('loadingText');
            t.innerHTML=`ERRORE:<br>${err.message}`; t.style.color='red';
        }

        // Eventi
        ['selAgente','selRegione','selProvincia'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
        
        document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('selAgente').value="";
            document.getElementById('selRegione').value="";
            document.getElementById('selProvincia').value="";
            applyFilters();
        });

        document.getElementById('btnExcel').addEventListener('click', () => {
             const ws = XLSX.utils.json_to_sheet(state.rows.filter(r=>r.Tipo_Dato==='VENDITE_CLIENTE'));
             const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Dati");
             XLSX.writeFile(wb, "CottoCusimano_Export.xlsx");
        });
    });

    function populateFilters() {
        // Usiamo solo le righe VENDITE_CLIENTE per popolare i filtri
        const rows = state.all.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const ag = [...new Set(rows.map(r => (r.Agente_Nome||r.Agente_Codice||'').trim()))].filter(Boolean).sort();
        const reg = [...new Set(rows.map(r => r.Regione))].filter(x => x && x!=='N/D' && x!=='Altro').sort();
        const prov = [...new Set(rows.map(r => (r.Provincia||'').trim()))].filter(Boolean).sort();
        
        const sA=$('#selAgente'), sR=$('#selRegione'), sP=$('#selProvincia');
        ag.forEach(a => sA.innerHTML+=`<option value="${a}">${a}</option>`);
        reg.forEach(r => sR.innerHTML+=`<option value="${r}">${r}</option>`);
        prov.forEach(p => sP.innerHTML+=`<option value="${p}">${p}</option>`);
    }
    function $(s){ return document.querySelector(s); }

    function applyFilters() {
        const ag = $('#selAgente').value, reg = $('#selRegione').value, pr = $('#selProvincia').value;
        state.rows = state.all.filter(r => {
            if(r.Tipo_Dato !== 'VENDITE_CLIENTE') return true; // Mantieni obiettivi
            const rAg = (r.Agente_Nome||r.Agente_Codice||'').trim();
            return (!ag||rAg===ag) && (!reg||r.Regione===reg) && (!pr||(r.Provincia||'').trim()===pr);
        });
        updateDashboard();
    }

    function updateDashboard() {
        // Filtra solo vendite per i grafici
        const data = state.rows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE');
        const isFiltered = $('#selAgente').value || $('#selRegione').value || $('#selProvincia').value;

        // === LOGICA DI ESTRAZIONE FONDAMENTALE (dal tuo file trovato) ===
        // Cerca la riga speciale OBIETTIVI + Generale
        const obGen = state.all.find(r => r.Tipo_Dato === 'OBIETTIVI' && r.Provincia === 'Generale');
        
        let currYear = 0, prevYear = 0, pctTarget = 0;

        if (!isFiltered && obGen) {
            // Se non siamo filtrati, usiamo i totali "sacri" della riga obiettivi
            prevYear = asNum(obGen.Anno_Precedente);
            currYear = asNum(obGen.Anno_Corrente);
            pctTarget = obGen.Percentuale_Obiettivo || 0;
        } else {
            // Se siamo filtrati, calcoliamo al volo la somma del fatturato
            currYear = data.reduce((a,b) => a + asNum(b.Fatturato), 0);
            prevYear = 0; // Non abbiamo il precedente granulare per filtri
            pctTarget = 0; // O ricalcola se hai i target per agente
        }
        
        // KPI 1: Fatturato & Trend
        $('#kpiFatturato').textContent = fmtEUR.format(currYear);
        let trendHtml = '<span style="font-size:12px; color:var(--text-muted)">—</span>';
        
        if (prevYear > 0 && !isFiltered) {
            const diff = currYear - prevYear;
            const pct = (diff / prevYear) * 100;
            const isPos = pct >= 0;
            const icon = isPos ? 'ri-arrow-right-up-line' : 'ri-arrow-right-down-line';
            const cls = isPos ? 'trend-up' : 'trend-down';
            trendHtml = `<div class="trend-badge ${cls}"><i class="${icon}"></i> ${Math.abs(pct).toFixed(1)}%</div><span style="font-size:11px; color:var(--text-muted); margin-left:6px">vs ${fmtEUR.format(prevYear)}</span>`;
        } else if (isFiltered) {
             trendHtml = '<span style="font-size:11px; color:var(--text-muted)">Dato Filtrato</span>';
        }
        $('#kpiTrendContainer').innerHTML = trendHtml;

        // KPI 2: Clienti
        const totCli = new Set(data.map(r => r.Ragione_Sociale_Cliente)).size;
        $('#kpiClienti').textContent = totCli;

        // KPI 3: Target
        if(charts.radial) charts.radial.updateSeries([pctTarget]);
        $('#kpiTargetVal').textContent = Number(pctTarget).toFixed(1) + "%";

        // Top Agent
        const agMap={}; data.forEach(r=>{ const k=(r.Agente_Nome||'N/D'); agMap[k]=(agMap[k]||0)+asNum(r.Fatturato); });
        const top = Object.entries(agMap).sort((a,b)=>b[1]-a[1])[0];
        $('#kpiTopAgent').textContent = top ? top[0] : "—";
        $('#kpiTopAgentVal').textContent = top ? fmtEUR.format(top[1]) : "€ 0";

        // Update Charts...
        updateCharts(data, agMap);
        updateTable(data);
    }

    function updateCharts(data, agMap) {
        const agSorted = Object.entries(agMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        charts.bar.updateOptions({ xaxis: { categories: agSorted.map(x=>x[0]) } });
        charts.bar.updateSeries([{ data: agSorted.map(x=>x[1]) }]);

        const prMap={}; data.forEach(r=>{ const k=(r.Provincia||'?').trim(); prMap[k]=(prMap[k]||0)+asNum(r.Fatturato); });
        const prSorted = Object.entries(prMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
        charts.donut.updateOptions({ labels: prSorted.map(x=>x[0]) });
        charts.donut.updateSeries(prSorted.map(x=>x[1]));

        const clMap={}; data.forEach(r=>{ const k=r.Ragione_Sociale_Cliente||'N/D'; clMap[k]=(clMap[k]||0)+asNum(r.Fatturato); });
        const clSorted = Object.entries(clMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
        charts.clients.updateOptions({ xaxis: { categories: clSorted.map(x=>x[0]) } });
        charts.clients.updateSeries([{ data: clSorted.map(x=>x[1]) }]);

        const prSortedPolar = Object.entries(prMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
        charts.polar.updateOptions({ labels: prSortedPolar.map(x=>x[0]) });
        charts.polar.updateSeries(prSortedPolar.map(x=>x[1]));
    }

    function initCharts() {
        const font = "'Plus Jakarta Sans', sans-serif";
        
        charts.bar = new ApexCharts($('#chartBar'), {
            series: [{ name:'Fatturato', data:[] }],
            chart: { type:'bar', height:340, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'55%', distributed:true } },
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.25, inverseColors: true, opacityFrom: 0.85, opacityTo: 0.85, stops: [50, 0, 100] } },
            colors: ['#c2410c', '#ea580c', '#f97316', '#fdba74', '#94a3b8'],
            legend: { show:false }, dataLabels: { enabled:false }, grid: { show:false },
            xaxis: { labels: { formatter: v => "€ " + (v/1000).toFixed(0) + "k" } },
            tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.bar.render();

        charts.donut = new ApexCharts($('#chartDonut'), {
            series: [], labels: [],
            chart: { type:'donut', height:340, fontFamily:font },
            colors: ['#c2410c', '#334155', '#64748b', '#94a3b8', '#cbd5e1'],
            legend: { position:'bottom' }, dataLabels: { enabled:false }, tooltip: { theme:'dark' }
        });
        charts.donut.render();

        charts.clients = new ApexCharts($('#chartClients'), {
            series: [{ name:'Acquisti', data:[] }],
            chart: { type:'bar', height:320, fontFamily:font, toolbar:{show:false} },
            plotOptions: { bar: { horizontal:true, borderRadius:6, barHeight:'60%' } },
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.25, inverseColors: true, opacityFrom: 0.9, opacityTo: 0.9, stops: [50, 0, 100] } },
            colors: ['#c2410c'], 
            dataLabels: { enabled:true, formatter: v => "€ " + (v/1000).toFixed(1) + "k", offsetX: 0, style: { colors: ['#fff'], fontSize:'11px', fontWeight:700 } },
            xaxis: { show:false }, grid: { show:false }, 
            tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.clients.render();

        charts.polar = new ApexCharts($('#chartPolar'), {
            series: [], labels: [],
            chart: { type: 'polarArea', height: 340, fontFamily: font, toolbar:{show:false} },
            stroke: { colors: ['#fff'], width:1 }, fill: { opacity: 0.9 },
            colors: ['#78350f', '#9a3412', '#c2410c', '#d97706', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
            legend: { position: 'bottom' }, yaxis: { show: false }, tooltip: { theme:'dark', y: { formatter: v => fmtEUR.format(v) } }
        });
        charts.polar.render();

        charts.radial = new ApexCharts($('#miniRadial'), {
            series: [0],
            chart: { type:'radialBar', height:130, width:130, sparkline:{enabled:true} },
            plotOptions: { radialBar: { hollow: { size: '50%' }, track: { background: '#ffedd5', strokeWidth: '100%' }, dataLabels: { show: false } } },
            fill: { type: "gradient", gradient: { shade: "dark", type: "horizontal", gradientToColors: ["#fbbf24"], stops: [0, 100] } },
            colors: ['#c2410c'], stroke: { lineCap:'round' }
        });
        charts.radial.render();
    }

    function updateTable(data) {
        const body = data.map(r => [
            `<div style="font-weight:700; color:var(--text-main)">${r.Agente_Nome||'—'}</div>`,
            `<div><span class="badge-pill badge-geo"><i class="ri-map-2-line"></i> ${r.Regione}</span> <span class="badge-pill badge-prov">${r.Provincia}</span></div>`,
            `<div style="font-weight:600; color:#475569">${r.Ragione_Sociale_Cliente}</div>`,
            `<div class="money-cell">${fmtEUR.format(asNum(r.Fatturato))}</div>`
        ]);
        if (dataTable) dataTable.destroy();
        dataTable = new DataTable('#tbl', {
            data: body,
            columns: [{title:"Agente"},{title:"Area Geografica"},{title:"Cliente"},{title:"Fatturato", className:"dt-right"}],
            order: [[3,'desc']], pageLength: 10, lengthChange: false,
            language: { search:"_INPUT_", searchPlaceholder:"Cerca cliente o agente...", paginate:{next:">", previous:"<"}, info:"_START_ - _END_ di _TOTAL_" }
        });
    }
  </script>
</body>
</html>
