<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard B2B</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: "#0b1320",
            panel: "#0f172a",
            stroke: "#1e293b",
            text: "#e2e8f0",
            muted: "#94a3b8",
            brand: "#3b82f6",
            good: "#22c55e",
            warn: "#f59e0b",
          }
        }
      }
    }
  </script>

  <style>
    th, td { white-space: nowrap; }
    thead th { position: sticky; top: 0; background: #0b1320; }
  </style>
</head>
<body class="bg-bg text-text">
  <main class="max-w-7xl mx-auto p-6 grid gap-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Dashboard B2B</h1>
      <div class="flex items-center gap-2">
        <select id="agent" class="bg-panel border border-stroke rounded-xl px-3 py-2 text-sm"></select>
        <button id="refresh" class="px-4 py-2 bg-brand text-white rounded-xl font-medium">Aggiorna</button>
      </div>
    </header>

    <section id="kpis" class="grid grid-cols-2 md:grid-cols-4 gap-4"></section>

    <section id="sections" class="grid gap-6"></section>
  </main>

  <script>
    let RAW = [], CURRENT_AGENT = null, chartRefs = {};

    const el = id => document.getElementById(id);
    const fmt = n => (n==null||isNaN(n)) ? '—' : n.toLocaleString('it-IT',{maximumFractionDigits:2});

    async function loadData() {
      const res = await fetch('/data', {cache: 'no-store'});
      const data = await res.json();
      RAW = data.rows || [];
      buildAgentSelect();
      el('agent').dispatchEvent(new Event('change'));
    }

    function buildAgentSelect() {
      const agents = [...new Map(RAW.map(r => [r.Agente_Codice, r.Agente_Nome]))];
      el('agent').innerHTML = '<option value="">Tutti gli agenti</option>' +
        agents.map(([cod, nome]) => `<option value="${cod}">${nome || cod}</option>`).join('');
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, r) => {
        const k = r[key] || 'Generale';
        (acc[k] = acc[k] || []).push(r);
        return acc;
      }, {});
    }

    function drawKPI(agentRows) {
      const container = el('kpis');
      const fatturato = sum(agentRows, ['Fatturato','Importo_Totale','Importo','Anno_Corrente']);
      const clienti = sum(agentRows, ['Clienti_Serviti','Clienti_Totale','Clienti_Anno_Corrente']);
      const perc = avg(agentRows, ['Percentuale_Obiettivo','Percentuale_Obiettivo_Clienti']);
      const periodo = (agentRows.find(r => r.Periodo) || {}).Periodo || '';

      const cards = [
        {label:'Fatturato Totale', val:'€ '+fmt(fatturato)},
        {label:'Clienti Serviti', val:fmt(clienti)},
        {label:'Media % Obiettivo', val:fmt(perc)+'%'},
        {label:'Periodo', val:periodo},
      ];

      container.innerHTML = cards.map(c => `
        <div class="bg-panel border border-stroke rounded-2xl p-5">
          <div class="text-xs text-muted">${c.label}</div>
          <div class="text-2xl font-bold mt-1">${c.val}</div>
        </div>
      `).join('');
    }

    function sum(rows, keys) {
      return rows.reduce((acc,r)=>{
        for (const k of keys) if (r[k] && !isNaN(r[k])) return acc + parseFloat(r[k]);
        return acc;
      },0);
    }

    function avg(rows, keys) {
      const vals = [];
      for (const r of rows) {
        for (const k of keys) if (r[k] && !isNaN(r[k])) vals.push(parseFloat(r[k]));
      }
      return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
    }

    function buildSections(agentRows) {
      const bySection = groupBy(agentRows, '__Sezione');
      const container = el('sections');
      container.innerHTML = '';

      for (const [sec, rows] of Object.entries(bySection)) {
        const block = document.createElement('div');
        block.className = "bg-panel border border-stroke rounded-2xl p-5";
        block.innerHTML = `
          <h2 class="text-lg font-semibold mb-3">${sec}</h2>
          <div class="grid md:grid-cols-2 gap-4 items-start">
            <div><canvas id="chart_${sec}"></canvas></div>
            <div class="overflow-auto border border-stroke rounded-xl max-h-[300px]">
              <table class="w-full text-sm"><thead></thead><tbody></tbody></table>
            </div>
          </div>`;
        container.appendChild(block);

        drawTable(block.querySelector('table'), rows);
        drawChart(block.querySelector('canvas').id, sec, rows);
      }
    }

    function drawTable(tbl, rows) {
      if (!rows.length) {
        tbl.querySelector('thead').innerHTML = '<tr><th class="px-3 py-2 text-left text-muted">Nessun dato</th></tr>';
        return;
      }
      const cols = Object.keys(rows[0]);
      const head = '<tr>' + cols.map(c=>`<th class="px-3 py-2 text-left">${c}</th>`).join('') + '</tr>';
      const body = rows.slice(0,30).map(r=>
        '<tr class="border-b border-stroke/50">'+
        cols.map(c=>`<td class="px-3 py-1">${fmt(r[c])}</td>`).join('')+
        '</tr>'
      ).join('');
      tbl.querySelector('thead').innerHTML = head;
      tbl.querySelector('tbody').innerHTML = body;
    }

    function drawChart(id, section, rows) {
      const ctx = document.getElementById(id).getContext('2d');
      if (chartRefs[id]) chartRefs[id].destroy();

      let labels = [], data = [], type = 'bar', label = 'Valore';

      if (/OBIETTIVI/i.test(section)) {
        const group = groupBy(rows,'Provincia');
        labels = Object.keys(group);
        data = labels.map(p => sum(group[p], ['Anno_Corrente']));
        label = 'Anno Corrente';
      } else if (/CLIENTI/i.test(section)) {
        const group = groupBy(rows,'Provincia');
        labels = Object.keys(group);
        data = labels.map(p => sum(group[p], ['Fatturato','Clienti_Serviti']));
        label = 'Fatturato';
      } else if (/VENDITE/i.test(section)) {
        const top = rows.sort((a,b)=>b.Fatturato - a.Fatturato).slice(0,10);
        labels = top.map(r=>r.Ragione_Sociale_Cliente);
        data = top.map(r=>r.Fatturato);
        label = 'Fatturato';
      } else if (/CATEGORIA/i.test(section)) {
        const group = groupBy(rows,'Categoria');
        labels = Object.keys(group);
        data = labels.map(c => sum(group[c], ['Importo_Totale']));
        label = 'Importo';
        type = 'doughnut';
      } else if (/RIPARTIZIONE/i.test(section)) {
        labels = rows.map(r=>r.Categoria_Prodotto);
        data = rows.map(r=>r.Percentuale || r.Importo);
        label = '%';
        type = 'doughnut';
      } else if (/RIEPILOGHI/i.test(section) || /TOTALE/i.test(section)) {
        const val = sum(rows, ['Valore','Fatturato_Totale']);
        labels = ['Totale'];
        data = [val];
        label = 'Totale';
      }

      chartRefs[id] = new Chart(ctx, {
        type,
        data: { labels, datasets: [{ label, data, backgroundColor:'#3b82f6' }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend:{ labels:{ color:'#e2e8f0' } } },
          scales: type==='doughnut'?{}:{
            x:{ticks:{color:'#94a3b8'},grid:{color:'#1e293b'}},
            y:{ticks:{color:'#94a3b8'},grid:{color:'#1e293b'}}
          }
        }
      });
    }

    el('refresh').addEventListener('click', loadData);
    el('agent').addEventListener('change', e => {
      const code = e.target.value;
      CURRENT_AGENT = code || null;
      const rows = code ? RAW.filter(r=>r.Agente_Codice===code) : RAW;
      drawKPI(rows);
      buildSections(rows);
    });

    loadData();
  </script>
</body>
</html>
