<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Area Agente</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #c2410c;         
      --primary-light: #fff7ed;
      --secondary: #1e293b;       
      --bg-body: #fffaf5;         
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: rgba(194, 65, 12, 0.08);
      --radius: 20px;
      --shadow: 0 10px 30px -10px rgba(194, 65, 12, 0.12);
      --green: #16a34a;
      --red: #dc2626;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-body); 
      color: var(--text-main); 
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* --- ACCESS DENIED --- */
    .access-denied {
      display: none;
      min-height: 100vh;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      padding: 40px;
    }
    .access-denied.visible { display: flex; }
    .access-denied i { font-size: 80px; color: #ef4444; margin-bottom: 24px; }
    .access-denied h1 { font-size: 28px; color: var(--text-main); margin-bottom: 12px; }
    .access-denied p { color: var(--text-muted); font-size: 16px; max-width: 400px; }

    /* --- LOADING --- */
    #loading { 
      position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      transition: opacity 0.5s ease;
    }
    .loader-ring { 
      width: 60px; height: 60px; border: 4px solid rgba(194, 65, 12, 0.1); 
      border-top-color: var(--primary); border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes countUp { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    /* --- MAIN CONTENT --- */
    #mainContent { display: none; }
    #mainContent.visible { display: block; }

    .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

    /* --- HEADER AGENTE --- */
    .agent-header {
      background: linear-gradient(135deg, var(--secondary) 0%, #334155 100%);
      padding: 40px 0;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }
    .agent-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(194, 65, 12, 0.2) 0%, transparent 70%);
      border-radius: 50%;
    }
    .agent-header::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(194, 65, 12, 0.1) 0%, transparent 70%);
      border-radius: 50%;
    }
    .agent-header-inner {
      display: flex;
      align-items: center;
      gap: 24px;
      position: relative;
      z-index: 1;
    }
    .agent-avatar {
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, var(--primary) 0%, #ea580c 100%);
      border-radius: 24px;
      display: grid;
      place-items: center;
      font-size: 36px;
      color: white;
      font-weight: 800;
      box-shadow: 0 15px 40px rgba(194, 65, 12, 0.4);
      position: relative;
    }
    .agent-info h1 {
      color: white;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .agent-info .agent-meta {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .agent-info .agent-meta span {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .agent-info .agent-meta i { color: var(--primary); font-size: 16px; }
    
    .logo-small {
      margin-left: auto;
      height: 45px;
      opacity: 0.9;
    }

    /* Rank Badge in Header */
    .rank-badge-header {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 30px;
      font-weight: 800;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
      margin-left: 20px;
    }
    .rank-badge-header i { font-size: 18px; }
    .rank-badge-header.top3 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
    .rank-badge-header.top10 { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
    .rank-badge-header.other { background: linear-gradient(135deg, #78716c 0%, #57534e 100%); }

    /* --- KPI GRID --- */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    @media (max-width: 1100px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .kpi-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.8);
      animation: fadeInUp 0.5s ease forwards;
      opacity: 0;
    }
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.15s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.25s; }

    /* KPI Cards Enhanced */
    .kpi-card {
      position: relative;
      overflow: hidden;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(194, 65, 12, 0.05) 0%, transparent 70%);
      border-radius: 50%;
    }
    .kpi-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .kpi-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kpi-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      font-size: 20px;
    }
    .kpi-icon.orange { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); color: var(--primary); }
    .kpi-icon.blue { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #2563eb; }
    .kpi-icon.green { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; }
    .kpi-icon.purple { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); color: #9333ea; }

    .kpi-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 12px;
      line-height: 1;
    }
    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .kpi-prev {
      color: var(--text-muted);
    }
    .kpi-trend {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .kpi-trend.up { background: #dcfce7; color: #16a34a; }
    .kpi-trend.down { background: #fee2e2; color: #dc2626; }
    .kpi-trend i { font-size: 14px; }

    /* YoY Comparison Bar */
    .yoy-bar-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f1f5f9;
    }
    .yoy-bar-wrapper {
      position: relative;
      height: 24px;
      background: #f1f5f9;
      border-radius: 12px;
      overflow: visible;
    }
    .yoy-bar-prev {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #94a3b8 0%, #64748b 100%);
      border-radius: 12px;
      transition: width 1s ease;
    }
    .yoy-bar-curr {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, #ea580c 100%);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(194, 65, 12, 0.3);
      transition: width 1s ease 0.3s;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }
    .yoy-bar-curr span {
      color: white;
      font-size: 10px;
      font-weight: 700;
    }
    .yoy-bar-target {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 32px;
      background: #16a34a;
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(22, 163, 74, 0.4);
      transition: left 1s ease 0.5s;
    }
    .yoy-legend {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 11px;
    }
    .yoy-legend span {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }
    .yoy-legend .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .yoy-legend .dot.prev { background: #64748b; }
    .yoy-legend .dot.curr { background: var(--primary); }
    .yoy-legend .dot.target { background: #16a34a; }

    /* Goal Card Special */
    .kpi-card.goal-card {
      background: linear-gradient(135deg, var(--primary-light) 0%, #fff 100%);
      border: 1px solid rgba(194, 65, 12, 0.15);
    }
    .goal-progress {
      margin-top: 16px;
    }
    .goal-bar-track {
      height: 12px;
      background: #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .goal-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, #f97316 100%);
      border-radius: 6px;
      transition: width 1s ease;
      position: relative;
    }
    .goal-bar-fill.complete {
      background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
    }
    .goal-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .goal-status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .goal-status.on-track { background: #dcfce7; color: #16a34a; }
    .goal-status.behind { background: #fef3c7; color: #d97706; }
    .goal-status.critical { background: #fee2e2; color: #dc2626; }
    .goal-status.achieved { background: #d1fae5; color: #059669; }

    /* Rank Card Special */
    .kpi-card.rank-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
    }
    .rank-card .kpi-label { color: rgba(255,255,255,0.6); }
    .rank-card .kpi-value { color: white; }
    .rank-card .kpi-icon { background: rgba(255,255,255,0.1); color: #fbbf24; }
    .rank-display {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .rank-number {
      font-family: 'JetBrains Mono', monospace;
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .rank-total {
      font-size: 18px;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
    }
    .rank-message {
      margin-top: 12px;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .rank-message i { color: #fbbf24; }

    /* Media Team Comparison Card */
    .kpi-card.media-card {
      background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
      border: 1px solid rgba(37, 99, 235, 0.15);
    }
    .media-comparison {
      margin-top: 16px;
      padding: 12px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    .media-bar-container {
      position: relative;
      height: 32px;
      margin-bottom: 8px;
    }
    .media-bar-bg {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
    }
    .media-bar-you {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 8px;
      background: linear-gradient(90deg, var(--primary) 0%, #ea580c 100%);
      border-radius: 4px;
      transition: width 1s ease;
    }
    .media-marker {
      position: absolute;
      top: 0;
      width: 3px;
      height: 32px;
      background: #2563eb;
      border-radius: 2px;
      transition: left 1s ease;
    }
    .media-marker::after {
      content: 'MEDIA';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      font-weight: 700;
      color: #2563eb;
      white-space: nowrap;
    }
    .media-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }
    .media-diff {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .media-diff.above { background: #dcfce7; color: #16a34a; }
    .media-diff.below { background: #fee2e2; color: #dc2626; }
    .media-diff.equal { background: #f1f5f9; color: #64748b; }

    /* Clienti Nuovi vs Storici */
    .clients-split {
      margin-top: 16px;
    }
    .clients-donut-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .clients-donut-mini {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }
    .clients-legend {
      flex: 1;
    }
    .clients-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .clients-legend-item:last-child { margin-bottom: 0; }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .legend-dot.new { background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); }
    .legend-dot.old { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }
    .legend-label { color: var(--text-muted); }
    .legend-value { font-weight: 700; color: var(--text-main); margin-left: auto; }

    /* --- CHARTS GRID --- */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
    }

    .chart-card { 
      padding: 24px; 
      animation: fadeInUp 0.5s ease forwards;
      animation-delay: 0.3s;
      opacity: 0;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chart-title i {
      color: var(--primary);
      font-size: 20px;
    }

    /* --- TABLE --- */
    .table-card { 
      margin-bottom: 40px; 
      animation: fadeInUp 0.5s ease forwards;
      animation-delay: 0.4s;
      opacity: 0;
    }
    table.dataTable { width: 100% !important; }
    table.dataTable thead th { 
      background: #f8fafc; 
      padding: 14px 16px; 
      font-size: 11px; 
      text-transform: uppercase; 
      color: var(--text-muted); 
      font-weight: 700;
      border-bottom: 2px solid #e2e8f0 !important;
    }
    table.dataTable tbody td { 
      padding: 16px; 
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    table.dataTable tbody tr:hover { background: var(--primary-light) !important; }
    .client-name { font-weight: 600; color: var(--text-main); }
    .money { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); }

    /* --- FOOTER --- */
    .footer {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
    }

    /* --- PRINT --- */
    @media print {
      body { background: white; }
      .agent-header { background: #1e293b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .card { box-shadow: none; border: 1px solid #e2e8f0; animation: none; opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- ACCESS DENIED -->
  <div id="accessDenied" class="access-denied">
    <i class="ri-lock-2-fill"></i>
    <h1>Accesso Negato</h1>
    <p>Il link non è valido o è scaduto. Contatta il tuo responsabile per ottenere il link corretto.</p>
  </div>

  <!-- LOADING -->
  <div id="loading">
    <div class="loader-ring"></div>
    <p style="margin-top:20px; color:var(--primary); font-weight:600; font-size:13px;">Caricamento dati...</p>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent">
    
    <div class="agent-header">
      <div class="container agent-header-inner">
        <div class="agent-avatar" id="agentInitials">--</div>
        <div class="agent-info">
          <h1 id="agentName">Nome Agente</h1>
          <div class="agent-meta">
            <span><i class="ri-map-pin-line"></i> <span id="agentAreas">--</span></span>
            <span><i class="ri-building-line"></i> <span id="agentClientsCount">0</span> clienti attivi</span>
          </div>
        </div>
        <div class="rank-badge-header" id="rankBadgeHeader">
          <i class="ri-trophy-line"></i>
          <span id="rankBadgeText">--</span>
        </div>
        <img src="https://www.cottocusimano.com/Resources/dashboard-agenti/logo-cusimano-nero-area-riservata.png" alt="Cotto Cusimano" class="logo-small" style="filter: brightness(0) invert(1);">
      </div>
    </div>

    <div class="container">

      <!-- KPI ROW 1 -->
      <div class="kpi-grid">
        
        <!-- Fatturato Anno Corrente -->
        <div class="card kpi-card">
          <div class="kpi-head">
            <div class="kpi-label">Fatturato Anno Corrente</div>
            <div class="kpi-icon orange"><i class="ri-money-euro-circle-line"></i></div>
          </div>
          <div class="kpi-value" id="kpiFatturato">€ 0</div>
          <div class="kpi-footer">
            <span class="kpi-prev">Anno prec: <strong id="kpiFatturatoPrev">€ 0</strong></span>
            <span class="kpi-trend" id="kpiTrendFatt"><i class="ri-arrow-up-line"></i> --</span>
          </div>
          <!-- YoY Bar -->
          <div class="yoy-bar-container">
            <div class="yoy-bar-wrapper">
              <div class="yoy-bar-prev" id="yoyBarPrev" style="width: 0%"></div>
              <div class="yoy-bar-curr" id="yoyBarCurr" style="width: 0%"><span id="yoyBarCurrLabel"></span></div>
              <div class="yoy-bar-target" id="yoyBarTarget" style="left: 0%"></div>
            </div>
            <div class="yoy-legend">
              <span><span class="dot prev"></span> Anno Prec.</span>
              <span><span class="dot curr"></span> Anno Corr.</span>
              <span><span class="dot target"></span> Obiettivo</span>
            </div>
          </div>
        </div>
        
        <!-- Confronto con Media Team -->
        <div class="card kpi-card media-card">
          <div class="kpi-head">
            <div class="kpi-label">Confronto con il Team</div>
            <div class="kpi-icon blue"><i class="ri-team-line"></i></div>
          </div>
          <div class="kpi-value" id="kpiMediaTeam">€ 0</div>
          <div class="kpi-footer">
            <span class="kpi-prev">Media team: <strong id="kpiMediaValue">€ 0</strong></span>
          </div>
          <div class="media-comparison">
            <div class="media-bar-container">
              <div class="media-bar-bg"></div>
              <div class="media-bar-you" id="mediaBarYou" style="width: 0%"></div>
              <div class="media-marker" id="mediaMarker" style="left: 50%"></div>
            </div>
            <div class="media-labels">
              <span>€ 0</span>
              <span id="mediaBarMax">€ 0</span>
            </div>
          </div>
          <div class="media-diff" id="mediaDiff">
            <i class="ri-arrow-up-line"></i>
            <span id="mediaDiffText">--</span>
          </div>
        </div>
        
        <!-- Clienti con Nuovi vs Storici -->
        <div class="card kpi-card">
          <div class="kpi-head">
            <div class="kpi-label">Clienti Attivi</div>
            <div class="kpi-icon green"><i class="ri-group-line"></i></div>
          </div>
          <div class="kpi-value" id="kpiClienti">0</div>
          <div class="kpi-footer">
            <span class="kpi-prev">Anno prec: <strong id="kpiClientiPrev">0</strong></span>
            <span class="kpi-trend" id="kpiTrendCli"><i class="ri-arrow-up-line"></i> --</span>
          </div>
          <div class="clients-split">
            <div class="clients-donut-container">
              <div class="clients-donut-mini" id="clientsDonutMini"></div>
              <div class="clients-legend">
                <div class="clients-legend-item">
                  <span class="legend-dot new"></span>
                  <span class="legend-label">Nuovi</span>
                  <span class="legend-value" id="clientsNew">0</span>
                </div>
                <div class="clients-legend-item">
                  <span class="legend-dot old"></span>
                  <span class="legend-label">Storici</span>
                  <span class="legend-value" id="clientsOld">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Classifica -->
        <div class="card kpi-card rank-card">
          <div class="kpi-head">
            <div class="kpi-label">La Tua Posizione</div>
            <div class="kpi-icon"><i class="ri-medal-line"></i></div>
          </div>
          <div class="rank-display">
            <span class="rank-number" id="rankNumber">-</span>
            <span class="rank-total">/ <span id="rankTotal">-</span></span>
          </div>
          <div class="rank-message" id="rankMessage">
            <i class="ri-lightbulb-line"></i>
            <span>Caricamento...</span>
          </div>
        </div>

      </div>

      <!-- KPI ROW 2 - Obiettivo -->
      <div class="kpi-grid" style="grid-template-columns: 1fr; max-width: 400px; margin-bottom: 32px;">
        <div class="card kpi-card goal-card">
          <div class="kpi-head">
            <div class="kpi-label">Obiettivo Annuale</div>
            <div class="kpi-icon green"><i class="ri-focus-3-line"></i></div>
          </div>
          <div class="kpi-value" id="kpiObiettivo">€ 0</div>
          <div class="goal-progress">
            <div class="goal-bar-track">
              <div class="goal-bar-fill" id="goalBarFill" style="width: 0%"></div>
            </div>
            <div class="goal-labels">
              <span>0%</span>
              <span id="goalPct">0%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="goal-status" id="goalStatus">
            <i class="ri-checkbox-circle-line"></i>
            <span id="goalStatusText">--</span>
          </div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="charts-grid">
        <div class="card chart-card">
          <div class="chart-title"><i class="ri-building-2-line"></i> Top 10 Clienti</div>
          <div id="chartClienti"></div>
        </div>
        <div class="card chart-card">
          <div class="chart-title"><i class="ri-map-pin-range-line"></i> Fatturato per Provincia</div>
          <div id="chartProvince"></div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card table-card">
        <div class="chart-title"><i class="ri-file-list-3-line"></i> Dettaglio Clienti</div>
        <table id="tblClienti" class="display" style="width:100%"></table>
      </div>

    </div>

    <div class="footer">
      Cotto Cusimano • Dashboard Agente • Aggiornato: <span id="lastUpdate">--</span>
    </div>

  </div>

  <script>
    // =====================================================
    // CONFIGURAZIONE TOKEN AGENTI
    // =====================================================
    const AGENT_TOKENS = {
      'BILOTTI ANDREA': 'Ba8Hj5Ym'
      // Altri agenti verranno aggiunti
    };

    const TOKEN_TO_AGENT = {};
    Object.entries(AGENT_TOKENS).forEach(([agent, token]) => {
      TOKEN_TO_AGENT[token] = agent;
    });

    // =====================================================
    // UTILITIES
    // =====================================================
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const fmtNum = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 });
    const asNum = v => (typeof v === 'number') ? v : Number((v||"0").toString().replace(/\./g, '').replace(',', '.') || 0);

    const GEO_DATA = {
      'AG':{n:'Agrigento',r:'Sicilia'}, 'AL':{n:'Alessandria',r:'Piemonte'}, 'AN':{n:'Ancona',r:'Marche'}, 'AO':{n:'Aosta',r:'Valle d\'Aosta'}, 
      'AR':{n:'Arezzo',r:'Toscana'}, 'AP':{n:'Ascoli Piceno',r:'Marche'}, 'AT':{n:'Asti',r:'Piemonte'}, 'AV':{n:'Avellino',r:'Campania'}, 
      'BA':{n:'Bari',r:'Puglia'}, 'BT':{n:'Barletta-Andria-Trani',r:'Puglia'}, 'BL':{n:'Belluno',r:'Veneto'}, 'BN':{n:'Benevento',r:'Campania'}, 
      'BG':{n:'Bergamo',r:'Lombardia'}, 'BI':{n:'Biella',r:'Piemonte'}, 'BO':{n:'Bologna',r:'Emilia-Romagna'}, 'BZ':{n:'Bolzano',r:'Trentino-Alto Adige'}, 
      'BS':{n:'Brescia',r:'Lombardia'}, 'BR':{n:'Brindisi',r:'Puglia'}, 'CA':{n:'Cagliari',r:'Sardegna'}, 'CL':{n:'Caltanissetta',r:'Sicilia'}, 
      'CB':{n:'Campobasso',r:'Molise'}, 'CI':{n:'Carbonia-Iglesias',r:'Sardegna'}, 'CE':{n:'Caserta',r:'Campania'}, 'CT':{n:'Catania',r:'Sicilia'}, 
      'CZ':{n:'Catanzaro',r:'Calabria'}, 'CH':{n:'Chieti',r:'Abruzzo'}, 'CO':{n:'Como',r:'Lombardia'}, 'CS':{n:'Cosenza',r:'Calabria'}, 
      'CR':{n:'Cremona',r:'Lombardia'}, 'KR':{n:'Crotone',r:'Calabria'}, 'CN':{n:'Cuneo',r:'Piemonte'}, 'EN':{n:'Enna',r:'Sicilia'}, 
      'FM':{n:'Fermo',r:'Marche'}, 'FE':{n:'Ferrara',r:'Emilia-Romagna'}, 'FI':{n:'Firenze',r:'Toscana'}, 'FG':{n:'Foggia',r:'Puglia'}, 
      'FC':{n:'Forlì-Cesena',r:'Emilia-Romagna'}, 'FR':{n:'Frosinone',r:'Lazio'}, 'GE':{n:'Genova',r:'Liguria'}, 'GO':{n:'Gorizia',r:'Friuli-Venezia Giulia'}, 
      'GR':{n:'Grosseto',r:'Toscana'}, 'IM':{n:'Imperia',r:'Liguria'}, 'IS':{n:'Isernia',r:'Molise'}, 'SP':{n:'La Spezia',r:'Liguria'}, 
      'AQ':{n:'L\'Aquila',r:'Abruzzo'}, 'LT':{n:'Latina',r:'Lazio'}, 'LE':{n:'Lecce',r:'Puglia'}, 'LC':{n:'Lecco',r:'Lombardia'}, 
      'LI':{n:'Livorno',r:'Toscana'}, 'LO':{n:'Lodi',r:'Lombardia'}, 'LU':{n:'Lucca',r:'Toscana'}, 'MC':{n:'Macerata',r:'Marche'}, 
      'MN':{n:'Mantova',r:'Lombardia'}, 'MS':{n:'Massa-Carrara',r:'Toscana'}, 'MT':{n:'Matera',r:'Basilicata'}, 'VS':{n:'Medio Campidano',r:'Sardegna'}, 
      'ME':{n:'Messina',r:'Sicilia'}, 'MI':{n:'Milano',r:'Lombardia'}, 'MO':{n:'Modena',r:'Emilia-Romagna'}, 'MB':{n:'Monza e Brianza',r:'Lombardia'}, 
      'NA':{n:'Napoli',r:'Campania'}, 'NO':{n:'Novara',r:'Piemonte'}, 'NU':{n:'Nuoro',r:'Sardegna'}, 'OG':{n:'Ogliastra',r:'Sardegna'}, 
      'OT':{n:'Olbia-Tempio',r:'Sardegna'}, 'OR':{n:'Oristano',r:'Sardegna'}, 'PD':{n:'Padova',r:'Veneto'}, 'PA':{n:'Palermo',r:'Sicilia'}, 
      'PR':{n:'Parma',r:'Emilia-Romagna'}, 'PV':{n:'Pavia',r:'Lombardia'}, 'PG':{n:'Perugia',r:'Umbria'}, 'PU':{n:'Pesaro e Urbino',r:'Marche'}, 
      'PE':{n:'Pescara',r:'Abruzzo'}, 'PC':{n:'Piacenza',r:'Emilia-Romagna'}, 'PI':{n:'Pisa',r:'Toscana'}, 'PT':{n:'Pistoia',r:'Toscana'}, 
      'PN':{n:'Pordenone',r:'Friuli-Venezia Giulia'}, 'PZ':{n:'Potenza',r:'Basilicata'}, 'PO':{n:'Prato',r:'Toscana'}, 'RG':{n:'Ragusa',r:'Sicilia'}, 
      'RA':{n:'Ravenna',r:'Emilia-Romagna'}, 'RC':{n:'Reggio Calabria',r:'Calabria'}, 'RE':{n:'Reggio Emilia',r:'Emilia-Romagna'}, 'RI':{n:'Rieti',r:'Lazio'}, 
      'RN':{n:'Rimini',r:'Emilia-Romagna'}, 'RM':{n:'Roma',r:'Lazio'}, 'RO':{n:'Rovigo',r:'Veneto'}, 'SA':{n:'Salerno',r:'Campania'}, 
      'SS':{n:'Sassari',r:'Sardegna'}, 'SV':{n:'Savona',r:'Liguria'}, 'SI':{n:'Siena',r:'Toscana'}, 'SR':{n:'Siracusa',r:'Sicilia'}, 
      'SO':{n:'Sondrio',r:'Lombardia'}, 'TA':{n:'Taranto',r:'Puglia'}, 'TE':{n:'Teramo',r:'Abruzzo'}, 'TR':{n:'Terni',r:'Umbria'}, 
      'TO':{n:'Torino',r:'Piemonte'}, 'TP':{n:'Trapani',r:'Sicilia'}, 'TN':{n:'Trento',r:'Trentino-Alto Adige'}, 'TV':{n:'Treviso',r:'Veneto'}, 
      'TS':{n:'Trieste',r:'Friuli-Venezia Giulia'}, 'UD':{n:'Udine',r:'Friuli-Venezia Giulia'}, 'VA':{n:'Varese',r:'Lombardia'}, 'VE':{n:'Venezia',r:'Veneto'}, 
      'VB':{n:'Verbano-Cusio-Ossola',r:'Piemonte'}, 'VC':{n:'Vercelli',r:'Piemonte'}, 'VR':{n:'Verona',r:'Veneto'}, 'VV':{n:'Vibo Valentia',r:'Calabria'}, 
      'VI':{n:'Vicenza',r:'Veneto'}, 'VT':{n:'Viterbo',r:'Lazio'}
    };

    // =====================================================
    // STATE
    // =====================================================
    let currentAgent = null;
    let agentData = { vendite: [], obiettivi: [] };
    let allAgentsRanking = [];

    // =====================================================
    // INIT
    // =====================================================
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      
      if (!token || !TOKEN_TO_AGENT[token]) {
        showAccessDenied();
        return;
      }
      
      currentAgent = TOKEN_TO_AGENT[token];
      
      try {
        const res = await fetch('/data', { cache: "no-store" });
        if (!res.ok) throw new Error("Errore caricamento dati");
        const data = await res.json();
        
        // Normalizza dati
        const allRows = (data.rows || []).map(r => {
          if (r.Provincia) {
            const code = r.Provincia.trim().toUpperCase();
            if (code === 'GENERALE') {
              r.Provincia = 'Generale'; r.Regione = 'Generale';
            } else {
              const geo = GEO_DATA[code];
              if (geo) { r.Provincia = geo.n; r.Regione = geo.r; }
              else { r.Regione = 'Altro'; }
            }
          } else { r.Regione = 'N/D'; }
          return r;
        });
        
        // Filtra per agente corrente
        agentData.vendite = allRows.filter(r => 
          r.Tipo_Dato === 'VENDITE_CLIENTE' && 
          (r.Agente_Nome || '').trim().toUpperCase() === currentAgent.toUpperCase()
        );
        
        agentData.obiettivi = allRows.filter(r => 
          r.Tipo_Dato === 'OBIETTIVI' && 
          (r.Agente_Nome || '').trim().toUpperCase() === currentAgent.toUpperCase()
        );

        // Calcola ranking tutti gli agenti
        buildAgentsRanking(allRows);
        
        if (data.updatedAt) {
          document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString('it-IT');
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').classList.add('visible');
        
        populateHeader();
        populateKPIs();
        populateRanking();
        initCharts();
        populateTable();
        
      } catch (err) {
        console.error(err);
        document.getElementById('loading').innerHTML = `<p style="color:#dc2626">Errore: ${err.message}</p>`;
      }
    });

    function showAccessDenied() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('accessDenied').classList.add('visible');
    }

    // =====================================================
    // BUILD RANKING
    // =====================================================
    function buildAgentsRanking(allRows) {
      const agentFatturato = {};
      
      allRows.filter(r => r.Tipo_Dato === 'OBIETTIVI').forEach(r => {
        const ag = (r.Agente_Nome || '').trim().toUpperCase();
        if (ag && ag !== 'GENERALE') {
          agentFatturato[ag] = (agentFatturato[ag] || 0) + asNum(r.Anno_Corrente);
        }
      });
      
      // Se non ci sono obiettivi, usa vendite
      if (Object.keys(agentFatturato).length === 0) {
        allRows.filter(r => r.Tipo_Dato === 'VENDITE_CLIENTE').forEach(r => {
          const ag = (r.Agente_Nome || '').trim().toUpperCase();
          if (ag) {
            agentFatturato[ag] = (agentFatturato[ag] || 0) + asNum(r.Fatturato);
          }
        });
      }
      
      allAgentsRanking = Object.entries(agentFatturato)
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);
    }

    // =====================================================
    // POPULATE FUNCTIONS
    // =====================================================
    function populateHeader() {
      const initials = currentAgent.split(' ').map(w => w[0]).join('').substring(0, 2);
      document.getElementById('agentInitials').textContent = initials;
      document.getElementById('agentName').textContent = currentAgent;
      
      const regioni = [...new Set(agentData.vendite.map(r => r.Regione).filter(r => r && r !== 'N/D' && r !== 'Generale'))];
      document.getElementById('agentAreas').textContent = regioni.length > 0 ? regioni.join(', ') : 'N/D';
      
      const clientsCount = new Set(agentData.vendite.map(r => r.Ragione_Sociale_Cliente)).size;
      document.getElementById('agentClientsCount').textContent = clientsCount;
      
      document.title = `${currentAgent} • Cotto Cusimano`;
    }

    function populateKPIs() {
      let fattCorr = 0, fattPrev = 0, obiettivo = 0, cliCorr = 0, cliPrev = 0;
      
      agentData.obiettivi.forEach(r => {
        fattCorr += asNum(r.Anno_Corrente);
        fattPrev += asNum(r.Anno_Precedente);
        obiettivo += asNum(r.Obiettivo);
        cliCorr += asNum(r.Clienti_Anno_Corrente);
        cliPrev += asNum(r.Clienti_Anno_Precedente);
      });
      
      if (fattCorr === 0 && agentData.vendite.length > 0) {
        fattCorr = agentData.vendite.reduce((s, r) => s + asNum(r.Fatturato), 0);
        cliCorr = new Set(agentData.vendite.map(r => r.Ragione_Sociale_Cliente)).size;
      }
      
      // Fatturato
      document.getElementById('kpiFatturato').textContent = fmtEUR.format(fattCorr);
      document.getElementById('kpiFatturatoPrev').textContent = fmtEUR.format(fattPrev);
      
      const trendFattEl = document.getElementById('kpiTrendFatt');
      if (fattPrev > 0) {
        const delta = ((fattCorr - fattPrev) / fattPrev) * 100;
        trendFattEl.innerHTML = `<i class="ri-arrow-${delta >= 0 ? 'up' : 'down'}-line"></i> ${delta >= 0 ? '+' : ''}${delta.toFixed(1)}%`;
        trendFattEl.className = 'kpi-trend ' + (delta >= 0 ? 'up' : 'down');
      } else {
        trendFattEl.style.display = 'none';
      }
      
      // YoY Bar
      updateYoYBar(fattCorr, fattPrev, obiettivo);
      
      // ========== CONFRONTO CON MEDIA TEAM ==========
      populateMediaComparison(fattCorr);
      
      // ========== CLIENTI NUOVI VS STORICI ==========
      populateClientsComparison(cliCorr, cliPrev);
      
      // Clienti totali
      document.getElementById('kpiClienti').textContent = cliCorr;
      document.getElementById('kpiClientiPrev').textContent = cliPrev;
      
      const trendCliEl = document.getElementById('kpiTrendCli');
      if (cliPrev > 0) {
        const delta = ((cliCorr - cliPrev) / cliPrev) * 100;
        trendCliEl.innerHTML = `<i class="ri-arrow-${delta >= 0 ? 'up' : 'down'}-line"></i> ${delta >= 0 ? '+' : ''}${delta.toFixed(1)}%`;
        trendCliEl.className = 'kpi-trend ' + (delta >= 0 ? 'up' : 'down');
      } else {
        trendCliEl.style.display = 'none';
      }
      
      // Obiettivo
      document.getElementById('kpiObiettivo').textContent = fmtEUR.format(obiettivo);
      const goalPct = obiettivo > 0 ? (fattCorr / obiettivo) * 100 : 0;
      document.getElementById('goalPct').textContent = goalPct.toFixed(1) + '%';
      
      const goalBarFill = document.getElementById('goalBarFill');
      goalBarFill.style.width = Math.min(goalPct, 100) + '%';
      if (goalPct >= 100) goalBarFill.classList.add('complete');
      
      // Goal Status
      const goalStatusEl = document.getElementById('goalStatus');
      const goalStatusText = document.getElementById('goalStatusText');
      if (goalPct >= 100) {
        goalStatusEl.className = 'goal-status achieved';
        goalStatusText.textContent = 'Obiettivo raggiunto!';
        goalStatusEl.querySelector('i').className = 'ri-trophy-fill';
      } else if (goalPct >= 80) {
        goalStatusEl.className = 'goal-status on-track';
        goalStatusText.textContent = 'In linea con l\'obiettivo';
        goalStatusEl.querySelector('i').className = 'ri-checkbox-circle-line';
      } else if (goalPct >= 50) {
        goalStatusEl.className = 'goal-status behind';
        goalStatusText.textContent = 'Leggermente in ritardo';
        goalStatusEl.querySelector('i').className = 'ri-time-line';
      } else {
        goalStatusEl.className = 'goal-status critical';
        goalStatusText.textContent = 'Attenzione: sotto obiettivo';
        goalStatusEl.querySelector('i').className = 'ri-alert-line';
      }
    }

    // =====================================================
    // CONFRONTO CON MEDIA TEAM
    // =====================================================
    function populateMediaComparison(myFatturato) {
      // Calcola media team (escluso l'agente corrente)
      const otherAgents = allAgentsRanking.filter(a => a.name !== currentAgent.toUpperCase());
      const totalOthers = otherAgents.reduce((s, a) => s + a.value, 0);
      const avgTeam = otherAgents.length > 0 ? totalOthers / otherAgents.length : 0;
      
      // Il tuo fatturato nella card
      document.getElementById('kpiMediaTeam').textContent = fmtEUR.format(myFatturato);
      document.getElementById('kpiMediaValue').textContent = fmtEUR.format(avgTeam);
      
      // Barra confronto
      const maxVal = Math.max(myFatturato, avgTeam) * 1.3;
      const myPct = maxVal > 0 ? (myFatturato / maxVal) * 100 : 0;
      const avgPct = maxVal > 0 ? (avgTeam / maxVal) * 100 : 50;
      
      document.getElementById('mediaBarMax').textContent = fmtEUR.format(maxVal);
      
      setTimeout(() => {
        document.getElementById('mediaBarYou').style.width = myPct + '%';
        document.getElementById('mediaMarker').style.left = avgPct + '%';
      }, 300);
      
      // Differenza
      const diff = myFatturato - avgTeam;
      const diffPct = avgTeam > 0 ? (diff / avgTeam) * 100 : 0;
      const mediaDiffEl = document.getElementById('mediaDiff');
      const mediaDiffText = document.getElementById('mediaDiffText');
      
      if (diff > 0) {
        mediaDiffEl.className = 'media-diff above';
        mediaDiffEl.querySelector('i').className = 'ri-arrow-up-line';
        mediaDiffText.textContent = `+${diffPct.toFixed(0)}% sopra la media`;
      } else if (diff < 0) {
        mediaDiffEl.className = 'media-diff below';
        mediaDiffEl.querySelector('i').className = 'ri-arrow-down-line';
        mediaDiffText.textContent = `${diffPct.toFixed(0)}% sotto la media`;
      } else {
        mediaDiffEl.className = 'media-diff equal';
        mediaDiffEl.querySelector('i').className = 'ri-equal-line';
        mediaDiffText.textContent = `In linea con la media`;
      }
    }

    // =====================================================
    // CLIENTI NUOVI VS STORICI
    // =====================================================
    function populateClientsComparison(cliCorr, cliPrev) {
      // Calcola clienti nuovi: quelli che non c'erano l'anno scorso
      // Per semplicità: nuovi = clienti correnti - clienti precedenti (se positivo)
      // Storici = clienti che c'erano già
      
      let clientiNuovi = Math.max(0, cliCorr - cliPrev);
      let clientiStorici = cliCorr - clientiNuovi;
      
      // Se non abbiamo dati anno precedente, assumiamo 20% nuovi
      if (cliPrev === 0 && cliCorr > 0) {
        clientiNuovi = Math.round(cliCorr * 0.2);
        clientiStorici = cliCorr - clientiNuovi;
      }
      
      document.getElementById('clientsNew').textContent = clientiNuovi;
      document.getElementById('clientsOld').textContent = clientiStorici;
      
      // Mini donut chart
      if (cliCorr > 0) {
        new ApexCharts(document.querySelector("#clientsDonutMini"), {
          series: [clientiNuovi, clientiStorici],
          chart: { 
            type: 'donut', 
            height: 80, 
            width: 80,
            sparkline: { enabled: true }
          },
          colors: ['#16a34a', '#94a3b8'],
          plotOptions: { 
            pie: { 
              donut: { size: '60%' },
              expandOnClick: false
            } 
          },
          stroke: { width: 0 },
          tooltip: { enabled: false },
          legend: { show: false },
          dataLabels: { enabled: false }
        }).render();
      }
    }

    function updateYoYBar(curr, prev, target) {
      const maxVal = Math.max(curr, prev, target) * 1.15;
      if (maxVal === 0) return;
      
      const prevPct = (prev / maxVal) * 100;
      const currPct = (curr / maxVal) * 100;
      const targetPct = (target / maxVal) * 100;
      
      setTimeout(() => {
        document.getElementById('yoyBarPrev').style.width = prevPct + '%';
      }, 100);
      
      setTimeout(() => {
        const currBar = document.getElementById('yoyBarCurr');
        currBar.style.width = currPct + '%';
        document.getElementById('yoyBarCurrLabel').textContent = fmtEUR.format(curr).replace('€', '').trim();
      }, 300);
      
      setTimeout(() => {
        document.getElementById('yoyBarTarget').style.left = `calc(${targetPct}% - 2px)`;
      }, 500);
    }

    function populateRanking() {
      const myRank = allAgentsRanking.findIndex(a => a.name === currentAgent.toUpperCase()) + 1;
      const totalAgents = allAgentsRanking.length;
      
      document.getElementById('rankNumber').textContent = myRank > 0 ? myRank : '-';
      document.getElementById('rankTotal').textContent = totalAgents;
      
      // Badge in header
      const badge = document.getElementById('rankBadgeHeader');
      const badgeText = document.getElementById('rankBadgeText');
      
      if (myRank > 0 && myRank <= 3) {
        badge.className = 'rank-badge-header top3';
        badge.querySelector('i').className = 'ri-trophy-fill';
        badgeText.textContent = myRank === 1 ? '1° Posto!' : `${myRank}° Posto`;
      } else if (myRank <= 10) {
        badge.className = 'rank-badge-header top10';
        badge.querySelector('i').className = 'ri-medal-line';
        badgeText.textContent = `${myRank}° su ${totalAgents}`;
      } else {
        badge.className = 'rank-badge-header other';
        badge.querySelector('i').className = 'ri-bar-chart-line';
        badgeText.textContent = `${myRank}° su ${totalAgents}`;
      }
      
      // Message
      const msgEl = document.getElementById('rankMessage');
      let message = '';
      if (myRank === 1) {
        message = 'Sei il top performer! Continua così!';
      } else if (myRank <= 3) {
        message = 'Sul podio! Ottimo lavoro!';
      } else if (myRank <= 10) {
        const diff = allAgentsRanking[myRank - 2]?.value - allAgentsRanking[myRank - 1]?.value;
        if (diff) message = `Ti mancano ${fmtEUR.format(diff)} per salire`;
        else message = 'Sei nella Top 10!';
      } else {
        const diff = allAgentsRanking[myRank - 2]?.value - allAgentsRanking[myRank - 1]?.value;
        if (diff) message = `Ti mancano ${fmtEUR.format(diff)} per salire`;
        else message = 'Continua a lavorare per scalare la classifica';
      }
      msgEl.querySelector('span').textContent = message;
    }

    function initCharts() {
      const font = "'Plus Jakarta Sans', sans-serif";
      
      // Top 10 Clienti
      const clientiMap = {};
      agentData.vendite.forEach(r => {
        const k = r.Ragione_Sociale_Cliente || 'N/D';
        clientiMap[k] = (clientiMap[k] || 0) + asNum(r.Fatturato);
      });
      const clientiSorted = Object.entries(clientiMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
      
      new ApexCharts(document.querySelector("#chartClienti"), {
        series: [{ name: 'Fatturato', data: clientiSorted.map(x => x[1]) }],
        chart: { type: 'bar', height: 320, fontFamily: font, toolbar: { show: false } },
        plotOptions: { bar: { horizontal: true, borderRadius: 6, barHeight: '60%' } },
        colors: ['#c2410c'],
        fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.25, inverseColors: true, opacityFrom: 0.85, opacityTo: 0.85, stops: [50, 0, 100] } },
        dataLabels: { enabled: false },
        xaxis: { 
          categories: clientiSorted.map(x => x[0].length > 22 ? x[0].substring(0, 22) + '...' : x[0]),
          labels: { formatter: v => '€' + (v/1000).toFixed(0) + 'k' }
        },
        tooltip: { theme: 'dark', y: { formatter: v => fmtEUR.format(v) } }
      }).render();
      
      // Province
      const provMap = {};
      agentData.vendite.forEach(r => {
        const p = r.Provincia || 'N/D';
        if (p !== 'Generale') provMap[p] = (provMap[p] || 0) + asNum(r.Fatturato);
      });
      const provSorted = Object.entries(provMap).sort((a, b) => b[1] - a[1]);
      
      new ApexCharts(document.querySelector("#chartProvince"), {
        series: provSorted.map(x => x[1]),
        labels: provSorted.map(x => x[0]),
        chart: { type: 'donut', height: 320, fontFamily: font },
        colors: ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#fdba74', '#fed7aa'],
        plotOptions: { 
          pie: { 
            donut: { 
              size: '68%',
              labels: {
                show: true,
                name: { fontSize: '12px' },
                value: { fontSize: '18px', fontWeight: 700 },
                total: {
                  show: true,
                  label: 'Totale',
                  fontSize: '11px',
                  color: '#64748b',
                  formatter: w => fmtEUR.format(w.globals.seriesTotals.reduce((a, b) => a + b, 0))
                }
              }
            } 
          } 
        },
        legend: { position: 'bottom', markers: { radius: 12 } },
        dataLabels: { enabled: false },
        tooltip: { theme: 'dark', y: { formatter: v => fmtEUR.format(v) } }
      }).render();
    }

    function populateTable() {
      const rows = agentData.vendite.map(r => [
        `<span class="client-name">${r.Ragione_Sociale_Cliente || '—'}</span>`,
        r.Provincia || '—',
        r.Regione || '—',
        `<span class="money">${fmtEUR.format(asNum(r.Fatturato))}</span>`
      ]);
      
      new DataTable('#tblClienti', {
        data: rows,
        columns: [
          { title: 'Cliente' },
          { title: 'Provincia' },
          { title: 'Regione' },
          { title: 'Fatturato', className: 'dt-right' }
        ],
        order: [[3, 'desc']],
        pageLength: 15,
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Cerca cliente...",
          paginate: { next: ">", previous: "<" },
          info: "_START_ - _END_ di _TOTAL_"
        }
      });
    }
  </script>
</body>
</html>
