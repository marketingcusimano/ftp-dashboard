<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotto Cusimano • Area Agente</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.6/js/dataTables.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary: #c2410c;         
      --primary-light: #fff7ed;
      --secondary: #1e293b;       
      --bg-body: #fffaf5;         
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: rgba(194, 65, 12, 0.08);
      --radius: 20px;
      --shadow: 0 10px 30px -10px rgba(194, 65, 12, 0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-body); 
      color: var(--text-main); 
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* --- ACCESS DENIED --- */
    .access-denied {
      display: none;
      min-height: 100vh;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      padding: 40px;
    }
    .access-denied.visible { display: flex; }
    .access-denied i { font-size: 80px; color: #ef4444; margin-bottom: 24px; }
    .access-denied h1 { font-size: 28px; color: var(--text-main); margin-bottom: 12px; }
    .access-denied p { color: var(--text-muted); font-size: 16px; max-width: 400px; }

    /* --- LOADING --- */
    #loading { 
      position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      transition: opacity 0.5s ease;
    }
    .loader-ring { 
      width: 60px; height: 60px; border: 4px solid rgba(194, 65, 12, 0.1); 
      border-top-color: var(--primary); border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- MAIN CONTENT --- */
    #mainContent { display: none; }
    #mainContent.visible { display: block; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

    /* --- HEADER AGENTE --- */
    .agent-header {
      background: linear-gradient(135deg, var(--secondary) 0%, #334155 100%);
      padding: 40px 0;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }
    .agent-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(194, 65, 12, 0.15) 0%, transparent 70%);
      border-radius: 50%;
    }
    .agent-header-inner {
      display: flex;
      align-items: center;
      gap: 24px;
      position: relative;
      z-index: 1;
    }
    .agent-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary) 0%, #ea580c 100%);
      border-radius: 20px;
      display: grid;
      place-items: center;
      font-size: 32px;
      color: white;
      font-weight: 800;
      box-shadow: 0 10px 30px rgba(194, 65, 12, 0.3);
    }
    .agent-info h1 {
      color: white;
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .agent-info p {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .agent-info p i { color: var(--primary); }
    
    .logo-small {
      margin-left: auto;
      height: 40px;
      opacity: 0.9;
    }

    /* --- KPI GRID --- */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.8);
    }

    .kpi-card {
      display: flex;
      flex-direction: column;
    }
    .kpi-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .kpi-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }
    .kpi-compare {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .kpi-compare .trend {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }
    .trend-up { background: #dcfce7; color: #16a34a; }
    .trend-down { background: #fee2e2; color: #dc2626; }

    /* Obiettivo Card Special */
    .kpi-card.goal-card {
      background: linear-gradient(135deg, var(--primary-light) 0%, #fff 100%);
      border: 1px solid rgba(194, 65, 12, 0.1);
    }
    .goal-progress {
      margin-top: 16px;
    }
    .goal-bar-track {
      height: 10px;
      background: #e2e8f0;
      border-radius: 5px;
      overflow: hidden;
    }
    .goal-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, #f97316 100%);
      border-radius: 5px;
      transition: width 1s ease;
    }
    .goal-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* --- CHARTS GRID --- */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
    }

    .chart-card { padding: 24px; }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chart-title i {
      color: var(--primary);
      font-size: 20px;
    }

    /* --- TABLE --- */
    .table-card { margin-bottom: 40px; }
    table.dataTable { width: 100% !important; }
    table.dataTable thead th { 
      background: #f8fafc; 
      padding: 14px 16px; 
      font-size: 11px; 
      text-transform: uppercase; 
      color: var(--text-muted); 
      font-weight: 700;
      border-bottom: 2px solid #e2e8f0 !important;
    }
    table.dataTable tbody td { 
      padding: 16px; 
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    table.dataTable tbody tr:hover { background: var(--primary-light) !important; }
    .client-name { font-weight: 600; color: var(--text-main); }
    .money { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); }

    /* --- FOOTER --- */
    .footer {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
    }

    /* --- PRINT --- */
    @media print {
      body { background: white; }
      .agent-header { background: #1e293b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .card { box-shadow: none; border: 1px solid #e2e8f0; }
    }
  </style>
</head>
<body>

  <!-- ACCESS DENIED -->
  <div id="accessDenied" class="access-denied">
    <i class="ri-lock-2-fill"></i>
    <h1>Accesso Negato</h1>
    <p>Il link non è valido o è scaduto. Contatta il tuo responsabile per ottenere il link corretto.</p>
  </div>

  <!-- LOADING -->
  <div id="loading">
    <div class="loader-ring"></div>
    <p style="margin-top:20px; color:var(--primary); font-weight:600; font-size:13px;">Caricamento dati...</p>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent">
    
    <div class="agent-header">
      <div class="container agent-header-inner">
        <div class="agent-avatar" id="agentInitials">--</div>
        <div class="agent-info">
          <h1 id="agentName">Nome Agente</h1>
          <p><i class="ri-map-pin-line"></i> <span id="agentAreas">--</span></p>
        </div>
        <img src="https://www.cottocusimano.com/Resources/dashboard-agenti/logo-cusimano-nero-area-riservata.png" alt="Cotto Cusimano" class="logo-small" style="filter: brightness(0) invert(1);">
      </div>
    </div>

    <div class="container">

      <!-- KPI -->
      <div class="kpi-grid">
        <div class="card kpi-card">
          <div class="kpi-label">Fatturato Anno Corrente</div>
          <div class="kpi-value" id="kpiFatturato">€ 0</div>
          <div class="kpi-compare">
            Anno prec: <span id="kpiFatturatoPrev">€ 0</span>
            <span class="trend" id="kpiTrendFatt">--</span>
          </div>
        </div>
        
        <div class="card kpi-card">
          <div class="kpi-label">Clienti Attivi</div>
          <div class="kpi-value" id="kpiClienti">0</div>
          <div class="kpi-compare">
            Anno prec: <span id="kpiClientiPrev">0</span>
            <span class="trend" id="kpiTrendCli">--</span>
          </div>
        </div>
        
        <div class="card kpi-card goal-card">
          <div class="kpi-label">Obiettivo Annuale</div>
          <div class="kpi-value" id="kpiObiettivo">€ 0</div>
          <div class="goal-progress">
            <div class="goal-bar-track">
              <div class="goal-bar-fill" id="goalBarFill" style="width: 0%"></div>
            </div>
            <div class="goal-labels">
              <span>0%</span>
              <span id="goalPct">0%</span>
              <span>100%</span>
            </div>
          </div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Scontrino Medio</div>
          <div class="kpi-value" id="kpiScontrino">€ 0</div>
          <div class="kpi-compare">
            <span style="color: var(--text-muted)">Per cliente attivo</span>
          </div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="charts-grid">
        <div class="card chart-card">
          <div class="chart-title"><i class="ri-building-2-line"></i> Top 10 Clienti</div>
          <div id="chartClienti"></div>
        </div>
        <div class="card chart-card">
          <div class="chart-title"><i class="ri-map-pin-range-line"></i> Fatturato per Provincia</div>
          <div id="chartProvince"></div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card table-card">
        <div class="chart-title"><i class="ri-file-list-3-line"></i> Dettaglio Clienti</div>
        <table id="tblClienti" class="display" style="width:100%"></table>
      </div>

    </div>

    <div class="footer">
      Cotto Cusimano • Dashboard Agente • Aggiornato: <span id="lastUpdate">--</span>
    </div>

  </div>

  <script>
    // =====================================================
    // CONFIGURAZIONE TOKEN AGENTI
    // Ogni agente ha un token univoco per accedere ai suoi dati
    // =====================================================
    const AGENT_TOKENS = {
      'MARIANI MASSIMILIANO': 'Mz7Xk9Pq',
      'BILOTTI CARLO': 'Bc4Rn2Wt',
      'BILOTTI ANDREA': 'Ba8Hj5Ym',
      'CAPOTOSTI CARLO': 'Cc3Vf7Ls',
      'GATTO CINZIA': 'Gc6Qp1Nd',
      'SPL SERVICE SNC': 'Ss9Uw4Kx',
      'TORINO SALVATORE': 'Ts2Ei8Jb',
      'CASERTANO FILIPPO': 'Cf5Ao3Gh',
      'BARBARO TITO': 'Bt1Yl6Zr',
      'COLALILLO CLAUDIO': 'Cl7Dm9Fv',
      'DI VITO ANTONIO': 'Da4Sn2Xc',
      'MASTROTOTARO GIUSEPPE': 'Mg8Pk5Wq',
      'FESTA ANTONIO': 'Fa3Rj7Ht',
      'RUSCIANO ANIELLO': 'Ra6Ub1Ym',
      'ZACCARO VITO': 'Zv9Lc4Ns',
      'GULLO GIUSEPPE': 'Gg2Tf8Kp',
      'LAZZARO CARMINE': 'Lc5Wh3Qd',
      'SICILIANO FRANCESCO': 'Sf1Xm7Jv',
      'DI LAURO GIOVANNI': 'Dg4Yn9Rb',
      'MESSINA LETTERIO': 'Ml8Ek2Zt',
      'CALABRESE ROBERTO': 'Cr6Ui5Aw',
      'FERRARO MICHELE': 'Fm3Oj1Hx',
      'GRECO SALVATORE': 'Gs7Pn4Lc',
      'RUSSO ANTONIO': 'Ra9Qk6Vf',
      'ESPOSITO MARIO': 'Em2Wt8Yb',
      'ROMANO LUIGI': 'Rl5Zh3Nd',
      'COLOMBO MARCO': 'Cm1Xj7Gs',
      'RICCI PAOLO': 'Rp4Uc9Kq',
      'MARINO FRANCESCO': 'Mf8Vl2Tw',
      'BRUNO GIUSEPPE': 'Bg6Yi5Ra'
    };

    // Genera token inverso per lookup rapido
    const TOKEN_TO_AGENT = {};
    Object.entries(AGENT_TOKENS).forEach(([agent, token]) => {
      TOKEN_TO_AGENT[token] = agent;
    });

    // =====================================================
    // UTILITIES
    // =====================================================
    const fmtEUR = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const fmtNum = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 });
    const asNum = v => (typeof v === 'number') ? v : Number((v||"0").toString().replace(/\./g, '').replace(',', '.') || 0);

    const GEO_DATA = {
      'AG':{n:'Agrigento',r:'Sicilia'}, 'AL':{n:'Alessandria',r:'Piemonte'}, 'AN':{n:'Ancona',r:'Marche'}, 'AO':{n:'Aosta',r:'Valle d\'Aosta'}, 
      'AR':{n:'Arezzo',r:'Toscana'}, 'AP':{n:'Ascoli Piceno',r:'Marche'}, 'AT':{n:'Asti',r:'Piemonte'}, 'AV':{n:'Avellino',r:'Campania'}, 
      'BA':{n:'Bari',r:'Puglia'}, 'BT':{n:'Barletta-Andria-Trani',r:'Puglia'}, 'BL':{n:'Belluno',r:'Veneto'}, 'BN':{n:'Benevento',r:'Campania'}, 
      'BG':{n:'Bergamo',r:'Lombardia'}, 'BI':{n:'Biella',r:'Piemonte'}, 'BO':{n:'Bologna',r:'Emilia-Romagna'}, 'BZ':{n:'Bolzano',r:'Trentino-Alto Adige'}, 
      'BS':{n:'Brescia',r:'Lombardia'}, 'BR':{n:'Brindisi',r:'Puglia'}, 'CA':{n:'Cagliari',r:'Sardegna'}, 'CL':{n:'Caltanissetta',r:'Sicilia'}, 
      'CB':{n:'Campobasso',r:'Molise'}, 'CI':{n:'Carbonia-Iglesias',r:'Sardegna'}, 'CE':{n:'Caserta',r:'Campania'}, 'CT':{n:'Catania',r:'Sicilia'}, 
      'CZ':{n:'Catanzaro',r:'Calabria'}, 'CH':{n:'Chieti',r:'Abruzzo'}, 'CO':{n:'Como',r:'Lombardia'}, 'CS':{n:'Cosenza',r:'Calabria'}, 
      'CR':{n:'Cremona',r:'Lombardia'}, 'KR':{n:'Crotone',r:'Calabria'}, 'CN':{n:'Cuneo',r:'Piemonte'}, 'EN':{n:'Enna',r:'Sicilia'}, 
      'FM':{n:'Fermo',r:'Marche'}, 'FE':{n:'Ferrara',r:'Emilia-Romagna'}, 'FI':{n:'Firenze',r:'Toscana'}, 'FG':{n:'Foggia',r:'Puglia'}, 
      'FC':{n:'Forlì-Cesena',r:'Emilia-Romagna'}, 'FR':{n:'Frosinone',r:'Lazio'}, 'GE':{n:'Genova',r:'Liguria'}, 'GO':{n:'Gorizia',r:'Friuli-Venezia Giulia'}, 
      'GR':{n:'Grosseto',r:'Toscana'}, 'IM':{n:'Imperia',r:'Liguria'}, 'IS':{n:'Isernia',r:'Molise'}, 'SP':{n:'La Spezia',r:'Liguria'}, 
      'AQ':{n:'L\'Aquila',r:'Abruzzo'}, 'LT':{n:'Latina',r:'Lazio'}, 'LE':{n:'Lecce',r:'Puglia'}, 'LC':{n:'Lecco',r:'Lombardia'}, 
      'LI':{n:'Livorno',r:'Toscana'}, 'LO':{n:'Lodi',r:'Lombardia'}, 'LU':{n:'Lucca',r:'Toscana'}, 'MC':{n:'Macerata',r:'Marche'}, 
      'MN':{n:'Mantova',r:'Lombardia'}, 'MS':{n:'Massa-Carrara',r:'Toscana'}, 'MT':{n:'Matera',r:'Basilicata'}, 'VS':{n:'Medio Campidano',r:'Sardegna'}, 
      'ME':{n:'Messina',r:'Sicilia'}, 'MI':{n:'Milano',r:'Lombardia'}, 'MO':{n:'Modena',r:'Emilia-Romagna'}, 'MB':{n:'Monza e Brianza',r:'Lombardia'}, 
      'NA':{n:'Napoli',r:'Campania'}, 'NO':{n:'Novara',r:'Piemonte'}, 'NU':{n:'Nuoro',r:'Sardegna'}, 'OG':{n:'Ogliastra',r:'Sardegna'}, 
      'OT':{n:'Olbia-Tempio',r:'Sardegna'}, 'OR':{n:'Oristano',r:'Sardegna'}, 'PD':{n:'Padova',r:'Veneto'}, 'PA':{n:'Palermo',r:'Sicilia'}, 
      'PR':{n:'Parma',r:'Emilia-Romagna'}, 'PV':{n:'Pavia',r:'Lombardia'}, 'PG':{n:'Perugia',r:'Umbria'}, 'PU':{n:'Pesaro e Urbino',r:'Marche'}, 
      'PE':{n:'Pescara',r:'Abruzzo'}, 'PC':{n:'Piacenza',r:'Emilia-Romagna'}, 'PI':{n:'Pisa',r:'Toscana'}, 'PT':{n:'Pistoia',r:'Toscana'}, 
      'PN':{n:'Pordenone',r:'Friuli-Venezia Giulia'}, 'PZ':{n:'Potenza',r:'Basilicata'}, 'PO':{n:'Prato',r:'Toscana'}, 'RG':{n:'Ragusa',r:'Sicilia'}, 
      'RA':{n:'Ravenna',r:'Emilia-Romagna'}, 'RC':{n:'Reggio Calabria',r:'Calabria'}, 'RE':{n:'Reggio Emilia',r:'Emilia-Romagna'}, 'RI':{n:'Rieti',r:'Lazio'}, 
      'RN':{n:'Rimini',r:'Emilia-Romagna'}, 'RM':{n:'Roma',r:'Lazio'}, 'RO':{n:'Rovigo',r:'Veneto'}, 'SA':{n:'Salerno',r:'Campania'}, 
      'SS':{n:'Sassari',r:'Sardegna'}, 'SV':{n:'Savona',r:'Liguria'}, 'SI':{n:'Siena',r:'Toscana'}, 'SR':{n:'Siracusa',r:'Sicilia'}, 
      'SO':{n:'Sondrio',r:'Lombardia'}, 'TA':{n:'Taranto',r:'Puglia'}, 'TE':{n:'Teramo',r:'Abruzzo'}, 'TR':{n:'Terni',r:'Umbria'}, 
      'TO':{n:'Torino',r:'Piemonte'}, 'TP':{n:'Trapani',r:'Sicilia'}, 'TN':{n:'Trento',r:'Trentino-Alto Adige'}, 'TV':{n:'Treviso',r:'Veneto'}, 
      'TS':{n:'Trieste',r:'Friuli-Venezia Giulia'}, 'UD':{n:'Udine',r:'Friuli-Venezia Giulia'}, 'VA':{n:'Varese',r:'Lombardia'}, 'VE':{n:'Venezia',r:'Veneto'}, 
      'VB':{n:'Verbano-Cusio-Ossola',r:'Piemonte'}, 'VC':{n:'Vercelli',r:'Piemonte'}, 'VR':{n:'Verona',r:'Veneto'}, 'VV':{n:'Vibo Valentia',r:'Calabria'}, 
      'VI':{n:'Vicenza',r:'Veneto'}, 'VT':{n:'Viterbo',r:'Lazio'}
    };

    // =====================================================
    // INIT
    // =====================================================
    let currentAgent = null;
    let agentData = { vendite: [], obiettivi: [] };

    document.addEventListener("DOMContentLoaded", async () => {
      // Verifica parametri URL
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      
      // Verifica token
      if (!token || !TOKEN_TO_AGENT[token]) {
        showAccessDenied();
        return;
      }
      
      currentAgent = TOKEN_TO_AGENT[token];
      
      try {
        const res = await fetch('/data', { cache: "no-store" });
        if (!res.ok) throw new Error("Errore caricamento dati");
        const data = await res.json();
        
        // Normalizza e filtra dati per l'agente
        const allRows = (data.rows || []).map(r => {
          if (r.Provincia) {
            const code = r.Provincia.trim().toUpperCase();
            if (code === 'GENERALE') {
              r.Provincia = 'Generale'; r.Regione = 'Generale';
            } else {
              const geo = GEO_DATA[code];
              if (geo) { r.Provincia = geo.n; r.Regione = geo.r; }
              else { r.Regione = 'Altro'; }
            }
          } else { r.Regione = 'N/D'; }
          return r;
        });
        
        // Filtra per agente corrente
        agentData.vendite = allRows.filter(r => 
          r.Tipo_Dato === 'VENDITE_CLIENTE' && 
          (r.Agente_Nome || '').trim().toUpperCase() === currentAgent.toUpperCase()
        );
        
        agentData.obiettivi = allRows.filter(r => 
          r.Tipo_Dato === 'OBIETTIVI' && 
          (r.Agente_Nome || '').trim().toUpperCase() === currentAgent.toUpperCase()
        );
        
        if (data.updatedAt) {
          document.getElementById('lastUpdate').textContent = new Date(data.updatedAt).toLocaleString('it-IT');
        }
        
        // Nascondi loading e mostra contenuto
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').classList.add('visible');
        
        // Popola dashboard
        populateHeader();
        populateKPIs();
        initCharts();
        populateTable();
        
      } catch (err) {
        console.error(err);
        document.getElementById('loading').innerHTML = `<p style="color:#dc2626">Errore: ${err.message}</p>`;
      }
    });

    function showAccessDenied() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('accessDenied').classList.add('visible');
    }

    // =====================================================
    // POPULATE FUNCTIONS
    // =====================================================
    function populateHeader() {
      const initials = currentAgent.split(' ').map(w => w[0]).join('').substring(0, 2);
      document.getElementById('agentInitials').textContent = initials;
      document.getElementById('agentName').textContent = currentAgent;
      
      // Aree coperte
      const regioni = [...new Set(agentData.vendite.map(r => r.Regione).filter(r => r && r !== 'N/D' && r !== 'Generale'))];
      document.getElementById('agentAreas').textContent = regioni.length > 0 ? regioni.join(', ') : 'N/D';
      
      // Titolo pagina
      document.title = `${currentAgent} • Cotto Cusimano`;
    }

    function populateKPIs() {
      // Calcola da obiettivi (dati aggregati)
      let fattCorr = 0, fattPrev = 0, obiettivo = 0, cliCorr = 0, cliPrev = 0;
      
      agentData.obiettivi.forEach(r => {
        fattCorr += asNum(r.Anno_Corrente);
        fattPrev += asNum(r.Anno_Precedente);
        obiettivo += asNum(r.Obiettivo);
        cliCorr += asNum(r.Clienti_Anno_Corrente);
        cliPrev += asNum(r.Clienti_Anno_Precedente);
      });
      
      // Se non ci sono obiettivi, usa vendite
      if (fattCorr === 0 && agentData.vendite.length > 0) {
        fattCorr = agentData.vendite.reduce((s, r) => s + asNum(r.Fatturato), 0);
        cliCorr = new Set(agentData.vendite.map(r => r.Ragione_Sociale_Cliente)).size;
      }
      
      // Fatturato
      document.getElementById('kpiFatturato').textContent = fmtEUR.format(fattCorr);
      document.getElementById('kpiFatturatoPrev').textContent = fmtEUR.format(fattPrev);
      
      const trendFattEl = document.getElementById('kpiTrendFatt');
      if (fattPrev > 0) {
        const delta = ((fattCorr - fattPrev) / fattPrev) * 100;
        trendFattEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '%';
        trendFattEl.className = 'trend ' + (delta >= 0 ? 'trend-up' : 'trend-down');
      } else {
        trendFattEl.style.display = 'none';
      }
      
      // Clienti
      document.getElementById('kpiClienti').textContent = cliCorr;
      document.getElementById('kpiClientiPrev').textContent = cliPrev;
      
      const trendCliEl = document.getElementById('kpiTrendCli');
      if (cliPrev > 0) {
        const delta = ((cliCorr - cliPrev) / cliPrev) * 100;
        trendCliEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '%';
        trendCliEl.className = 'trend ' + (delta >= 0 ? 'trend-up' : 'trend-down');
      } else {
        trendCliEl.style.display = 'none';
      }
      
      // Obiettivo
      document.getElementById('kpiObiettivo').textContent = fmtEUR.format(obiettivo);
      const goalPct = obiettivo > 0 ? (fattCorr / obiettivo) * 100 : 0;
      document.getElementById('goalPct').textContent = goalPct.toFixed(1) + '%';
      document.getElementById('goalBarFill').style.width = Math.min(goalPct, 100) + '%';
      
      // Scontrino medio
      const scontrino = cliCorr > 0 ? fattCorr / cliCorr : 0;
      document.getElementById('kpiScontrino').textContent = fmtEUR.format(scontrino);
    }

    function initCharts() {
      const font = "'Plus Jakarta Sans', sans-serif";
      
      // Top 10 Clienti
      const clientiMap = {};
      agentData.vendite.forEach(r => {
        const k = r.Ragione_Sociale_Cliente || 'N/D';
        clientiMap[k] = (clientiMap[k] || 0) + asNum(r.Fatturato);
      });
      const clientiSorted = Object.entries(clientiMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
      
      new ApexCharts(document.querySelector("#chartClienti"), {
        series: [{ name: 'Fatturato', data: clientiSorted.map(x => x[1]) }],
        chart: { type: 'bar', height: 300, fontFamily: font, toolbar: { show: false } },
        plotOptions: { bar: { horizontal: true, borderRadius: 4, barHeight: '60%' } },
        colors: ['#c2410c'],
        dataLabels: { enabled: false },
        xaxis: { 
          categories: clientiSorted.map(x => x[0].length > 25 ? x[0].substring(0, 25) + '...' : x[0]),
          labels: { formatter: v => '€' + (v/1000).toFixed(0) + 'k' }
        },
        tooltip: { y: { formatter: v => fmtEUR.format(v) } }
      }).render();
      
      // Province
      const provMap = {};
      agentData.vendite.forEach(r => {
        const p = r.Provincia || 'N/D';
        if (p !== 'Generale') provMap[p] = (provMap[p] || 0) + asNum(r.Fatturato);
      });
      const provSorted = Object.entries(provMap).sort((a, b) => b[1] - a[1]);
      
      new ApexCharts(document.querySelector("#chartProvince"), {
        series: provSorted.map(x => x[1]),
        labels: provSorted.map(x => x[0]),
        chart: { type: 'donut', height: 300, fontFamily: font },
        colors: ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#fdba74', '#fed7aa'],
        plotOptions: { 
          pie: { 
            donut: { 
              size: '65%',
              labels: {
                show: true,
                total: {
                  show: true,
                  label: 'Totale',
                  formatter: w => fmtEUR.format(w.globals.seriesTotals.reduce((a, b) => a + b, 0))
                }
              }
            } 
          } 
        },
        legend: { position: 'bottom' },
        tooltip: { y: { formatter: v => fmtEUR.format(v) } }
      }).render();
    }

    function populateTable() {
      const rows = agentData.vendite.map(r => [
        `<span class="client-name">${r.Ragione_Sociale_Cliente || '—'}</span>`,
        r.Provincia || '—',
        r.Regione || '—',
        `<span class="money">${fmtEUR.format(asNum(r.Fatturato))}</span>`
      ]);
      
      new DataTable('#tblClienti', {
        data: rows,
        columns: [
          { title: 'Cliente' },
          { title: 'Provincia' },
          { title: 'Regione' },
          { title: 'Fatturato', className: 'dt-right' }
        ],
        order: [[3, 'desc']],
        pageLength: 15,
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Cerca cliente...",
          paginate: { next: ">", previous: "<" },
          info: "_START_ - _END_ di _TOTAL_"
        }
      });
    }
  </script>
</body>
</html>
